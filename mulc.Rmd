---
title: "Ingresos y Egresos por Turismo en el Mercado de Cambios"
description: "Resumen de las transacciones en divisas a través del Mercado de Cambios en rubros de servicios vinculados al turismo, con información mensual proveniente del Banco Central de la República Argentina (BCRA)"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, 
                      fig.align = 'left', fig.width = 10,fig.height = 6)

library(tidyverse)
library(lubridate)
library(openxlsx)
library(ggtext)
library(extrafont)
library(janitor)
library(googlesheets4)
library(plotly)
library(herramientas)


# Opciones globales
options(scipen = 999, # sin notación científica
        OutDec= ",")# coma para los decimales

knitr::knit_hooks$set(inline = function(x) {   
  if(!is.numeric(x)){x}
  else{prettyNum(x, big.mark=".")}}) # Para que los separadores de miles sean punto.

Sys.setlocale(locale = "es_AR.UTF-8")

mes <- as.character(lubridate::month(floor_date(Sys.Date(),"month")- months(2), label = TRUE, abbr = FALSE))
anio_actual <- year(floor_date(Sys.Date(),"year"))
anio_datos <- year(floor_date(Sys.Date(),"year")) # CAMBIAR!!!

# PALETAS Y FUENTES ---------------------------------------------------------
# Paleta colores Presidencia
cols_arg <- "#37BBED" # Celeste Institucional

#Secundarios
cols_arg2 <- c("#EE3D8F", # "ROJO"
               "#50B8B1", # "VERDE"
               "#F7941E","#FFD100","#D7DF23", "#9283BE")

#Fuente
#familia_fuente <- fonttable() %>% 
#  as_tibble() %>% 
#  filter(str_detect(FamilyName, "Encode Sans"),  
#         Bold == TRUE) %>% 
#  pull(FamilyName) %>% 
#  first()

familia_fuente <- "Encode Sans"

```

```{r}
ss_cobros_mensual <- read_file_srv("/srv/DataDNMYE/mulc/MULC.xlsx",
                              sheet = "Servicios Cobros USD - mensual",
                              range = cell_limits(c(7,1), c(NA,23)),
                              na = "s/d") %>%
                     clean_names() %>%
                     select(-fecha)
  
 
ss_pagos_mensual <- read_file_srv("/srv/DataDNMYE/mulc/MULC.xlsx",
                             sheet = "Servicios Pagos USD - mensual",
                             range = cell_limits(c(7,1), c(NA,23)),
                             na = "s/d") %>% 
                    clean_names() %>% 
                    select(-fecha) %>% 
                    mutate(
                    entidades_y_otros_por_cancelacion_de_tarjetas = -1 * entidades_y_otros_por_cancelacion_de_tarjetas,
                    operadores_turisticos_y_otras_transferencias = -1 * operadores_turisticos_y_otras_transferencias,
                    no_residentes_billetes = -1 * no_residentes_billetes)

ss_cobros_mensual$mes <- as.factor(ss_cobros_mensual$mes)
ss_pagos_mensual$mes <- as.factor(ss_pagos_mensual$mes)

ss_cobros_mensual <- rename(ss_cobros_mensual, c("anio" = "ano"))
ss_pagos_mensual <- rename(ss_pagos_mensual, c("anio" = "ano"))

#### COBROS Y PAGOS POR TRIMESTRE ##################

# Cobros
ss_cobros_mensual <- ss_cobros_mensual %>% 
                    mutate(trim = case_when(mes %in% c("ene", "feb", "mar") ~ "I",
                                            mes %in% c("abr", "may", "jun") ~ "II",
                                            mes %in% c("jul", "ago", "sep") ~ "III",
                                            mes %in% c("oct", "nov", "dic") ~ "IV")) %>% 
                             pivot_longer(3:length(ss_cobros_mensual), 
                                               names_to = "rubro",
                                               values_to = "cobros")

ss_cobros_trim <- ss_cobros_mensual %>% group_by(anio, trim, rubro) %>%
                                    summarise(cobros = sum(cobros))

# Pagos
ss_pagos_mensual <- ss_pagos_mensual %>% 
                   mutate(trim = case_when(mes %in% c("ene", "feb", "mar") ~ "I",
                                           mes %in% c("abr", "may", "jun") ~ "II",
                                           mes %in% c("jul", "ago", "sep") ~ "III",
                                           mes %in% c("oct", "nov", "dic") ~ "IV")) %>% 
                           pivot_longer(3:length(ss_pagos_mensual), 
                                        names_to = "rubro",
                                        values_to = "pagos")

ss_pagos_trim <- ss_pagos_mensual %>% group_by(anio, trim, rubro) %>%
                                  summarise(pagos = sum(pagos))


#### COBROS Y PAGOS POR ANIO ##################

#Cobros
ss_cobros_anual <- ss_cobros_trim %>% group_by(anio, rubro) %>% summarise(cobros = sum(cobros))

#Pagos
ss_pagos_anual <- ss_pagos_trim %>% group_by(anio, rubro) %>% summarise(pagos = sum(pagos))



### Genero tablas por período ####

# Mensual
ss_mensual <- full_join(ss_cobros_mensual, ss_pagos_mensual, 
                        by = c("anio", "mes", "trim", "rubro")) %>%
                mutate(balanza = cobros-pagos,
                       mes = case_when(
                       tolower(mes) == "ene" ~ 1,
                       tolower(mes) == "feb" ~ 2,
                       tolower(mes) == "mar" ~ 3,
                       tolower(mes) == "abr" ~ 4,
                       tolower(mes) == "may" ~ 5,
                       tolower(mes) == "jun" ~ 6,
                       tolower(mes) == "jul" ~ 7,
                       tolower(mes) == "ago" ~ 8,
                       tolower(mes) == "sep" ~ 9,
                       tolower(mes) == "oct" ~ 10,
                       tolower(mes) == "nov" ~ 11,
                       tolower(mes) == "dic" ~ 12),
                     fecha = make_date(anio, mes)) %>% 
                select(fecha, rubro, cobros, pagos, balanza)

#Trimestral
ss_trim <- full_join(ss_cobros_trim, ss_pagos_trim, 
                        by = c("anio", "trim", "rubro")) %>% 
              mutate(balanza = cobros-pagos,
                     fecha = paste0(anio," ", trim, " Trim")) %>% 
              pivot_longer(4:6, names_to = "variable") %>% 
              select(fecha, rubro, variable, value)


# Anual
ss_anual <- full_join(ss_cobros_anual, ss_pagos_anual, 
                     by = c("anio", "rubro")) %>%
              mutate(balanza = cobros-pagos) %>% 
              pivot_longer(3:5, names_to = "variable")
              
rm(ss_cobros_anual, ss_cobros_mensual, ss_cobros_trim, 
   ss_pagos_anual, ss_pagos_mensual, ss_pagos_trim)


############# TRIMESTRAL VS CUENTA VIAJES ######################################
BP <- read.csv("/srv/DataDNMYE/imet/serie_gasto_internacional.csv") %>% 
  mutate(anio = as.numeric(substr(trim, 1, 4)), trimestre = as.numeric(substr(trim, 5,5)),
         tur_receptivo_mill= receptivo_vyp_visitantes/1000000,
         tur_emisivo_mill= emisivo_vyp_visitantes/1000000,
         balance_mill=(receptivo_vyp_visitantes-emisivo_vyp_visitantes)/1000000)    
  #filter(row_number() !=n()) #para cuando no queremos que salga la ultima fila (porque es otro trimestre)

BP <- BP %>% mutate(fecha = case_when(trimestre == "1" ~
                                    paste0(anio," I Trim"),
                                    trimestre == "2" ~
                                    paste0(anio," II Trim"),
                                    trimestre == "3" ~
                                    paste0(anio," III Trim"),
                                    trimestre == "4" ~
                                    paste0(anio," IV Trim"))) %>%
            summarise(year=anio,fecha=fecha, tur_receptivo_mill, tur_emisivo_mill )






# BP <- BP %>% mutate(year=substr(trim,1,4),fecha = case_when(substr(trim, 5,6) == "1T" ~ 
#                                     paste0(substr(trim, 1, 4)," I Trim"),
#                                     substr(trim, 5,6) == "2T" ~ 
#                                     paste0(substr(trim, 1, 4)," II Trim"),
#                                    substr(trim, 5,6) == "3T" ~ 
#                                     paste0(substr(trim, 1, 4)," III Trim"),
#                                    substr(trim, 5,6) == "4T" ~ 
#                                     paste0(substr(trim, 1, 4)," IV Trim"))) %>% 
#             summarise(year=year,fecha=fecha, tur_emisivo_mill=tur_emisivo_mill/1000000, tur_receptivo_mill=tur_receptivo_mill/1000000)

# selecciono las columnas que uso y las paso a millones de dólares
```

### (Publicado en `r format(Sys.time(), '%B %Y')` con datos actualizados a `r paste(mes," ",anio_datos)`)


```{r}
tabla1 <- ss_mensual %>% filter(year(fecha) >= 2017, 
                            rubro %in% c("viajes_y_otros_pagos_con_tarjeta", 
                            "servicios_de_transporte_de_pasajeros"), 
                            !is.na(cobros)) %>% 
                         group_by(fecha) %>% 
                         summarise(cobros = sum(cobros),
                                   pagos = sum(pagos))

#TABLA PARA BALANZA
tabla1_bis <- ss_mensual %>% filter(year(fecha) >= 2017, 
                            rubro %in% c("viajes_y_otros_pagos_con_tarjeta", 
                            "servicios_de_transporte_de_pasajeros"), 
                            !is.na(cobros)) %>%
                            group_by(fecha) %>% 
                            summarise(balanza =sum(balanza)) %>% 
                         mutate(color_bza=case_when(balanza >= 0 ~ "superávit",
                                                   TRUE ~ "déficit"))
  
```

+ En el mes de `r mes`, los egresos de divisas por turismo, por el mercado oficial de cambios, alcanzaron un total de US\$`r tail(tabla1$pagos, n=1) %>% round(1)` millones, con una variación respecto al mismo mes del año `r as.character(anio_datos-1)` del `r ((tail(tabla1$pagos, n=1)/tabla1$pagos[length(tabla1$pagos)-12]-1)*100) %>% round(1)`%. Por su parte, los ingresos fueron de US\$`r tail(tabla1$cobros, n=1) %>% round(1)` millones, con una variación interanual del `r ((tail(tabla1$cobros,n=1)/tabla1$cobros[length(tabla1$cobros)-12]-1)*100) %>% round(1)`%.

+ Continuando con la tendencia de los últimos años, la balanza de divisas en el mercado oficial, por turismo, es deficitaria. En el mes de `r mes` de `r as.character(anio_datos)`, se registró una balanza deficitaria en US\$`r ((-1)*tail(tabla1_bis$balanza, n=1)) %>% round(1)` millones, mientras que en el mismo mes de `r as.character(anio_datos-1)` había sido también deficitaria en US\$`r ((-1)*(tabla1_bis$balanza[length(tabla1_bis$balanza)-12])) %>% round(1)` millones.

```{r}
ing_acum <- filter(tabla1, year(fecha) == anio_datos) %>% select(cobros) %>% sum()

ing_acum_ia <- filter(tabla1, year(fecha) == anio_datos-1 & month(fecha) <= month(last(tabla1$fecha))) %>% select(cobros) %>% sum()

#El valor de esta variable corresponde a  prepandemia (2019)
ing_acum_ia_2 <- filter(tabla1, year(fecha) == anio_datos-4 & month(fecha) <= month(last(tabla1$fecha))) %>% select(cobros) %>% sum()

var_ing_acum_ia <- (ing_acum/ing_acum_ia-1)*100

#La var es contra 2019
var_ing_acum_ia_2 <- (ing_acum/ing_acum_ia_2-1)*100

eg_acum <- filter(tabla1, year(fecha) == anio_datos) %>% select(pagos) %>% sum()

eg_acum_ia <- filter(tabla1, year(fecha) == anio_datos-1 & month(fecha) <= month(last(tabla1$fecha))) %>% select(pagos) %>% sum()

#El valor de esta variable corresponde a  prepandemia (2019)
eg_acum_ia_2 <- filter(tabla1, year(fecha) == anio_datos-4 & month(fecha) <= month(last(tabla1$fecha))) %>% select(pagos) %>% sum()

var_eg_acum_ia <- (eg_acum/eg_acum_ia-1)*100

#La var es contra 2019
var_eg_acum_ia_2 <- (eg_acum/eg_acum_ia_2-1)*100

bza_acum <- ing_acum-eg_acum

```

```{r}
# SACO EL ACUMULADO EN ENEROOOOO


```
 + En el acumulado enero - `r mes` de `r as.character(anio_datos)`, los egresos de divisas por turismo, por el mercado oficial de cambios, fueron de US\$`r eg_acum %>% round(1)` millones (`r var_eg_acum_ia %>% round(1)`% vs mismo período de `r as.character(anio_datos-1)`). Por su parte, los ingresos de divisas fueron de US\$`r ing_acum %>% round(1)` millones (`r var_ing_acum_ia %>% round(1)`% vs mismo período de `r as.character(anio_datos-1)`). Esto significó una balanza deficitaria en US\$`r ((-1)*bza_acum) %>% round(1)` millones.



<br>

### Evolución de las transacciones de Turismo en el Mercado de Cambios
#### En millones de dólares.
```{r}

# <span style='color:#37BBED'>Ingresos</span>, <span style='color:#9283BE'>egresos </span> y balanza (<span style='color:#EE3D8F'>déficit</span>, <span style='color:#50B8B1'>superávit</span>).
g1 <- tabla1 %>% 
  pivot_longer(cols = c("cobros","pagos"),names_to = "transaccion",values_to = "valor") %>% #paso a formato long para poder tener bien las leyendas
  ggplot()+
  geom_hline(yintercept = 0, color = "grey", alpha =0.7, size = 0.5) +
  geom_line(aes(fecha, valor, colour = transaccion),
            size = 1) +
  geom_point(aes(fecha, valor,colour = transaccion,
                 text = paste0('fecha: ', format(fecha,"%b-%y"),
                                             '<br> transacción: ',transaccion,
                                             '<br> valor: USD ',format(round(valor,1),big.mark=".",decimal.mark=",")," M")),
             size = 1.5) +
  scale_color_manual(values = c("cobros" = cols_arg,
                                "pagos" = cols_arg2[6]))+
 geom_col(data=tabla1_bis, aes(fecha, balanza, fill = color_bza,text = paste0('fecha: ', format(fecha,"%b-%y"),
                                             '<br> balanza: USD ',format(round(balanza,1),big.mark=".",decimal.mark=",")," M"))) +
  scale_fill_manual(values = c("déficit" = cols_arg2[1],
                               "superávit" = cols_arg2[2]))+
  scale_x_date(breaks = seq.Date(as.Date(min(tabla1$fecha))+months(month(max(tabla1$fecha))-7),as.Date(max(tabla1$fecha)),by="3 months"),
               date_labels = "%b%y", 
               expand = c(0,0))+
  guides(fill = F)+
  labs(title="",x="",y="",
       caption="DNMyE en base a BCRA")+
  theme_minimal() +
  theme(
    text = element_text(family = familia_fuente), 
    plot.title    = element_markdown(size = 14),
    plot.subtitle = element_markdown(size = 12),
    plot.caption  = element_markdown(size = 10),
    strip.text.y  = element_text(size = 10, face = "bold"),
    axis.text.x   = element_text(size = 10,angle=90),
    axis.text.y   = element_text(size = 10),
    panel.grid.minor.x = element_blank(),
    legend.position = "rigth",
    legend.title = element_blank(),
    strip.placement = "outside")

g1 <- ggplotly(g1,tooltip="text")


for (i in 1:length(g1$x$data)){
    if (!is.null(g1$x$data[[i]]$name)){
        g1$x$data[[i]]$name =  gsub("\\(","",str_split(g1$x$data[[i]]$name,",")[[1]][1])
    }
}
g1$x$data[[6]]$name <- "balanza"
#g1$x$data[[7]]$name <- "balanza (superávit)"

g1 %>% layout(legend = list(orientation = "v",x=0.8),
              hovermode = "x")
```


```{r}
tabla2 <- ss_mensual %>% filter(year(fecha) >= 2017, 
                                rubro == "viajes_y_otros_pagos_con_tarjeta" | 
                                rubro == "servicios_de_transporte_de_pasajeros"|
                                rubro == "total", 
                                !is.na(cobros)) %>%
                         pivot_longer(3:5, names_to = "transac") %>% 
                         pivot_wider(c(fecha,transac),names_from = rubro, values_from = value) %>% 
                         mutate(Turismo = viajes_y_otros_pagos_con_tarjeta +
                                          servicios_de_transporte_de_pasajeros,
                                p_turismo = Turismo/total*100) %>% 
                         select(fecha, transac, Turismo, total, p_turismo) %>% 
                         filter(transac != "balanza")
```

+ En el mes de `r mes` de `r as.character(anio_datos)` los egresos por turismo representaron un `r tail(tabla2$p_turismo [tabla2$transac == "pagos"],n=1) %>% round(1)`% de la salida total de divisas por servicios vía el mercado oficial de cambios. Por su lado, los ingresos por turismo representaron un `r tail(tabla2$p_turismo [tabla2$transac == "cobros"],n=1) %>% round(1)`% del total de ingresos por servicios.

```{r}
ing_acum_total <- filter(tabla2, year(fecha) == anio_datos, transac == "cobros") %>% select(total) %>% sum()

eg_acum_total <- filter(tabla2, year(fecha) == anio_datos, transac == "pagos") %>% select(total) %>% sum()



```

```{r}
#SACO ACUM EN ENERO
# 
```

+ Por su lado, en el acumulado del año, los egresos por turismo representaron un `r ((eg_acum/eg_acum_total)*100) %>% round(1)`% y los ingresos por turismo un `r ((ing_acum/ing_acum_total)*100) %>% round(1)`%.


### Contribución del turismo en el mercado oficial de divisas 
#### Proporción de <span style='color:#9283BE'>Ingresos</span> y <span style='color:#37BBED'>egresos </span> por Turismo sobre el total en %.
```{r}
g2 <- tabla2 %>% 
  mutate(transac = case_when(transac == "cobros" ~"ingresos",
                             transac == "pagos" ~"egresos"))%>% 
  ggplot(aes(x = fecha, y= p_turismo, fill=transac,text = paste0('fecha: ', format(fecha,"%b-%y"),
                                                                 '<br>transacción: ',transac,
                                             '<br>participación:  ',format(round(p_turismo,1),big.mark=".",decimal.mark=","),"%")))+
  geom_bar(stat="identity", position = "dodge")+
  scale_fill_manual(values = c(cols_arg,cols_arg2[6]), labels= c("Ingresos", "Egresos")) +
  scale_x_date(
    breaks = seq.Date(as.Date(min(tabla2$fecha))+months(month(max(tabla2$fecha))-7),as.Date(max(tabla2$fecha)),by="3 months"),
               date_labels = "%b%y", 
               expand = c(0,0))+
  labs(title="",
       subtitle = "En %",x="",y="",
       caption="DNMyE en base a BCRA")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente), 
    plot.title    = element_markdown(size = 14),
    plot.subtitle = element_markdown(size = 12),
    plot.caption  = element_markdown(size = 10),
    strip.text.y  = element_text(size = 10, face = "bold"),
    axis.text.x   = element_text(size = 10,angle=90),
    axis.text.y   = element_text(size = 10),
    panel.grid.minor.x = element_blank(),
    legend.title = element_blank(),
    strip.placement = "outside",
    legend.position="rigth")

 ggplotly(g2,tooltip = "text") %>% layout(legend = list(
       orientation = "v",x=0.8
     )) 
```

```{r}
tabla5 <- ss_mensual %>% filter(!is.na(cobros)) %>% 
                         select(!c(balanza,pagos)) %>% 
                         filter(fecha==max(fecha),
                                !rubro %in% c("total", 
                                           "entidades_y_otros_por_cancelacion_de_tarjetas",
                                           "operadores_turisticos_y_otras_transferencias",
                                           "no_residentes_billetes"))

turismo <- tabla5 %>% summarise(turismo = sum(cobros[rubro %in% c("servicios_de_transporte_de_pasajeros",
                                                "viajes_y_otros_pagos_con_tarjeta")]))

tabla5 <- tabla5 %>% add_row(cobros = turismo$turismo,
                             rubro = "turismo",
                             fecha = max(tabla5$fecha)) %>% 
                     filter(!rubro %in% c("servicios_de_transporte_de_pasajeros",
                                      "viajes_y_otros_pagos_con_tarjeta")) %>% 
                     arrange(desc(cobros))

otros_agrup <- tabla5 %>% summarise(otros_agrup = sum(cobros[tabla5$cobros<1 | tabla5$rubro == "otros"]))                       

tabla5 <- tabla5 %>% add_row(cobros = otros_agrup$otros_agrup,
                             rubro = "otros_agrup",
                             fecha = max(tabla5$fecha)) %>% 
                     filter(cobros>1 & rubro != "otros")

tabla5$rubro <- tabla5$rubro %>%  as.factor() %>% recode_factor(
  servicios_empresariales_profesionales_y_tecnicos="Empresariales, profesionales y técnicos",
  servicios_de_informacion_e_informatica="Información e informática", 
  #servicios_personales_culturales_y_recreativos="Personales, culturales y recreativos", 
  #otros_servicios_de_transporte="Otros ss de transporte",
  fletes="Fletes",
  servicios_de_comunicaciones="Comunicaciones",
  #servicios_de_gobierno="Gobierno", 
  servicios_relacionados_con_el_comercio="Relacionados con comercio",
  turismo="Turismo",
  cargos_por_el_uso_de_la_propiedad_intelectual="Propiedad Intelectual", 
  servicios_de_seguros_y_siniestros="Seguros y siniestros",
  #servicios_arrendamiento_operativo="Arrendamiento operativo",
  otros_agrup="Otros")

tabla5 <- mutate(tabla5, orden=1:length(tabla5$rubro),
                         es_turismo = ifelse(rubro == "Turismo", "si", "no"))


tabla6 <- ss_mensual %>% filter(!is.na(pagos)) %>% 
                         select(!c(balanza,cobros)) %>% 
                         filter(fecha==max(fecha),
                                !rubro %in% c("total", 
                                              "entidades_y_otros_por_cancelacion_de_tarjetas",
                                              "operadores_turisticos_y_otras_transferencias",
                                              "no_residentes_billetes"))

turismo <- tabla6 %>% summarise(turismo = sum(pagos[rubro %in% c("servicios_de_transporte_de_pasajeros","viajes_y_otros_pagos_con_tarjeta")]))

tabla6 <- tabla6 %>% add_row(pagos = turismo$turismo,
                             rubro = "turismo",
                             fecha = max(tabla5$fecha)) %>% 
                     filter(!rubro %in% c("servicios_de_transporte_de_pasajeros",
                                        "viajes_y_otros_pagos_con_tarjeta")) %>% 
                     arrange(desc(pagos))

otros_agrup <- tabla6 %>% summarise(otros_agrup = sum(pagos[tabla6$pagos<1 | tabla6$rubro == "otros"]))                       

tabla6 <- tabla6 %>% add_row(pagos = otros_agrup$otros_agrup,
                             rubro = "otros_agrup",
                             fecha = max(tabla5$fecha)) %>% 
                     filter(pagos>1 & rubro != "otros")

tabla6$rubro <- tabla6$rubro %>%  as.factor() %>% recode_factor(
  servicios_empresariales_profesionales_y_tecnicos="Empresariales, profesionales y técnicos",
  servicios_de_informacion_e_informatica="Información e informática", 
  #servicios_personales_culturales_y_recreativos="Personales, culturales y recreativos", 
  #otros_servicios_de_transporte="Otros ss de transporte",
  fletes="Fletes",
  servicios_de_comunicaciones="Comunicaciones",
  #servicios_de_gobierno="Gobierno", 
  servicios_relacionados_con_el_comercio="Relacionados con comercio",
  turismo="Turismo",
  cargos_por_el_uso_de_la_propiedad_intelectual="Propiedad Intelectual", 
  servicios_de_seguros_y_siniestros="Seguros y siniestros",
  #servicios_arrendamiento_operativo="Arrendamiento operativo",
  otros_agrup="Otros")

tabla6 <- mutate(tabla6, orden=1:length(tabla6$rubro),
                         es_turismo = ifelse(rubro == "Turismo", "si", "no"))


# ACUMULADO-----------------------------------------------------------------------------
# Ingresos
tabla5_acum <- ss_mensual %>% filter(!is.na(cobros)) %>% 
                         select(!c(balanza,pagos)) %>% 
                         filter(year(fecha) == anio_datos,
                                !rubro %in% c("total", 
                                           "entidades_y_otros_por_cancelacion_de_tarjetas",
                                           "operadores_turisticos_y_otras_transferencias",
                                           "no_residentes_billetes")) %>% 
                         group_by(rubro) %>% 
                         summarise(cobros = sum(cobros))

turismo <- tabla5_acum %>% summarise(turismo = sum(cobros[rubro %in% c("servicios_de_transporte_de_pasajeros",                                          "viajes_y_otros_pagos_con_tarjeta")]))

tabla5_acum <- tabla5_acum %>% add_row(cobros = turismo$turismo,
                             rubro = "turismo") %>% 
                     filter(!rubro %in% c("servicios_de_transporte_de_pasajeros",
                                      "viajes_y_otros_pagos_con_tarjeta")) %>% 
                     arrange(desc(cobros))

agrup_10p_cobros <- sum(tabla5_acum$cobros) * .01

otros_agrup <- tabla5_acum %>% summarise(otros_agrup = sum(cobros[tabla5_acum$cobros<agrup_10p_cobros | tabla5_acum$rubro == "otros"]))                       

tabla5_acum <- tabla5_acum %>% add_row(cobros = otros_agrup$otros_agrup,
                             rubro = "otros_agrup") %>% 
                     filter(cobros>agrup_10p_cobros & rubro != "otros")

#tabla5_acum <-tabla5_acum[c(1:9,16),]

tabla5_acum$rubro <- tabla5_acum$rubro %>%  as.factor() %>% recode_factor(
  servicios_empresariales_profesionales_y_tecnicos="Empresariales, profesionales y técnicos",
  servicios_de_informacion_e_informatica="Información e informática", 
  servicios_personales_culturales_y_recreativos="Personales, culturales y recreativos", 
  otros_servicios_de_transporte="Otros ss de transporte", fletes="Fletes",
  servicios_de_comunicaciones="Comunicaciones",
  servicios_de_gobierno="Gobierno", 
  servicios_relacionados_con_el_comercio="Relacionados con comercio",
  turismo="Turismo",
  cargos_por_el_uso_de_la_propiedad_intelectual="Propiedad Intelectual", 
  servicios_de_seguros_y_siniestros="Seguros y Siniestros",
  servicios_arrendamiento_operativo="Arrendamiento operativo",
  otros_agrup="Otros")


tabla5_acum <- mutate(tabla5_acum, orden = 1:length(tabla5_acum$rubro),
                      es_turismo = ifelse(rubro == "Turismo", "si", "no"))


# Egresos
tabla6_acum <- ss_mensual %>% filter(!is.na(pagos)) %>% 
                         select(!c(balanza,cobros)) %>% 
                         filter(year(fecha) == anio_datos,
                                !rubro %in% c("total", 
                                           "entidades_y_otros_por_cancelacion_de_tarjetas",
                                           "operadores_turisticos_y_otras_transferencias",
                                           "no_residentes_billetes")) %>% 
                         group_by(rubro) %>% 
                         summarise(pagos = sum(pagos))

turismo <- tabla6_acum %>% summarise(turismo = sum(pagos[rubro %in% c("servicios_de_transporte_de_pasajeros",                                          "viajes_y_otros_pagos_con_tarjeta")]))

tabla6_acum <- tabla6_acum %>% add_row(pagos = turismo$turismo,
                             rubro = "turismo") %>% 
                     filter(!rubro %in% c("servicios_de_transporte_de_pasajeros",
                                      "viajes_y_otros_pagos_con_tarjeta")) %>% 
                     arrange(desc(pagos))
agrup_10p_pagos <- sum(tabla6_acum$pagos) * .01

otros_agrup <- tabla6_acum %>% summarise(otros_agrup = sum(pagos[tabla6_acum$pagos<agrup_10p_pagos | tabla6_acum$rubro == "otros"]))                       

tabla6_acum <- tabla6_acum %>% add_row(pagos = otros_agrup$otros_agrup,
                             rubro = "otros_agrup") %>% 
                     filter(pagos>agrup_10p_pagos & rubro != "otros")

tabla6_acum$rubro <- tabla6_acum$rubro %>%  as.factor() %>% recode_factor(
  servicios_empresariales_profesionales_y_tecnicos="Empresariales, profesionales y técnicos",
  servicios_de_informacion_e_informatica="Información e informática", 
  servicios_personales_culturales_y_recreativos="Personales, culturales y recreativos", 
  otros_servicios_de_transporte="Otros ss de transporte", fletes="Fletes",
  servicios_de_comunicaciones="Comunicaciones",
  servicios_de_gobierno="Gobierno", 
  servicios_relacionados_con_el_comercio="Relacionados con comercio",
  turismo="Turismo",
  cargos_por_el_uso_de_la_propiedad_intelectual="Propiedad Intelectual", 
  servicios_de_seguros_y_siniestros="Seguros y siniestros",
  servicios_arrendamiento_operativo="Arrendamiento operativo",
  otros_agrup="Otros")


tabla6_acum <- mutate(tabla6_acum, orden = 1:length(tabla6_acum$rubro),
                      es_turismo = ifelse(rubro == "Turismo", "si", "no"))
```

+ En comparación con el resto de los sectores de servicios informados por el BCRA, en el mes de `r mes` de `r as.character(anio_datos)` el turismo fue el `r tabla5$orden[tabla5$rubro == "Turismo"]`º sector en cuanto a ingresos de divisas pero el `r tabla6$orden[tabla6$rubro == "Turismo"]`º en cuanto a egresos.


### Ingresos de divisas vía Mercado de Cambios. Apertura por sectores de servicios
#### `r paste(mes,"de",anio_datos)`. en millones de dólares
```{r}
g5 <- tabla5 %>% 
  ggplot(aes(x = cobros, y = reorder(rubro, -orden), 
             text = paste0('<br>rubro: ',rubro,
                           '<br>monto: US$',   format(round(cobros,1),big.mark=".",decimal.mark=",")," M"))) +
  geom_col(aes(fill=es_turismo))+
  geom_hline(yintercept = 0, size = 0.1) +
  #geom_text(aes(label=format(round(cobros,1),big.mar=".",decimal.mark = ",")),
  #         hjust=-.1)+
    xlim(0,max(tabla5$cobros)*1.1)+
  scale_fill_manual(values = c("no" = cols_arg, 
                               "si" = cols_arg2[1]))+
  scale_color_manual(values = c("no" = cols_arg, 
                               "si" = cols_arg2[1]))+
  labs(title="",
       subtitle = "",x="",y="",
       caption="DNMyE en base a BCRA")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente), 
    plot.title    = element_markdown(size = 14),
    plot.subtitle = element_markdown(size = 12),
    plot.caption  = element_markdown(size = 10),
    strip.text.y  = element_text(size = 10, face = "bold"),
    axis.text.x   = element_text(size = 10,angle=90),
    axis.text.y   = element_text(size = 10),
    panel.grid.minor.x = element_blank(),
    legend.position = "none",
    strip.placement = "outside")

ggplotly(g5,tooltip = "text") %>% layout(legend = list(
       orientation = "v",x=0.8
     )) 
```


### Egresos de divisas vía Mercado de Cambios. Apertura por sectores de servicios
#### `r paste(mes,"de",anio_datos)`. en millones de dólares
```{r}
g6 <- tabla6 %>% 
  ggplot(aes(x = pagos, y = reorder(rubro, -orden),
             text = paste0('<br>rubro: ',rubro,
                           '<br>monto: US$',   format(round(pagos,1),big.mark=".",decimal.mark=",")," M"))) +
  geom_col(aes(fill=es_turismo))+
  geom_hline(yintercept = 0, size = 0.1) +
  #geom_text(aes(label=format(round(pagos,1),big.mar=".",decimal.mark = ",")),
  #          hjust=-.1)+
  scale_fill_manual(values = c("no" = cols_arg2[6], 
                               "si" = cols_arg2[1]))+
  scale_color_manual(values = c("no" = cols_arg2[6], 
                               "si" = cols_arg2[1]))+
  xlim(0,max(tabla6$pagos)*1.1)+
  labs(title="",
       subtitle = "",x="",y="",
       caption="DNMyE en base a BCRA")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente), 
    plot.title    = element_markdown(size = 14),
    plot.subtitle = element_markdown(size = 12),
    plot.caption  = element_markdown(size = 10),
    strip.text.y  = element_text(size = 10, face = "bold"),
    axis.text.x   = element_text(size = 10,angle=90),
    axis.text.y   = element_text(size = 10),
    panel.grid.minor.x = element_blank(),
    legend.position = "none",
    strip.placement = "outside")

ggplotly(g6,tooltip = "text") %>% layout(legend = list(
       orientation = "v",x=0.8
     )) 
  
```


```{r}
# #ACUMULADO EN ENERO LO SACAMOSSSS

```

### Acumulado 2024
 
 + Mientras tanto, en el acumulado enero - `r mes` de `r as.character(anio_datos)`, el turismo ocupó el `r tabla5_acum$orden[tabla5_acum$rubro == "Turismo"]`º lugar en cuanto a ingresos, pero el `r tabla6_acum$orden[tabla6_acum$rubro == "Turismo"]`º en cuanto a egresos.

#### Ingresos de divisas vía Mercado de Cambios. Apertura por sectores de servicios
##### Acumulado enero - `r paste(mes,"de",anio_datos)`. en millones de dólares

```{r}
g5_acum <- tabla5_acum %>%
  ggplot(aes(x = cobros, y = reorder(rubro, -orden),
             text = paste0('<br>rubro: ',rubro,
                           '<br>monto: US$',   format(round(cobros,1),big.mark=".",decimal.mark=",")," M"))) +
  geom_col(aes(fill=es_turismo))+
  geom_hline(yintercept = 0, size = 0.1) +
  #geom_text(aes(label=format(round(cobros,1),big.mar=".",decimal.mark = ",")),
  #         hjust=-.1)+
    xlim(0,max(tabla5_acum$cobros)*1.1)+
  scale_fill_manual(values = c("no" = cols_arg,
                               "si" = cols_arg2[1]))+
  scale_color_manual(values = c("no" = cols_arg,
                               "si" = cols_arg2[1]))+
  labs(title="",
       subtitle = "",x="",y="",
       caption="DNMyE en base a BCRA")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente),
    plot.title    = element_markdown(size = 14),
    plot.subtitle = element_markdown(size = 12),
    plot.caption  = element_markdown(size = 10),
    strip.text.y  = element_text(size = 10, face = "bold"),
    axis.text.x   = element_text(size = 10,angle=90),
    axis.text.y   = element_text(size = 10),
    panel.grid.minor.x = element_blank(),
    legend.position = "none",
    strip.placement = "outside")

ggplotly(g5_acum,tooltip = "text") %>% layout(legend = list(
       orientation = "v",x=0.8
     ))
```

```{r}
#ACUMULADO ENERO LO SACAMOSSSSSS

```

### Egresos de divisas vía Mercado de Cambios. Apertura por sectores de servicios
#### Acumulado enero - `r paste(mes,"de",anio_datos)`. en millones de dólares

```{r}
g6_acum <- tabla6_acum %>%
  ggplot(aes(x = pagos, y = reorder(rubro, -orden),
             text = paste0('<br>rubro: ',rubro,
                           '<br>monto: US$',   format(round(pagos,1),big.mark=".",decimal.mark=",")," M"))) +
  geom_col(aes(fill=es_turismo))+
  geom_hline(yintercept = 0, size = 0.1) +
  #geom_text(aes(label=format(round(pagos,1),big.mar=".",decimal.mark = ",")),
  #          hjust=-.1)+
  scale_fill_manual(values = c("no" = cols_arg2[6],
                               "si" = cols_arg2[1]))+
  scale_color_manual(values = c("no" = cols_arg2[6],
                               "si" = cols_arg2[1]))+
  xlim(0,max(tabla6_acum$pagos)*1.1)+
  labs(title="",
       subtitle = "",x="",y="",
       caption="DNMyE en base a BCRA")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente),
    plot.title    = element_markdown(size = 14),
    plot.subtitle = element_markdown(size = 12),
    plot.caption  = element_markdown(size = 10),
    strip.text.y  = element_text(size = 10, face = "bold"),
    axis.text.x   = element_text(size = 10,angle=90),
    axis.text.y   = element_text(size = 10),
    panel.grid.minor.x = element_blank(),
    legend.position = "none",
    strip.placement = "outside")

ggplotly(g6_acum,tooltip = "text") %>% layout(legend = list(
       orientation = "v",x=0.8
     ))

```
### Apertura del rubro "Viajes y otros pagos con tarjeta"

```{r}
tabla3 <- ss_mensual %>% filter(year(fecha) >= 2017, 
                                rubro %in% c("entidades_y_otros_por_cancelacion_de_tarjetas",
                                "operadores_turisticos_y_otras_transferencias", 
                                "no_residentes_billetes"),
                                !is.na(cobros)) %>% 
                         select(fecha, rubro, cobros)

tabla3$rubro <- tabla3$rubro %>%  as.factor() %>% recode_factor(
  entidades_y_otros_por_cancelacion_de_tarjetas = "Tarjetas",
  operadores_turisticos_y_otras_transferencias = "Operadores turísticos", 
  no_residentes_billetes = "Billetes - No Residentes")

tabla4 <- ss_mensual %>% filter(year(fecha) >= 2017, 
                                rubro %in% c("entidades_y_otros_por_cancelacion_de_tarjetas",
                                "operadores_turisticos_y_otras_transferencias", 
                                "no_residentes_billetes"),
                                !is.na(cobros)) %>% 
                         select(fecha, rubro, pagos)

tabla4$rubro <- tabla4$rubro %>%  as.factor() %>% recode_factor(
  entidades_y_otros_por_cancelacion_de_tarjetas = "Tarjetas",
  operadores_turisticos_y_otras_transferencias = "Operadores turísticos", 
  no_residentes_billetes = "Billetes - No Residentes")
```

+ En el mes de `r mes` de `r as.character(anio_datos)`, los ingresos de divisas por cancelación de compras con tarjetas fueron de US\$`r round(tabla3 %>% filter(rubro == "Tarjetas") %>% last() %>% pull(cobros),1)` millones, presentando una variación del `r round((tabla3 %>% filter(rubro == "Tarjetas") %>% last() %>% pull(cobros)/tabla3 %>% filter(rubro == "Tarjetas") %>% nth(-13) %>% pull(cobros)-1)*100,1)`% respecto al mismo mes del año `r as.character(anio_datos-1)`. Por su lado, los ingresos por cobros de operadores turísticos locales fueron de US\$`r round(tabla3 %>% filter(rubro == "Operadores turísticos") %>% last() %>% pull(cobros),1)` millones, presentando una variación del `r round((tabla3 %>% filter(rubro == "Operadores turísticos") %>% last() %>% pull(cobros)/tabla3 %>% filter(rubro == "Operadores turísticos") %>% nth(-13) %>% pull(cobros)-1)*100,1)`% interanual.

+ Por su parte, los egresos de divisas por cancelación de compras con tarjetas fueron de US\$`r round(tabla4 %>% filter(rubro == "Tarjetas") %>% last() %>% pull(pagos),1)` millones, presentando una variación del `r round((tabla4 %>% filter(rubro == "Tarjetas") %>% last() %>% pull(pagos)/tabla4 %>% filter(rubro == "Tarjetas") %>% nth(-13) %>% pull(pagos)-1)*100,1)`% respecto al mismo mes del año `r as.character(anio_datos-1)`. Los egresos por pagos al exterior realizados por operadores turísticos locales fueron de US\$`r round(tail(tabla4$pagos[tabla4$rubro == "Operadores turísticos"],n=1),1)` millones, presentando una variación del `r round((tabla4 %>% filter(rubro == "Operadores turísticos") %>% last() %>% pull(pagos)/tabla4 %>% filter(rubro == "Operadores turísticos") %>% nth(-13) %>% pull(pagos)-1)*100,1)`% interanual.

### Ingresos de divisas por viajes y otros pagos con tarjeta. Apertura por rubros

#### En millones de dólares
```{r}
g3 <- tabla3 %>% 
  ggplot(aes(x = fecha, y = cobros,fill = rubro
#             ,             text = paste0('fecha: ', format(fecha,"%b-%y"),
#                           '<br>rubro: ',rubro,
#                           '<br>monto: US$', #format(round(cobros,1),big.mark=".",decimal.mark=",")," M")
      )) +
  geom_area()+
  scale_fill_manual(values = cols_arg2[2:4]) +
  scale_x_date(breaks = seq.Date(as.Date(min(tabla3$fecha))+months(month(max(tabla3$fecha))-7),as.Date(max(tabla3$fecha)),by="3 months"),
               date_labels = "%b%y", 
               expand = c(0,0))+
  labs(#title="Ingresos de divisas por viajes y otros pagos con tarjeta. Apertura por rubros",
       #subtitle = "En millones de dólares",
       x="",y="",
       caption="DNMyE en base a BCRA")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente), 
    plot.title    = element_markdown(size = 10),
    plot.subtitle = element_markdown(size = 8),
    plot.caption  = element_markdown(size = 6),
    strip.text.y  = element_text(size = 8, face = "bold"),
    axis.text.x   = element_text(size = 6,angle=90),
    axis.text.y   = element_text(size = 8),
    panel.grid.minor.x = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(), 
    strip.placement = "outside")

ggplotly(g3,tooltip = "text") %>%
 layout(legend = list(orientation = "v",x=0.8),
        hovermode = "x")
```

### Egresos de divisas por viajes y otros pagos con tarjeta. Apertura por rubros
#### En millones de dólares
```{r}

g4 <- tabla4 %>% 
  ggplot(aes(x = fecha, y = pagos, fill = rubro
  #             ,
  #             text = paste0('fecha: ', format(fecha,"%b-%y"),
  #                           '<br>rubro: ',rubro,
  #                           '<br>monto: US$',
  # format(round(pagos,1),big.mark=".",decimal.mark=",")," M")
             ))+
  geom_area()+
  scale_fill_manual(values = cols_arg2[2:4],label=c("Tarjetas", "Billetes - No Residentes", "Operadores turísticos")) +
  scale_x_date(breaks = seq.Date(as.Date(min(tabla1$fecha))+months(month(max(tabla1$fecha))-7),as.Date(max(tabla1$fecha)),by="3 months"),
               date_labels = "%b%y", 
               expand = c(0,0))+
  labs(#title="Egresos de divisas por viajes y otros pagos con tarjeta. Apertura por rubros",
       #subtitle = "En millones de dólares",
       x="",y="",
       caption="DNMyE en base a BCRA")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente), 
    plot.title    = element_markdown(size = 10),
    plot.subtitle = element_markdown(size = 8),
    plot.caption  = element_markdown(size = 6),
    strip.text.y  = element_text(size = 8, face = "bold"),
    axis.text.x   = element_text(size = 6,angle=90),
    axis.text.y   = element_text(size = 8),
    panel.grid.minor.x = element_blank(),
    legend.position = "bottom",
     legend.title = element_blank(),
    strip.placement = "outside")

ggplotly(g4,tooltip = "text") %>% 
  layout(legend = list(orientation = "v",x=0.8),
         hovermode = "x") 

```

### Balanza de Pagos vs Mercado de Cambios (BCRA)
```{r}
tabla7_mulc <- ss_trim %>% filter(variable=="cobros", 
                                  rubro %in% c("viajes_y_otros_pagos_con_tarjeta", 
                                               "servicios_de_transporte_de_pasajeros"),
                                  anio>=2011,
                                  !is.na(value)) %>% 
                          pivot_wider(names_from = rubro, values_from = value)
tabla7_mulc <- cbind(tabla7_mulc, MULC=apply(tabla7_mulc[5:6], 1, sum)) %>% 
                          select(fecha,MULC)
              

tabla7_BP <- BP %>% filter(year>=2011) %>% select(fecha, tur_receptivo_mill)  
                    #filter(row_number() !=n())
                  
tabla7 <- right_join(tabla7_mulc, tabla7_BP, by = "fecha") %>% 
          rename("BP"="tur_receptivo_mill") %>% 
          pivot_longer(c(4:5), names_to = "turismo_cobros") %>% 
          group_by(turismo_cobros) %>% 
          mutate(fecha=factor(fecha,levels=fecha)) %>% 
          ungroup()

rm(tabla7_BP, tabla7_mulc)

g7 <- tabla7 %>% ggplot(aes(fecha, value, color=turismo_cobros, group=turismo_cobros,
                            text = paste0(turismo_cobros,
                              '<br>fecha: ',fecha,
                              '<br>monto: US$', format(round(value,1),big.mark=".",decimal.mark=",")," M"))) +
  geom_line(size=1)+
  geom_point(size=2)+
  scale_color_manual(values = c(cols_arg2[3], cols_arg)) +
  labs(#title="Ingresos por turismo: BP vs MULC",
       #subtitle = "En millones de dólares",
       x="",y="",
       caption="DNMyE en base a BCRA y Dirección Nacional de Cuentas Internacionales")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente), 
    plot.title    = element_markdown(size = 10),
    plot.subtitle = element_markdown(size = 8),
    plot.caption  = element_markdown(size = 6),
    strip.text.y  = element_text(size = 8, face = "bold"),
    axis.text.x   = element_text(size = 6,angle=90),
    axis.text.y   = element_text(size = 8),
    panel.grid.minor.x = element_blank(),
    legend.title = element_blank(),
    legend.position = "bottom",
    strip.placement = "outside")

tabla8 <- tabla7 %>% pivot_wider(names_from = turismo_cobros, values_from = value) %>% 
                     summarise(fecha=fecha,
                               prop_mulc_bp= MULC/BP*100) %>% 
          mutate(fecha=factor(fecha,levels=fecha))

g8 <- tabla8 %>% ggplot(aes(fecha, prop_mulc_bp,
                            text = paste0('<br>fecha: ',fecha,
                              '<br>proporción MULC/BP: ', format(round(prop_mulc_bp,1),big.mark=".",decimal.mark=","),"%"))) +
  geom_hline(yintercept = 100, color="lightgrey")+
  geom_col(fill="darkgrey")+
  scale_y_continuous(n.breaks = 10)+
  labs(#title="Proporción de ingresos por turismo en el MULC sobre el total de la BP",
       #subtitle = "En %",
       x="",y="",
       caption="DNMyE en base a BCRA y Dirección Nacional de Cuentas Internacionales")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente), 
    plot.title    = element_markdown(size = 10),
    plot.subtitle = element_markdown(size = 8),
    plot.caption  = element_markdown(size = 6),
    strip.text.y  = element_text(size = 8, face = "bold"),
    axis.text.x   = element_text(size = 6,angle=90),
    axis.text.y   = element_text(size = 8),
    panel.grid.minor.x = element_blank(),
    legend.title = element_blank(),
    strip.placement = "outside")
```


+ En el cuarto trimestre de 2023, se registraron US\$`r (tabla7$value[tabla7$turismo_cobros=="BP"]) %>% last() %>% round(1)` millones de ingresos totales asociados al turismo, según la Balanza de Pagos ("BP"). Por su lado, un `r last(tabla8$prop_mulc_bp) %>% round(1)`% de esos ingresos se canalizaron por el mercado oficial de cambios, es decir, US\$`r tabla7$value[tabla7$turismo_cobros=="MULC"] %>% last() %>% round(1)` millones.

*NOTA: Es importante notar que, los ingresos por turismo a través del mercado oficial de cambios (MULC) siempre deberían ser menores, o al menos iguales, al total de ingresos por turismo que percibe la Argentina según la Balanza de Pagos. Sin embargo, en los trimestres 2, 3 y 4 del año 2020 y 3 de 2021, la proporción MULC/BP es mayor al 100%. Esto es debido a las diferencias en cuanto a la metodología de registración de ambas fuentes de información y los desfasajes en la vuelta de los turistas no residentes a sus lugares de origen, producto de las restricciones al tránsito internacional por la pandemia por el virus COVID-19.*

### Evolución trimestral de los ingresos por turismo - BP vs Mercado de Cambios 
#### en millones de dólares
```{r}
ggplotly(g7,tooltip = "text") %>% 
  layout(legend = list(orientation = "v",x=0.8),
         hovermode = "x") 
```

### Ingresos por turismo: proporción Mercado de Cambios sobre BP
#### en %
```{r}
ggplotly(g8,tooltip = "text") %>% 
  layout(legend = list(orientation = "v",x=0.8))

```

```{r}
tabla9_mulc <- ss_trim %>% filter(variable=="pagos", 
                                  rubro %in% c("viajes_y_otros_pagos_con_tarjeta", 
                                               "servicios_de_transporte_de_pasajeros"),
                                  anio>=2011,
                                  !is.na(value)) %>% 
                          pivot_wider(names_from = rubro, values_from = value)
tabla9_mulc <- cbind(tabla9_mulc, MULC=apply(tabla9_mulc[5:6], 1, sum)) %>% 
                          select(fecha,MULC)
              

tabla9_BP <- BP %>% filter(year>=2011) %>% select(fecha, tur_emisivo_mill) 
  #filter(row_number() !=n())
                  
tabla9 <- right_join(tabla9_mulc, tabla9_BP, by = "fecha") %>% 
          rename("BP"="tur_emisivo_mill") %>% 
          pivot_longer(c(4:5), names_to = "turismo_pagos") %>% 
          group_by(turismo_pagos) %>% 
          mutate(fecha=factor(fecha,levels=fecha)) %>% 
          ungroup()

rm(tabla9_BP, tabla9_mulc)

g9 <- tabla9 %>% ggplot(aes(fecha, value, color=turismo_pagos, group=turismo_pagos,
                             text = paste0(turismo_pagos,
                              '<br>fecha: ',fecha,
                              '<br>monto: US$', format(round(value,1),big.mark=".",decimal.mark=",")," M"))) +
  geom_line(size=1)+
  geom_point(size=2)+
  scale_color_manual(values = c(cols_arg2[5:6])) +
  labs(#title="Egresos por turismo: BP vs MULC",
       #subtitle = "En millones de dólares",
       x="",y="",
       caption="DNMyE en base a BCRA y Dirección Nacional de Cuentas Internacionales")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente), 
    plot.title    = element_markdown(size = 10),
    plot.subtitle = element_markdown(size = 8),
    plot.caption  = element_markdown(size = 6),
    strip.text.y  = element_text(size = 8, face = "bold"),
    axis.text.x   = element_text(size = 6,angle=90),
    axis.text.y   = element_text(size = 8),
    panel.grid.minor.x = element_blank(),
    legend.title = element_blank(),
    legend.position = "bottom",
    strip.placement = "outside")

tabla10 <- tabla9 %>% pivot_wider(names_from = turismo_pagos, values_from = value) %>% 
                     summarise(fecha=fecha,
                               prop_mulc_bp= MULC/BP*100) %>% 
           mutate(fecha=factor(fecha,levels=fecha))

g10 <- tabla10 %>% ggplot(aes(fecha, prop_mulc_bp,
                              text = paste0('<br>fecha: ',fecha,
                              '<br>proporción MULC/BP: ', format(round(prop_mulc_bp,1),big.mark=".",decimal.mark=","),"%"))) +
  geom_hline(yintercept = 100, color="lightgrey")+
  geom_col(fill="darkgrey")+
  scale_y_continuous(n.breaks = 10)+
  labs(#title="Proporción de egresos por turismo en el MULC sobre el total de la BP",
       #subtitle = "En %",
       x="",y="",
       caption="DNMyE en base a BCRA y Dirección Nacional de Cuentas Internacionales")+
  theme_minimal()+
  theme(
    text = element_text(family = familia_fuente), 
    plot.title    = element_markdown(size = 10),
    plot.subtitle = element_markdown(size = 8),
    plot.caption  = element_markdown(size = 6),
    strip.text.y  = element_text(size = 8, face = "bold"),
    axis.text.x   = element_text(size = 6, angle=90),
    axis.text.y   = element_text(size = 8),
    panel.grid.minor.x = element_blank(),
    legend.title = element_blank(),
    strip.placement = "outside")
```

+ En cuanto a los egresos, en el cuarto trimestre de 2023, se registraron US\$`r tabla9$value[tabla9$turismo_pagos=="BP"] %>% last() %>% round(1)` millones de egresos totales asociados al turismo, según la BP. Por su lado, el Mercado de Cambios registró una salida de divisas en los rubros turísticos de US\$`r tabla9$value[tabla9$turismo_pagos=="MULC"] %>% last() %>% round(1)` millones, es decir, un `r last(tabla10$prop_mulc_bp) %>% round(1)`% de los egresos registrados por la BP.

*NOTA: En el caso de los egresos, también se debe cumplir la misma condición (egresos por turismo a través del mercado oficial de cambios-MULC-siempre deberían ser menores, o al menos iguales, al total de egresos por turismo de la Argentina según la Balanza de Pagos), sin embargo, nuevamente existen trimestres, a partir del año 2020, en donde esto no se cumple . Se debe a que, además de las diferencias metodológicas de ambas fuentes -registro de transacciones vs. estimación a partir de encuestas de demanda-, sucede que el componente turístico del MULC incluye pagos con tarjeta realizados por residentes en Argentina a residentes en el exterior y que pueden no ser gastos turísticos. Ejemplos de esto podrían ser los pagos de servicios de streaming. Por lo tanto, en los casos en que el ratio MULC/BP es mayor al 100% se evidencia que los gastos con tarjeta por motivos no turísticos aumentaron la componente "viajes y otros gastos con tarjeta" del MULC por encima de los gastos del turismo emisivo registrado por la BP. En los trimestres comprendidos en la pandemia por COVID-19, esta situación se refleja aún más debido a la reducción cercana al 100% i.a. del turismo emisivo.*

### Evolución trimestral de los egresos por turismo - BP vs Mercado de Cambios 
#### en millones de dólares
```{r}
ggplotly(g9,tooltip = "text") %>% 
  layout(legend = list(orientation = "v",x=0.8),
         hovermode = "x") 
```

### Egresos por turismo: proporción Mercado de Cambios sobre BP
#### en %
```{r}
ggplotly(g10,tooltip = "text") %>% 
  layout(legend = list(orientation = "v",x=0.8))

```


#### Para más información sobre qué es el turismo dentro del Mercado de Cambios:

[**Bitácora**](https://bitacora.yvera.tur.ar/posts/2021-10-20-mulc/)

::: {.infobox}

Para recibir las novedades del SINTA escribíle al bot de Telegram de la DNMyE [*SintIA*](https://bitacora.yvera.tur.ar/posts/2022-09-08-sintia/): @RDatinaBot 🤖

:::

