---
title: "Conectividad Aérea"
description: "Resumen de datos de flujo aerocomercial, en base a los registros de frecuencias aéreas de la Administración Nacional de Aviación Civil (ANAC)."
output:
  distill::distill_article:
    self_contained: TRUE
draft: true
params:
  memoria: false

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, 
                      fig.align = 'left', fig.width = 10,fig.height = 6)

library(tidyverse)
library(readxl)
library(comunicacion)
library(lubridate)
library(gt)
library(arrow)
library(sf)
library(geoAr)
library(plotly)
library(herramientas)
options(scipen = 999)

Sys.setlocale(locale = "es_AR.UTF-8")

```

```{r carga base}

base_total <- read_file_srv("/srv/DataDNMYE/aerocomercial/anac/base_anac_agrupada_diaria.parquet")


publicacion_mes_anio <- strftime(Sys.Date(), '%B %Y')

datos_mes_anio <- strftime(max(base_total$Fecha), '%B')
  
datos_mes_anio_bis <- strftime(max(base_total$Fecha), '%d-%m-%Y')

```

```{r}
# Cabotaje
cabotaje <- base_total %>% 
  filter(clasificacion_vuelo == "Cabotaje") %>% 
  mutate(region_destino = case_when(destino_provincia_etiqueta == "Buenos Aires" ~ "Buenos Aires",
                                    destino_provincia_etiqueta == "Ciudad Autónoma de Buenos Aires" ~ "AMBA",
                                    destino_provincia_etiqueta == "Córdoba" ~ "Córdoba",
                                    destino_provincia_etiqueta == "Tierra del Fuego, Antártida e Islas del Atlántico Sur" ~ "Patagonia",
                                    destino_provincia_etiqueta == "Santa Cruz" ~ "Patagonia",
                                    destino_provincia_etiqueta == "Chubut" ~ "Patagonia",
                                    destino_provincia_etiqueta == "Neuquén" ~ "Patagonia",
                                    destino_provincia_etiqueta == "Río Negro" ~ "Patagonia",
                                    destino_provincia_etiqueta == "La Pampa" ~ "Patagonia",
                                    destino_provincia_etiqueta == "Mendoza" ~ "Cuyo",
                                    destino_provincia_etiqueta == "San Juan" ~ "Cuyo",
                                    destino_provincia_etiqueta == "San Luis" ~ "Cuyo",
                                    destino_provincia_etiqueta == "La Rioja" ~ "Norte",
                                    destino_provincia_etiqueta == "Catamarca" ~ "Norte",
                                    destino_provincia_etiqueta == "Salta" ~ "Norte",
                                    destino_provincia_etiqueta == "Jujuy" ~ "Norte",
                                    destino_provincia_etiqueta == "Santiago del Estero" ~ "Norte",
                                    destino_provincia_etiqueta == "Tucumán" ~ "Norte",
                                    destino_provincia_etiqueta == "Santa Fe" ~ "Litoral",
                                    destino_provincia_etiqueta == "Chaco" ~ "Litoral",
                                    destino_provincia_etiqueta == "Formosa" ~ "Litoral",
                                    destino_provincia_etiqueta == "Misiones" ~ "Litoral",
                                    destino_provincia_etiqueta == "Corrientes" ~ "Litoral",
                                    destino_provincia_etiqueta == "Entre Ríos" ~ "Litoral",
                                    T ~ "No hay info"),
         region_destino = case_when(destino_aeropuerto_etiqueta %in% c("Aeropuerto Int. Ministro Pistarini", "Aeropuerto Int. de San Fernando", "Aeropuerto El Palomar") ~ "AMBA",
                                    T ~ region_destino))

#Filtramos de momento los casos sin info.
cabotaje <- cabotaje %>% 
  filter(region_destino != "No hay info") 
```

```{r}
colores_aero <- c("Aerolíneas Argentinas" = dnmye_colores("cian"),
                  "LADE - Líneas Aéreas Del Estado" = dnmye_colores("gris oscuro"),
                  "Flybondi" = dnmye_colores("amarillo"),
                  "JetSMART Airlines" = dnmye_colores("purpura"))
```

```{r}
vuelos_mes <- cabotaje %>%
    group_by(anio_local, mes_local) %>%
    summarise(frecuencias = sum(vuelos, na.rm = T)) %>%
    mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
           frecuencias = round(frecuencias, 0)) %>%
  ungroup() %>%
  filter(anio_local %in% c(max(year(fecha)), max(year(fecha))-1)) %>%
  filter(mes_local <= month(max(fecha))) %>%
  arrange(fecha) %>% 
  mutate(control_fecha = lag(fecha,  nrow(.)/2),
         var_ia = (frecuencias/lag(frecuencias, nrow(.)/2)-1)*100) %>%
  group_by(anio_local) %>% 
  mutate(acum_anual = sum(frecuencias)) %>% 
  ungroup() %>% 
  mutate(var_anual_acum = (acum_anual/lag(acum_anual, nrow(.)/2)-1)*100) %>%
  filter(fecha == max(fecha))

vuelos_mes_2019 <- cabotaje %>% 
  filter(mes_local == month(max(fecha_month))) %>% 
  filter(anio_local == 2019) %>% 
  group_by(mes_local) %>% 
  summarise(vuelos = round(sum(vuelos, na.rm = T),0)) %>% 
  select(vuelos) %>% 
  pull

var_2019_vuelos <- if_else((((vuelos_mes %>% select(frecuencias) %>% pull)/vuelos_mes_2019)-1)*100 < 0,
                                  paste0(round((((vuelos_mes %>% select(frecuencias) %>% pull)/vuelos_mes_2019)-1)*100*-1, 2) %>% format(., decimal.mark = ","),
                                        "% menos"),
                                  paste0(round((((vuelos_mes %>% select(frecuencias) %>% pull)/vuelos_mes_2019)-1)*100, 2) %>% format(., decimal.mark = ","),
                                        "% más"))

vuelos_mes_total <- vuelos_mes %>% 
  select(frecuencias) %>% 
  pull %>%
  format(., big.mark = ".")

variacion_interanual <- if_else(vuelos_mes$var_ia > 0,
                                paste0("un crecimiento de ",
                                       format(round(vuelos_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "%"),
                                paste0("un decrecimiento de ",
                                       format(round(vuelos_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "%"))

vuelos_acumulados_total <- vuelos_mes %>% 
  select(acum_anual) %>% 
  pull %>%
  format(., big.mark = ".")

variacion_interanual_acum <- if_else(vuelos_mes$acum_anual > 0,
                                     paste0(format(round(vuelos_mes$var_anual_acum, 2),
                                                   decimal.mark = ","),
                                            "% ",
                                            "más"),
                                paste0(format(round(vuelos_mes$var_anual_acum, 2),
                                              decimal.mark = ","),
                                       "%",
                                       "menos"))

```

```{r}
pasajeros_mes <- cabotaje %>%
    group_by(anio_local, mes_local) %>%
    summarise(pasajeros = sum(pax_ad, na.rm = T)) %>%
    mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
           pasajeros = round(pasajeros, 0)) %>%
  ungroup() %>%
  filter(anio_local %in% c(max(year(fecha)), max(year(fecha))-1)) %>%
  filter(mes_local <= month(max(fecha))) %>% 
  arrange(fecha) %>% 
  mutate(control_fecha = lag(fecha,  nrow(.)/2),
         var_ia = (pasajeros/lag(pasajeros, nrow(.)/2)-1)*100) %>% 
  group_by(anio_local) %>% 
  mutate(acum_anual = sum(pasajeros)) %>% 
  ungroup() %>% 
  mutate(var_anual_acum = (acum_anual/lag(acum_anual, nrow(.)/2)-1)*100) %>%
  filter(fecha == max(fecha)) 

pasajeros_mes_2019 <- cabotaje %>% 
  filter(mes_local == month(max(fecha_month))) %>% 
  filter(anio_local == 2019) %>% 
  group_by(mes_local) %>% 
  summarise(pasajeros = round(sum(pax_ad, na.rm = T),0)) %>% 
  select(pasajeros) %>% 
  pull

var_2019_pasajeros <- if_else((((pasajeros_mes %>% select(pasajeros) %>% pull)/pasajeros_mes_2019)-1)*100 < 0,
                                  paste0(round((((pasajeros_mes %>% select(pasajeros) %>% pull)/pasajeros_mes_2019)-1)*100*-1, 2) %>% format(., decimal.mark = ","),
                                        "% menos"),
                                  paste0(round((((pasajeros_mes %>% select(pasajeros) %>% pull)/pasajeros_mes_2019)-1)*100, 2) %>% format(., decimal.mark = ","),
                                        "% más"))

pasajeros_mes_total <- pasajeros_mes %>% 
  select(pasajeros) %>% 
  pull %>%
  format(., big.mark = ".")


variacion_interanual_pasajeros <- if_else(pasajeros_mes$var_ia > 0,
                                paste0(format(round(pasajeros_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "% ",
                                       "más"),
                                paste0(format(round(pasajeros_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "% ",
                                       "menos"))

pasajeros_acumulados_total <- pasajeros_mes %>% 
  select(acum_anual) %>% 
  pull %>%
  format(., big.mark = ".")

variacion_interanual_acum_pasajeros <- if_else(pasajeros_mes$acum_anual > 0,
                                     paste0(format(round(pasajeros_mes$var_anual_acum, 2),
                                                   decimal.mark = ","),
                                            "% ",
                                            "más"),
                                paste0(format(round(pasajeros_mes$var_anual_acum, 2),
                                              decimal.mark = ","),
                                       "% ",
                                       "menos"))
```

```{r}
asientos_mes <- cabotaje %>%
    group_by(anio_local, mes_local) %>%
    summarise(asientos = sum(asientos_pax, na.rm = T)) %>%
    mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
           asientos = round(asientos, 0)) %>%
  ungroup() %>%
  filter(anio_local %in% c(max(year(fecha)), max(year(fecha))-1)) %>%
  filter(mes_local <= month(max(fecha))) %>% 
  arrange(fecha) %>% 
  mutate(control_fecha = lag(fecha,  nrow(.)/2),
         var_ia = (asientos/lag(asientos, nrow(.)/2)-1)*100) %>% 
  group_by(anio_local) %>% 
  mutate(acum_anual = sum(asientos)) %>% 
  ungroup() %>% 
  mutate(var_anual_acum = (acum_anual/lag(acum_anual, nrow(.)/2)-1)*100) %>%
  filter(fecha == max(fecha)) 

asientos_mes_2019 <- cabotaje %>% 
  filter(mes_local == month(max(fecha_month))) %>% 
  filter(anio_local == 2019) %>% 
  group_by(mes_local) %>% 
  summarise(asientos = round(sum(asientos_pax, na.rm = T),0)) %>% 
  select(asientos) %>% 
  pull

var_2019_asientos <- if_else((((asientos_mes %>% select(asientos) %>% pull)/asientos_mes_2019)-1)*100 < 0,
                                  paste0(round((((asientos_mes %>% select(asientos) %>% pull)/asientos_mes_2019)-1)*100*-1, 2) %>% format(., decimal.mark = ","),
                                        "% menos"),
                                  paste0(round((((asientos_mes %>% select(asientos) %>% pull)/asientos_mes_2019)-1)*100, 2) %>% format(., decimal.mark = ","),
                                        "% más"))

asientos_mes_total <- asientos_mes %>% 
  select(asientos) %>% 
  pull %>%
  format(., big.mark = ".")


variacion_interanual_asientos <- if_else(asientos_mes$var_ia > 0,
                                paste0("crecimiento de ",
                                       format(round(asientos_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "% "),
                                paste0("decrecimiento de ",
                                       format(round(asientos_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "%"))

asientos_acumulados_total <- asientos_mes %>% 
  select(acum_anual) %>% 
  pull %>%
  format(., big.mark = ".")

variacion_interanual_acum_asientos <- if_else(asientos_mes$acum_anual > 0,
                                     paste0(format(round(asientos_mes$var_anual_acum, 2),
                                                   decimal.mark = ","),
                                            "% ",
                                            "más"),
                                paste0(format(round(asientos_mes$var_anual_acum, 2),
                                              decimal.mark = ","),
                                       "% ",
                                       "menos"))
```

```{r}
internacional <- base_total %>% 
  filter(clasificacion_vuelo == "Internacional")
```

```{r, include=FALSE}
int_vuelos_mes <- internacional %>%
    group_by(anio_local, mes_local) %>%
    summarise(frecuencias = sum(vuelos, na.rm = T)) %>%
    mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
           frecuencias = round(frecuencias, 0)) %>%
  ungroup() %>%
  filter(anio_local %in% c(max(year(fecha)), max(year(fecha))-1)) %>%
  filter(mes_local <= month(max(fecha))) %>% 
  arrange(fecha) %>% 
  mutate(control_fecha = lag(fecha,  nrow(.)/2),
         var_ia = (frecuencias/lag(frecuencias, nrow(.)/2)-1)*100) %>% 
  group_by(anio_local) %>% 
  mutate(acum_anual = sum(frecuencias)) %>% 
  ungroup() %>% 
  mutate(var_anual_acum = (acum_anual/lag(acum_anual, nrow(.)/2)-1)*100) %>%
  filter(fecha == max(fecha))

int_vuelos_mes_2019 <- internacional %>% 
  filter(mes_local == month(max(fecha_month))) %>% 
  filter(anio_local == 2019) %>% 
  group_by(mes_local) %>% 
  summarise(vuelos = round(sum(vuelos, na.rm = T),0)) %>% 
  select(vuelos) %>% 
  pull

int_var_2019_vuelos <- if_else((((int_vuelos_mes %>% select(frecuencias) %>% pull)/int_vuelos_mes_2019)-1)*100 < 0,
                                  paste0(round((((int_vuelos_mes %>% select(frecuencias) %>% pull)/int_vuelos_mes_2019)-1)*100*-1, 2) %>% format(., decimal.mark = ","),
                                        "% menos"),
                                  paste0(round((((int_vuelos_mes %>% select(frecuencias) %>% pull)/int_vuelos_mes_2019)-1)*100, 2) %>% format(., decimal.mark = ","),
                                        "% más"))

int_vuelos_mes_total <- int_vuelos_mes %>% 
  select(frecuencias) %>% 
  pull %>%
  format(., big.mark = ".")


int_variacion_interanual <- if_else(int_vuelos_mes$var_ia > 0,
                                paste0("un crecimiento interanual de ",
                                       format(round(int_vuelos_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "%"),
                                paste0("un decrecimiento interanual de ",
                                       format(round(int_vuelos_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "%"))

int_vuelos_acumulados_total <- int_vuelos_mes %>% 
  select(acum_anual) %>% 
  pull %>%
  format(., big.mark = ".")

int_variacion_interanual_acum <- if_else(int_vuelos_mes$acum_anual > 0,
                                     paste0(format(round(int_vuelos_mes$var_anual_acum, 2),
                                                   decimal.mark = ","),
                                            "% ",
                                            "más"),
                                paste0(format(round(int_vuelos_mes$var_anual_acum, 2),
                                              decimal.mark = ","),
                                       "%",
                                       "menos"))
```

```{r}
int_asientos_mes <- internacional %>%
    group_by(anio_local, mes_local) %>%
    summarise(asientos = sum(asientos_pax, na.rm = T)) %>%
    mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
           asientos = round(asientos, 0)) %>%
  ungroup() %>%
  filter(anio_local %in% c(max(year(fecha)), max(year(fecha))-1)) %>%
  filter(mes_local <= month(max(fecha))) %>% 
  arrange(fecha) %>% 
  mutate(control_fecha = lag(fecha,  nrow(.)/2),
         var_ia = (asientos/lag(asientos, nrow(.)/2)-1)*100) %>% 
  group_by(anio_local) %>% 
  mutate(acum_anual = sum(asientos)) %>% 
  ungroup() %>% 
  mutate(var_anual_acum = (acum_anual/lag(acum_anual, nrow(.)/2)-1)*100) %>%
  filter(fecha == max(fecha)) 

int_asientos_mes_2019 <- internacional %>% 
  filter(mes_local == month(max(fecha_month))) %>% 
  filter(anio_local == 2019) %>% 
  group_by(mes_local) %>% 
  summarise(asientos = round(sum(asientos_pax, na.rm = T),0)) %>% 
  select(asientos) %>% 
  pull

int_var_2019_asientos <- if_else((((int_asientos_mes %>% select(asientos) %>% pull)/int_asientos_mes_2019)-1)*100 < 0,
                                  paste0(round((((int_asientos_mes %>% select(asientos) %>% pull)/int_asientos_mes_2019)-1)*100*-1, 2) %>% format(., decimal.mark = ","),
                                        "% menos"),
                                  paste0(round((((int_asientos_mes %>% select(asientos) %>% pull)/int_asientos_mes_2019)-1)*100, 2) %>% format(., decimal.mark = ","),
                                        "% más"))

int_asientos_mes_total <- int_asientos_mes %>% 
  select(asientos) %>% 
  pull %>%
  format(., big.mark = ".")

int_variacion_interanual_asientos <- if_else(int_asientos_mes$var_ia > 0,
                                paste0("crecimiento de ",
                                       format(round(int_asientos_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "% "),
                                paste0("decrecimiento de ",
                                       format(round(int_asientos_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "%"))

int_asientos_acumulados_total <- int_asientos_mes %>% 
  select(acum_anual) %>% 
  pull %>%
  format(., big.mark = ".")

int_variacion_interanual_acum_asientos <- if_else(int_asientos_mes$acum_anual > 0,
                                     paste0(format(round(int_asientos_mes$var_anual_acum, 2),
                                                   decimal.mark = ","),
                                            "% "),
                                paste0(format(round(int_asientos_mes$var_anual_acum, 2),
                                              decimal.mark = ","),
                                       "% "))
```

```{r}
int_pasajeros_mes <- internacional %>%
    group_by(anio_local, mes_local) %>%
    summarise(pasajeros = sum(pax_ad, na.rm = T)) %>%
    mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
           pasajeros = round(pasajeros, 0)) %>%
  ungroup() %>%
  filter(anio_local %in% c(max(year(fecha)), max(year(fecha))-1)) %>%
  filter(mes_local <= month(max(fecha))) %>% 
  arrange(fecha) %>% 
  mutate(control_fecha = lag(fecha,  nrow(.)/2),
         var_ia = (pasajeros/lag(pasajeros, nrow(.)/2)-1)*100) %>% 
  group_by(anio_local) %>% 
  mutate(acum_anual = sum(pasajeros)) %>% 
  ungroup() %>% 
  mutate(var_anual_acum = (acum_anual/lag(acum_anual, nrow(.)/2)-1)*100) %>%
  filter(fecha == max(fecha)) 

int_pasajeros_mes_2019 <- internacional %>% 
  filter(mes_local == month(max(fecha_month))) %>% 
  filter(anio_local == 2019) %>% 
  group_by(mes_local) %>% 
  summarise(pasajeros = round(sum(pax_ad, na.rm = T),0)) %>% 
  select(pasajeros) %>% 
  pull

int_var_2019_pasajeros <- if_else((((int_pasajeros_mes %>% select(pasajeros) %>% pull)/int_pasajeros_mes_2019)-1)*100 < 0,
                                  paste0(round((((int_pasajeros_mes %>% select(pasajeros) %>% pull)/int_pasajeros_mes_2019)-1)*100*-1, 2) %>% format(., decimal.mark = ","),
                                        "% menos"),
                                  paste0(round((((int_pasajeros_mes %>% select(pasajeros) %>% pull)/int_pasajeros_mes_2019)-1)*100, 2) %>% format(., decimal.mark = ","),
                                        "% más"))

int_pasajeros_mes_total <- int_pasajeros_mes %>% 
  select(pasajeros) %>% 
  pull %>%
  format(., big.mark = ".")


int_variacion_interanual_pasajeros <- if_else(int_pasajeros_mes$var_ia > 0,
                                paste0(format(round(int_pasajeros_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "% ",
                                       "más"),
                                paste0(format(round(int_pasajeros_mes$var_ia, 2),
                                              decimal.mark = ","),
                                       "% ",
                                       "menos"))

int_pasajeros_acumulados_total <- int_pasajeros_mes %>% 
  select(acum_anual) %>% 
  pull %>%
  format(., big.mark = ".")

int_variacion_interanual_acum_pasajeros <- if_else(int_pasajeros_mes$acum_anual > 0,
                                                   paste0(format(round(int_pasajeros_mes$var_anual_acum, 2),
                                                                 decimal.mark = ","),
                                                          "% ",
                                                          "más"),
                                                   paste0(format(round(int_pasajeros_mes$var_anual_acum, 2),
                                                                 decimal.mark = ","),
                                                          "% ",
                                                          "menos"))
```

**(Publicado en `r publicacion_mes_anio` con datos actualizados al `r datos_mes_anio_bis`)**

El reporte de seguimiento mensual que acá presentamos se desprende del *[Documento de Trabajo N°11: "Conectividad Aérea. Diagnóstico turístico del mercado aerocomercial de Argentina."](https://tableros.yvera.tur.ar/recursos/biblioteca/conectividad_aerea.pdf)* que analiza el mercado aerocomercial del país en base a una lectura turística de la información. El período de análisis se extiende desde comienzos del 2017 hasta el primer trimestre de 2023. En este marco, el actual trabajo busca continuar con la publicación períodica de estadísticas que muestren la evolución de los indicadores luego de la crisis pandémica y la posterior recuperación del sector. En este sentido, por ejemplo, en el mes de **`r datos_mes_anio`**, **el mercado de cabotaje** nacional mostró **`r var_2019_vuelos` de vuelos, un `r var_2019_pasajeros` de pasajeros y un `r var_2019_asientos` de asientos en comparación al mismo mes de 2019**[^1].

[^1]: Por su parte, el **mercado internacional** resgistró un **`r int_var_2019_vuelos` de vuelos, un `r int_var_2019_pasajeros` de pasajeros y un `r int_var_2019_asientos` de asientos en respecto al mismo período**. Si bien dichos valores se encuentran debajo de los niveles prepandémicos, los mismos no distan de los indicadores a nivel regional. A su vez, se espera que en los próximos meses se reactiven viejos corredores detenidos durante la pandemia, se añadan nuevas frecuencias a las rutas existentes, y se incorporen nuevos actores y rutas al mercado - Ver Documento de Trabajo N°11.

## **CABOTAJE**

En el mes de **`r datos_mes_anio`**, se estimaron **`r vuelos_mes_total` vuelos de cabotaje** en todo el país, lo que representa **`r variacion_interanual` frente a un año atrás**[^2]. En total, en el acumulado anual, se realizaron `r vuelos_acumulados_total` vuelos, un `r variacion_interanual_acum` si se compara con el mismo período del año previo.

[^2]: Para ver la serie temporal completa de vuelos, asientos y pasajeros totales, acceder al [tablero de conectividad aérea](https://tableros.yvera.tur.ar/conectividad/).

```{r}
# # Vuelos
# graf_1 <- cabotaje %>% 
#   group_by(anio_local, mes_local) %>% 
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
#          frecuencias = round(frecuencias, 0)) %>% 
#   ggplot(aes(x = fecha,
#              y = frecuencias)) +
#   geom_line(color = dnmye_colores("cian"),
#             stat = "identity",
#             size = 1.25)+
#   geom_point(color = dnmye_colores("cian"),
#              fill = "white",
#              stat = "identity",
#              size = 2,
#              shape = 21)+
#     geom_point(data = cabotaje %>%
#                  group_by(anio_local, mes_local) %>%
#                  summarise(frecuencias = sum(vuelos, na.rm = T)) %>%
#                  mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
#                         frecuencias = round(frecuencias, 0)) %>% 
#                  filter(mes_local == 4),
#                color = dnmye_colores("rosa"),
#                fill = "white",
#                stat = "identity",
#                size = 2,
#                shape = 21)+
#   scale_y_continuous(limits = c(0,15000),
#                      breaks = seq(0, 15000, 1000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_x_date(date_breaks = "4 month", 
#                date_labels = "%b-%y")+
#   labs(title = "Vuelos de cabotaje",
#        y = "Cantidad",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC\n Nota: En rojo, los meses de abril.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1, 
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 1))
# 
# 
# ggplotly(graf_1)
```

En el mismo mes, fueron transportados **`r pasajeros_mes_total` pasajeros**, un `r variacion_interanual_pasajeros` con respecto a `r datos_mes_anio` del año previo. En el acumulado anual, ello significa que viajaron hasta el momento `r pasajeros_acumulados_total` personas, un `r variacion_interanual_acum_pasajeros` en comparación al mismo intervalo del año anterior.

Con respecto al número de **asientos** disponibles en vuelos comerciales, en `r datos_mes_anio`, fueron ofrecidos **`r asientos_mes_total` asientos**, lo que supone un `r variacion_interanual_asientos` contra un año atrás, y, en lo que va del año, `r asientos_acumulados_total` asientos, `r variacion_interanual_acum_asientos` frente al mismo período previo.

```{r}
# graf_2 <- cabotaje %>% 
#   group_by(anio_local, mes_local) %>% 
#   summarise(pasajeros = sum(pax_ad, na.rm = T),
#             asientos = sum(asientos_pax, na.rm = T)) %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
#   ggplot() +
#   geom_line(aes(x = fecha,
#                 y = pasajeros,
#                 color = "Pasajeros"),
#             stat = "identity",
#             size = 1.25)+
#   geom_line(aes(x = fecha,
#                 y = asientos,
#                 color = "Asientos"),
#             stat = "identity",
#             size = 1.25)+
#   geom_point(aes(x = fecha,
#                  y = pasajeros,
#                  color = "Pasajeros"),
#              fill = "white",
#              stat = "identity",
#              size = 2,
#              shape = 21)+
#   geom_point(aes(x = fecha,
#                  y = asientos,
#                  color = "Asientos"),
#              fill = "white",
#              stat = "identity",
#              size = 2,
#              shape = 21)+
#   scale_y_continuous(limits = c(0,2000000),
#                      breaks = seq(0, 2000000, 250000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_x_date(date_breaks = "4 month", 
#                date_labels = "%b-%y")+
#   scale_color_manual(values = c("Pasajeros" = dnmye_colores("cian"),
#                                 "Asientos" = dnmye_colores("rosa")))+
#   labs(title = "Vuelos de cabotaje",
#        y = "Cantidad",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1, 
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 1))
# 
# ggplotly(graf_2) %>% 
#   layout(legend = list(orientation = 'h',
#                        x = 0.4, y = -0.2))
```

```{r}
# graf_3 <- cabotaje %>% 
#   group_by(anio_local, mes_local) %>% 
#   summarise(pasajeros = sum(pax_ad, na.rm = T),
#             asientos = sum(asientos_pax, na.rm = T)) %>% 
#   mutate(factor_de_ocupacion = round(pasajeros/asientos*100, 1),
#          fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
#   ggplot(aes(x = fecha,
#              y = factor_de_ocupacion,
#              fill = month(fecha) == 4)) +
#   geom_bar(stat = "identity",
#            size = 1,
#            # fill = dnmye_colores("cian"),
#            color = "white", 
#            show.legend = F)+
#   # geom_bar(data = cabotaje %>% 
#   #            group_by(anio_local, mes_local) %>% 
#   #            summarise(pasajeros = sum(pax_ad, na.rm = T),
#   #                      asientos = sum(asientos_pax, na.rm = T)) %>% 
#   #            mutate(factor_de_ocupacion = round(pasajeros/asientos*100, 1),
#   #                   fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
#   #            filter(mes_local == 4),
#   #          stat = "identity",
#   #          size = 1,
#   #          fill = dnmye_colores("rosa"),
#   #          color = "white")+
#   scale_y_continuous(limits = c(0, 100),
#                      breaks = seq(0, 100, 10),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_date(date_breaks = "4 month", 
#                date_labels = "%b-%y")+
#   scale_fill_dnmye(palette = "cualitativa", reverse = -1)+
#   labs(title = "Vuelos de cabotaje",
#        subtitle = "Factor de ocupación",
#        y = "Promedio mensual",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.\n Nota: En rojo, los meses de abril.") +
#   theme_minimal() +
#   theme(legend.position = "none",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) 
# 
# ggplotly(graf_3)
```

```{r}
# graf_5 <- cabotaje %>% 
#   group_by(anio_local, mes_local, region_destino) %>% 
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
#          frecuencias = round(frecuencias, 0)) %>% 
#   ggplot(aes(x = fecha,
#              y = frecuencias)) +
#   geom_line(aes(color = region_destino),
#             stat = "identity",
#             size = 1.25,
#             alpha = 0.6)+
#   geom_point(aes(color = region_destino),
#              stat = "identity",
#              size = 1.5,
#              alpha = 0.6)+
#   scale_y_continuous(limits = c(0,10000),
#                      breaks = seq(0, 10000, 1000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_x_date(date_breaks = "3 month", date_labels = "%b-%y")+
#   scale_color_dnmye(palette = "cualitativa", reverse = -1)+
#   labs(title = "Vuelos de cabotaje por región de destino",
#        y = "Frecuencias aéreas totales",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 1))
# 
# ggplotly(graf_5) %>% 
#   layout(legend = list(orientation = 'h',
#               x = 0.05, y = -0.2))
```

```{r}
# graf_5_b <- cabotaje %>% 
#   group_by(anio_local, mes_local, region_destino) %>% 
#   summarise(frecuencias = sum(pax_ad, na.rm = T)) %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
#          frecuencias = round(frecuencias, 0)) %>% 
#   ggplot(aes(x = fecha,
#              y = frecuencias)) +
#   geom_line(aes(color = region_destino),
#             stat = "identity",
#             size = 1.25,
#             alpha = 0.6)+
#   geom_point(aes(color = region_destino),
#              stat = "identity",
#              size = 1.5,
#              alpha = 0.6)+
#   scale_y_continuous(limits = c(0,800000),
#                      breaks = seq(0, 800000, 100000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_x_date(date_breaks = "3 month", date_labels = "%b-%y")+
#   scale_color_dnmye(palette = "cualitativa", reverse = -1)+
#   labs(title = "Pasajeros transportados por región de destino",
#        y = "Pasajeros totales",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 1))
# 
# ggplotly(graf_5_b) %>% 
#   layout(legend = list(orientation = 'h',
#                        x = -0.025, y = -0.2))
```


```{r}
# graf_6 <- cabotaje %>% 
#   group_by(anio_local, mes_local, empresa_agrup_def) %>% 
#   summarise(total = n(),
#             frecuencias = sum(vuelos, na.rm = T)) %>%
#   filter(total > 4) %>%
#   filter(empresa_agrup_def %in% c("Aerolíneas Argentinas",
#                                   "LADE - Líneas Aéreas Del Estado",
#                                   "Flybondi",
#                                   "JetSMART Airlines")) %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
#          frecuencias = round(frecuencias, 0)) %>%
#   filter(fecha>= dmy("01-10-2019")) %>% 
#   ggplot(aes(x = fecha,
#              y = frecuencias)) +
#   geom_line(aes(color = empresa_agrup_def),
#             stat = "identity",
#             size = 1.25,
#             alpha = 0.6)+
#   geom_point(aes(color = empresa_agrup_def),
#              stat = "identity",
#              size = 1.5,
#              alpha = 0.7)+
#   scale_y_continuous(limits = c(0,10000),
#                      breaks = seq(0, 10000, 1000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_color_manual(values = colores_aero)+
#   scale_x_date(date_breaks = "3 month", date_labels = "%b-%y")+
#   labs(title = "Vuelos de cabotaje por aerolínea",
#        y = "Frecuencias aéreas totales",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 1))
# 
# ggplotly(graf_6) %>% 
#   layout(legend = list(orientation = 'h',
#                        x = -0.05, y = -0.2))
```

```{r}
# graf_7 <- cabotaje %>%
#   group_by(anio_local, mes_local, empresa_agrup_def) %>%
#   summarise(total = n(),
#             pasajeros = sum(pax_ad, na.rm = T)) %>%
#   filter(total > 4) %>%
#   filter(empresa_agrup_def %in% c("Aerolíneas Argentinas",
#                                   "LADE - Líneas Aéreas Del Estado",
#                                   "Flybondi",
#                                   "JetSMART Airlines")) %>%
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
#          pasajeros = round(pasajeros)) %>%
#   filter(fecha>= dmy("01-10-2019")) %>%
#   ggplot(aes(x = fecha,
#              y = pasajeros)) +
#   geom_line(aes(color = empresa_agrup_def),
#             stat = "identity",
#             size = 1.25,
#             alpha = 0.6)+
#   geom_point(aes(color = empresa_agrup_def),
#              stat = "identity",
#              size = 1.5,
#              alpha = 0.6)+
#   scale_x_date(date_breaks = "3 month", date_labels = "%b-%y")+
#   scale_y_continuous(limits = c(0,1000000),
#                      breaks = seq(0, 1000000, 100000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_color_manual(values = colores_aero)+
#   labs(title = "Vuelos de cabotaje",
#        y = "Pasajeros totales",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 1))
# 
# ggplotly(graf_7) %>%
#   layout(legend = list(orientation = 'h',
#                        x = -0.05, y = -0.2))

```

```{r}
# graf_8 <- cabotaje %>% 
#   group_by(anio_local, mes_local, empresa_agrup_def) %>% 
#   summarise(total = n(),
#             asientos = sum(asientos_pax, na.rm = T)) %>%
#   filter(total > 4) %>%
#   filter(empresa_agrup_def %in% c("Aerolíneas Argentinas",
#                                   "LADE - Líneas Aéreas Del Estado",
#                                   "Flybondi",
#                                   "JetSMART Airlines")) %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
#          asientos = round(asientos)) %>%
#   filter(fecha >= dmy("01-10-2019")) %>% 
#   ggplot(aes(x = fecha,
#              y = asientos)) +
#   geom_line(aes(color = empresa_agrup_def),
#             stat = "identity",
#             size = 1.25,
#             alpha = 0.6)+
#   geom_point(aes(color = empresa_agrup_def),
#              stat = "identity",
#              size = 1.5,
#              alpha = 0.6)+
#   scale_x_date(date_breaks = "3 month", date_labels = "%b-%y")+
#   scale_y_continuous(limits = c(0,1200000),
#                      breaks = seq(0, 1200000, 100000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_color_manual(values = colores_aero)+
#   labs(title = "Asientos por aerolínea",
#        y = "Total",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 1))
# 
# ggplotly(graf_8) %>% 
#   layout(legend = list(orientation = 'h',
#                        x = -0.05, y = -0.2))
```

```{r}
# graf_7 <- cabotaje %>% 
#   group_by(anio_local, mes_local, empresa_agrup_def) %>% 
#   summarise(pasajeros = sum(pax_ad, na.rm = T),
#             asientos = sum(asientos_pax, na.rm = T)) %>%
#   filter(empresa_agrup_def %in% c("Aerolíneas Argentinas",
#                                   "LADE - Líneas Aéreas Del Estado",
#                                   "Flybondi",
#                                   "JetSMART Airlines")) %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>%
#   filter(fecha>= dmy("01-10-2019")) %>%  
#   pivot_longer(c("asientos", "pasajeros"), names_to = "dato", values_to = "totales") %>% 
#   mutate(dato = str_to_title(dato)) %>% 
#   ggplot(aes(x = fecha,
#              y = totales)) +
#   geom_line(aes(color = empresa_agrup_def),
#             stat = "identity",
#             size = 0.75, 
#             alpha = 0.6)+
#   geom_point(aes(color = empresa_agrup_def),
#              stat = "identity",
#              size = 1.25,
#              alpha = 0.6)+
#   scale_x_date(date_breaks = "3 month", 
#                date_labels = "%b-%y")+
#   scale_y_continuous(limits = c(0,1250000),
#                      breaks = seq(0, 1250000, 250000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_color_manual(values = colores_aero)+
#   labs(title = "Vuelos de cabotaje",
#        subtitle = "Asientos y pasajeros por aerolínea",
#        y = "",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1),
#         strip.text = element_text(face = "bold")) +
#   guides(color = guide_legend(nrow = 1))+
#   facet_wrap(~ dato,
#              scales = "free",
#              ncol = 1)
# 
# ggplotly(graf_7) %>%
#   layout(legend = list(orientation = 'h',
#                        x = -0.05, y = -0.2))
```

```{r}
# socoso1 <- cabotaje %>% 
#   filter(mes_local == month(max(cabotaje$Fecha)))  %>%
#   group_by(anio_local, destino_provincia_etiqueta) %>%
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>%
#   group_by(anio_local) %>%
#   mutate(cuota = frecuencias/sum(frecuencias, na.rm = T)
#   ) %>%
#   ungroup() %>% 
#   select(anio_local, destino_provincia_etiqueta, cuota)
# 
# socoso2 <- socoso1 %>% 
#   group_by(anio_local) %>% 
#   summarise(herfindahl =  (sum(cuota^2, na.rm = T) - 1/n())/(1 - 1/n())) %>% 
#   mutate(destino_provincia_etiqueta = "Índice de Herfindahl") %>% 
#   pivot_wider(names_from = anio_local, values_from =  herfindahl, names_prefix = "cuota_")
# 
# socoso_total <- socoso1 %>% 
#   pivot_wider(names_from = anio_local, values_from =  cuota, names_prefix = "cuota_") %>% 
#   arrange(-cuota_2017) %>% 
#   bind_rows(socoso2)
# 
# socoso_total %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__VUELOS DE CABOTAJE POR PROVINCIA DE DESTINO__"),
#     subtitle = md("__Marzo__")) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     destino_provincia_etiqueta = md("**Provincia**"),
#     cuota_2017 = md("**2017**"),
#     cuota_2018 = md("**2018**"),
#     cuota_2019 = md("**2019**"),
#     cuota_2020 = md("**2020**"),
#     cuota_2021 = md("**2021**"),
#     cuota_2022 = md("**2022**"),
#     cuota_2023 = md("**2023**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:8))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(2:8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = dnmye_colores("gris claro"))),
#     locations = cells_body(
#       rows = destino_provincia_etiqueta == "Índice de Herfindahl")) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")),
#     locations = cells_body(
#       rows = destino_provincia_etiqueta == "Índice de Herfindahl"))
```

```{r}
# socoso1 <- cabotaje %>% 
#   filter(mes_local == month(max(cabotaje$Fecha)))  %>%
#   group_by(anio_local, destino_provincia_etiqueta) %>%
#   summarise(pasajeros = sum(pax_ad, na.rm = T)) %>%
#   group_by(anio_local) %>%
#   mutate(cuota = pasajeros/sum(pasajeros, na.rm = T)
#   ) %>%
#   ungroup() %>% 
#   select(anio_local, destino_provincia_etiqueta, cuota)
# 
# socoso2 <- socoso1 %>% 
#   group_by(anio_local) %>% 
#   summarise(herfindahl =  (sum(cuota^2, na.rm = T) - 1/n())/(1 - 1/n())) %>% 
#   mutate(destino_provincia_etiqueta = "Índice de Herfindahl") %>% 
#   pivot_wider(names_from = anio_local, values_from =  herfindahl, names_prefix = "cuota_")
# 
# socoso_total <- socoso1 %>% 
#   pivot_wider(names_from = anio_local, values_from =  cuota, names_prefix = "cuota_") %>% 
#   arrange(-cuota_2017) %>% 
#   bind_rows(socoso2)
# 
# socoso_total %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__PASAJEROS POR PROVINCIA DE DESTINO__"),
#     subtitle = md("__Marzo__")) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     destino_provincia_etiqueta = md("**Provincia**"),
#     cuota_2017 = md("**2017**"),
#     cuota_2018 = md("**2018**"),
#     cuota_2019 = md("**2019**"),
#     cuota_2020 = md("**2020**"),
#     cuota_2021 = md("**2021**"),
#     cuota_2022 = md("**2022**"),
#     cuota_2023 = md("**2023**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:8))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(2:8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = dnmye_colores("gris claro"))),
#     locations = cells_body(
#       rows = destino_provincia_etiqueta == "Índice de Herfindahl")) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")),
#     locations = cells_body(
#       rows = destino_provincia_etiqueta == "Índice de Herfindahl"))
```

```{r}
# socoso_aero1 <- cabotaje %>% 
#   filter(mes_local == month(max(cabotaje$Fecha)))  %>%
#   filter(empresa_agrup_def %in% c("LATAM",
#                                   "Norwegian Air Shuttle",
#                                   "JetSMART Airlines",
#                                   "Aerolíneas Argentinas",
#                                   "Flybondi",
#                                   "Andes Líneas Aéreas",
#                                   "Avianca",
#                                   "LADE - Líneas Aéreas Del Estado")) %>% 
#   mutate(empresa_agrup_def = as.factor(empresa_agrup_def)) %>% 
#   group_by(anio_local, empresa_agrup_def, .drop = F) %>%
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>%
#   group_by(anio_local) %>%
#   mutate(cuota = frecuencias/sum(frecuencias, na.rm = T)
#   ) %>%
#   ungroup() %>% 
#   select(anio_local, empresa_agrup_def, cuota)
# 
# socoso_aero2 <- socoso_aero1 %>% 
#   group_by(anio_local) %>% 
#   summarise(herfindahl =  (sum(cuota^2, na.rm = T) - 1/n())/(1 - 1/n())) %>% 
#   mutate(empresa_agrup_def = "Índice de Herfindahl") %>% 
#   pivot_wider(names_from = anio_local, values_from =  herfindahl, names_prefix = "cuota_")
# 
# socoso_total <- socoso_aero1 %>% 
#   pivot_wider(names_from = anio_local, values_from =  cuota, names_prefix = "cuota_") %>% 
#   bind_rows(socoso_aero2)
# 
# socoso_total %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__PARTICIPACIÓN POR COMPAÑÍA AÉREA EN EL MERCADO DE CABOTAJE (VUELOS)__"),
#     subtitle = md("__Marzo__"),
#   ) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     empresa_agrup_def = md("**Ciudad**"),
#     cuota_2017 = md("**2017**"),
#     cuota_2018 = md("**2018**"),
#     cuota_2019 = md("**2019**"),
#     cuota_2020 = md("**2020**"),
#     cuota_2021 = md("**2021**"),
#     cuota_2022 = md("**2022**"),
#     cuota_2023 = md("**2023**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:8))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(2:8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = dnmye_colores("gris claro"))),
#     locations = cells_body(
#       rows = empresa_agrup_def == "Índice de Herfindahl")) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")),
#     locations = cells_body(
#       rows = empresa_agrup_def == "Índice de Herfindahl")) %>% 
#   fmt_missing(
#     columns = everything(),
#     rows = everything(),
#     missing_text = "-")
```

```{r}
# socoso_aero1_pasajeros <- cabotaje %>% 
#   filter(mes_local == month(max(cabotaje$Fecha)))  %>%
#   filter(empresa_agrup_def %in% c("LATAM",
#                                   "Norwegian Air Shuttle",
#                                   "JetSMART Airlines",
#                                   "Aerolíneas Argentinas",
#                                   "Flybondi",
#                                   "Andes Líneas Aéreas",
#                                   "Avianca",
#                                   "LADE - Líneas Aéreas Del Estado")) %>% 
#   mutate(empresa_agrup_def = as.factor(empresa_agrup_def)) %>% 
#   group_by(anio_local, empresa_agrup_def, .drop = F) %>%
#   summarise(pasajeros = sum(pax_ad, na.rm = T)) %>%
#   group_by(anio_local) %>%
#   mutate(cuota = pasajeros/sum(pasajeros, na.rm = T)
#   ) %>%
#   ungroup() %>% 
#   select(anio_local, empresa_agrup_def, cuota)
# 
# socoso_aero2_pasajeros <- socoso_aero1_pasajeros %>% 
#   group_by(anio_local) %>% 
#   summarise(herfindahl =  (sum(cuota^2, na.rm = T) - 1/n())/(1 - 1/n())) %>% 
#   mutate(empresa_agrup_def = "Índice de Herfindahl") %>% 
#   pivot_wider(names_from = anio_local, values_from =  herfindahl, names_prefix = "cuota_")
# 
# socoso_aero_total <- socoso_aero1_pasajeros %>% 
#   pivot_wider(names_from = anio_local, values_from = cuota, names_prefix = "cuota_") %>% 
#   bind_rows(socoso_aero2_pasajeros)
# 
# socoso_aero_total %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__CUOTA DE MERCADO DE CABOTAJE POR AEROLÍNEA__"),
#     subtitle = "Sobre el total de pasajeros en el mes",
#   ) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     empresa_agrup_def = md("**Aerolínea**"),
#     cuota_2017 = md("**2017**"),
#     cuota_2018 = md("**2018**"),
#     cuota_2019 = md("**2019**"),
#     cuota_2020 = md("**2020**"),
#     cuota_2021 = md("**2021**"),
#     cuota_2022 = md("**2022**"),
#     cuota_2023 = md("**2023**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:8))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(2:8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = dnmye_colores("gris claro"))),
#     locations = cells_body(
#       rows = empresa_agrup_def == "Índice de Herfindahl")) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")),
#     locations = cells_body(
#       rows = empresa_agrup_def == "Índice de Herfindahl")) %>% 
#   fmt_missing(
#     columns = everything(),
#     rows = everything(),
#     missing_text = "-") 
```

```{r}
# socoso_aero1_asientos <- cabotaje %>% 
#   filter(mes_local == month(max(cabotaje$Fecha)))  %>%
#   filter(empresa_agrup_def %in% c("LATAM",
#                                   "Norwegian Air Shuttle",
#                                   "JetSMART Airlines",
#                                   "Aerolíneas Argentinas",
#                                   "Flybondi",
#                                   "Andes Líneas Aéreas",
#                                   "Avianca",
#                                   "LADE - Líneas Aéreas Del Estado")) %>% 
#   mutate(empresa_agrup_def = as.factor(empresa_agrup_def)) %>% 
#   group_by(anio_local, empresa_agrup_def, .drop = F) %>%
#   summarise(asientos = sum(asientos_pax, na.rm = T)) %>%
#   group_by(anio_local) %>%
#   mutate(cuota = asientos/sum(asientos, na.rm = T)
#   ) %>%
#   ungroup() %>% 
#   select(anio_local, empresa_agrup_def, cuota)
# 
# socoso_aero2_asientos <- socoso_aero1_asientos %>% 
#   group_by(anio_local) %>% 
#   summarise(herfindahl =  (sum(cuota^2, na.rm = T) - 1/n())/(1 - 1/n())) %>% 
#   mutate(empresa_agrup_def = "Índice de Herfindahl") %>% 
#   pivot_wider(names_from = anio_local, values_from =  herfindahl, names_prefix = "cuota_")
# 
# socoso_aero_total <- socoso_aero1_asientos %>% 
#   pivot_wider(names_from = anio_local, values_from = cuota, names_prefix = "cuota_") %>% 
#   bind_rows(socoso_aero2_asientos)
# 
# socoso_aero_total %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__PARTICIPACIÓN POR COMPAÑÍA AÉREA EN EL MERCADO DE CABOTAJE (ASIENTOS)__"),
#     subtitle = md("__Marzo__"),
#   ) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     empresa_agrup_def = md("**Ciudad**"),
#     cuota_2017 = md("**2017**"),
#     cuota_2018 = md("**2018**"),
#     cuota_2019 = md("**2019**"),
#     cuota_2020 = md("**2020**"),
#     cuota_2021 = md("**2021**"),
#     cuota_2022 = md("**2022**"),
#     cuota_2023 = md("**2023**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:8))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(2:8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = dnmye_colores("gris claro"))),
#     locations = cells_body(
#       rows = empresa_agrup_def == "Índice de Herfindahl")) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")),
#     locations = cells_body(
#       rows = empresa_agrup_def == "Índice de Herfindahl")) %>% 
#   fmt_missing(
#     columns = everything(),
#     rows = everything(),
#     missing_text = "-"
#   )
```

```{r}
aerolineas_freq <- cabotaje %>% 
  filter(anio_local == max(anio_local)) %>% 
  filter(mes_local == max(mes_local)) %>% 
  group_by(anio_local, mes_local, empresa_agrup_def) %>% 
  summarise(frecuencias = round(sum(vuelos, na.rm = T), 0)) %>% 
  filter(empresa_agrup_def %in% c("Aerolíneas Argentinas",
                                  "LADE - Líneas Aéreas Del Estado",
                                  "Flybondi",
                                  "JetSMART Airlines")) %>% 
  group_by(anio_local) %>% 
  mutate(frecuencias_totales = sum(frecuencias, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(pct = round(frecuencias/frecuencias_totales*100, 1)) %>% 
  arrange(-pct) %>% 
  select(-c(1:2)) 

primer_aero <- aerolineas_freq[1,1] %>% pull
segundo_aero <- aerolineas_freq[2,1] %>% pull
tercer_aero <- aerolineas_freq[3,1] %>% pull

freq_primer_aero <- aerolineas_freq[1,4] %>% pull %>% format(., decimal.mark = ",") %>% paste0(., "%")
freq_segundo_aero <- aerolineas_freq[2,4] %>% pull %>% format(., decimal.mark = ",") %>% paste0(., "%")
freq_tercer_aero <- aerolineas_freq[3,4] %>% pull %>% format(., decimal.mark = ",") %>% paste0(., "%")

freq_abs_primer_aero <- aerolineas_freq[1,2] %>% pull %>% format(., big.mark = ".") 
freq_abs_segundo_aero <- aerolineas_freq[2,2] %>% pull %>% format(., big.mark = ".") 
freq_abs_tercer_aero <- aerolineas_freq[3,2] %>% pull %>% format(., big.mark = ".") 

```

**`r primer_aero`** fue la compañía aérea que realizó la mayor cantidad de vuelos de cabotaje (`r freq_abs_primer_aero`) en `r datos_mes_anio`, explicando el **`r freq_primer_aero` de las frecuencias aéreas**. Le siguen `r segundo_aero` con `r freq_segundo_aero` (`r freq_abs_segundo_aero` frecuencias) y `r tercer_aero` con `r freq_tercer_aero` (`r freq_abs_tercer_aero`).

```{r}
graf_7 <- cabotaje %>% 
  group_by(anio_local, mes_local, empresa_agrup_def) %>% 
  summarise(total = n(),
            frecuencias = sum(vuelos, na.rm = T)) %>%
  filter(empresa_agrup_def %in% c("Aerolíneas Argentinas",
                                  "LADE - Líneas Aéreas Del Estado",
                                  "Flybondi",
                                  "JetSMART Airlines")) %>% 
  mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
         frecuencias = round(frecuencias, 0)) %>%
  filter(fecha>= dmy("01-10-2019")) %>% 
  ggplot(aes(x = fecha,
             y = frecuencias)) +
  geom_line(aes(color = empresa_agrup_def),
            stat = "identity",
            size = 1.25,
            alpha = 0.6)+
  geom_point(aes(color = empresa_agrup_def,
                 text = paste("Fecha:",
                          format(fecha,"%b-%y <br>"),
                          glue::glue("{empresa_agrup_def}"), 
                          "<br> Total:",
                          format(frecuencias,
                                                           big.mark=".", decimal.mark = ",", digits=0))),
             stat = "identity",
             size = 1.5,
             alpha = 0.7)+
  scale_y_continuous(limits = c(0,10000),
                     breaks = seq(0, 10000, 1000),
                     labels = function(x) format(x, big.mark = ".")) +
  scale_color_manual(values = colores_aero)+
  scale_x_date(date_breaks = "3 month", 
               date_labels = "%b-%y")+
  labs(title = "Vuelos de cabotaje",
       subtitle = "Por aerolínea",
       y = "",
       x = "",
       color = "",
       caption = "Fuente: MINTURDEP en base a información de ANAC.") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1)) +
  guides(color = guide_legend(nrow = 1))

ggplotly(graf_7, tooltip = "text") %>%
  layout(legend = list(orientation = 'h',
                       x = -0.05, y = -0.2))
```

```{r}
rank_provs <- cabotaje %>% 
  filter(fecha_month == max(fecha_month)) %>%
  group_by(destino_provincia_etiqueta) %>% 
  summarise(vuelos = sum(vuelos, na.rm = T)) %>%
  arrange(-vuelos) %>% 
  top_n(3) 

primer_rank_prov <- rank_provs[1,1] %>% pull
segun_rank_prov <- rank_provs[2,1] %>% pull
tercer_rank_prov <- rank_provs[3,1] %>% pull

```

Las provincias de **`r primer_rank_prov`, `r segun_rank_prov` y `r tercer_rank_prov`** son aquellas que **más vuelos de cabotaje recibieron** durante el último mes.

```{r, fig.height=8}
herfintal_prov_empre <- cabotaje %>% 
  filter(anio_local != 2014 & mes_local == month(max(cabotaje$Fecha))) %>%
  filter(empresa_agrup_def %in% c("JetSMART Airlines",
                                  "Aerolíneas Argentinas",
                                  "Flybondi",
                                  "LADE - Líneas Aéreas Del Estado")) %>% 
  group_by(anio_local) %>% 
  mutate(frecuencias_anuales = sum(vuelos, na.rm = T)) %>%
  ungroup() %>% 
  group_by(anio_local, destino_provincia_etiqueta, frecuencias_anuales, .drop = F) %>%
  mutate(frecuencias_totales_prov = sum(vuelos, na.rm = T)) %>%
  group_by(anio_local) %>% 
  mutate(frecs_standar = log(frecuencias_totales_prov),
         frecs_standar = scales::rescale(frecs_standar, to = c(1.15, 2.15))) %>%  
  ungroup() %>% 
  group_by(anio_local, empresa_agrup_def) %>% 
  mutate(frecuencias_anuales_aerolineas = sum(vuelos, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(peso_aerolineas = round(frecuencias_anuales_aerolineas/frecuencias_anuales, 3)) %>% 
  group_by(anio_local, empresa_agrup_def, destino_provincia_etiqueta) %>% 
  summarise(frecuencias_x_destino_aerolinea = sum(vuelos, na.rm = T),
            frecuencias_x_destino_aerolinea_prop = frecuencias_x_destino_aerolinea/frecuencias_totales_prov,
            frecuencias_anuales_aerolineas = frecuencias_anuales_aerolineas,
            frecuencias_totales_prov = frecuencias_totales_prov,
            frecuencias_anuales = frecuencias_anuales,
            peso_aerolineas = peso_aerolineas,
            frecs_standar = frecs_standar,
            peso_destino_aerolinea = frecuencias_x_destino_aerolinea/frecuencias_anuales_aerolineas) %>%
  unique() %>% 
  group_by(anio_local, empresa_agrup_def) %>% 
  mutate(herfindahl = round((sum(peso_destino_aerolinea^2) - 1/24)/(1 - 1/24), 3),
         federalizacion = 1 - herfindahl)

herfintal_prov_empre_2023 <- cabotaje %>% 
  filter(anio_local == year(max(cabotaje$Fecha)) - 1 & mes_local == month(max(cabotaje$Fecha))) %>%
  group_by(destino_provincia_etiqueta, .drop = F) %>%
  summarise(freq_totaltes_prov = sum(vuelos, na.rm = T)) %>%
  arrange(-freq_totaltes_prov) %>% 
  mutate(orden = 1 : n()) %>% 
  select(destino_provincia_etiqueta, orden)

herfintal_prov_empre %>%
  filter(anio_local %in% c(year(max(cabotaje$Fecha)) - 1, year(max(cabotaje$Fecha)))) %>%
  ungroup() %>%
  complete(anio_local,
           destino_provincia_etiqueta,
           fill = list(frecuencias_x_destino_aerolinea = 0,
                       frecuencias_x_destino_aerolinea_prop = 0,
                       frecuencias_anuales_aerolineas = 0,
                       frecuencias_anuales_aerolineas = 0,
                       frecuencias_totales_prov = 0,
                       frecuencias_anuales = 0,
                       peso_aerolineas = 0,
                       peso_destino_aerolinea = 0,
                       frecs_standar = 0,
                       herfindahl = 0,
                       herfintal_prov_empre_2022 = 0,
                       federalizacion = 0)) %>% 
  left_join(herfintal_prov_empre_2023) %>% 
  complete(fill = list(orden = 24)) %>%
  ggplot() +
  geom_segment(aes(x = fct_reorder(as.factor(destino_provincia_etiqueta), -orden),
                   xend = fct_reorder(as.factor(destino_provincia_etiqueta), -orden),
                   y = 0,
                   yend = frecs_standar),
               color = "black",
               lineend = "round",
               linetype = "dashed") +
  geom_point(aes(x = fct_reorder(as.factor(destino_provincia_etiqueta), -orden), 
                 y = frecs_standar)) +
  geom_label(aes(x = fct_reorder(as.factor(destino_provincia_etiqueta), -orden), 
                 y = frecs_standar, label = round(frecuencias_totales_prov, 0)),
             hjust = -.25,
             size = 3.25) +
  geom_bar(aes(fill = empresa_agrup_def,
               y = frecuencias_x_destino_aerolinea_prop,
               x = fct_reorder(as.factor(destino_provincia_etiqueta), -orden)),
           position= position_fill(), stat="identity", ) +
  scale_fill_manual(values = c("Aerolíneas Argentinas" = "steelblue2",
                               "JetSMART Airlines" = "midnightblue",
                               "Flybondi" = "gold1",
                               "LADE - Líneas Aéreas Del Estado" = "grey88"))+
  scale_x_discrete(labels = function(destino_provincia_etiqueta) str_wrap(destino_provincia_etiqueta, width = 35))+
  scale_y_continuous(limits = c(0, 3),
                     labels = scales::number_format(big.mark = ".", decimal.mark = ","))+
  labs(title = "Vuelos de cabotaje por provincia de destino",
       subtitle = glue::glue("{str_to_title(strftime(max(base_total$Fecha), '%B'))}"),
       x = "",
       y = "",
       fill  = "Proporción de vuelos realizados\npor aerolínea sobre el total")+
  coord_flip() +
  facet_wrap(~ anio_local) +
  theme_light()+
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 8,
                                   face = "bold")) +
  guides(fill = guide_legend(nrow = 2))

```

```{r}
# herfintal_prov_empre %>% 
#   left_join(herfintal_prov_empre_2021) %>% 
#   filter(anio_local %in% c(year(max(cabotaje$Fecha)) - 2, year(max(cabotaje$Fecha)) - 1, year(max(cabotaje$Fecha)))) %>% 
#     filter(empresa_agrup_def %in% c("JetSMART Airlines",
#                                   "Aerolíneas Argentinas",
#                                   "Flybondi",
#                                   "LADE - Líneas Aéreas Del Estado")) %>% 
# ggplot()+
#   geom_bar(aes(fill = empresa_agrup_def,
#                y = frecuencias_x_destino_aerolinea,
#                x = fct_reorder(as.factor(destino_provincia_etiqueta), -orden)),
#            position= position_fill(),
#            stat="identity",
#            width =  0.75) +
#   scale_fill_manual(values = c("Aerolíneas Argentinas" = "steelblue2",
#                                "JetSMART Airlines" = "midnightblue",
#                                "Flybondi" = "gold1",
#                                "LADE - Líneas Aéreas Del Estado" = "grey88"))+
#   scale_x_discrete(labels = function(destino_provincia_etiqueta) str_wrap(destino_provincia_etiqueta, width = 35))+
#   labs(title = "Proporción de vuelos realizados por aerolínea sobre el total",
#        x = "",
#        y = "",
#        fill  = "")+
#   theme_light()+
#   theme(legend.position = "bottom") +
#   facet_wrap(~ anio_local)+
#   coord_flip() +
#   guides(fill = guide_legend(nrow = 1))
```

```{r}
# herfintal_prov_empre_pasajeros <- cabotaje %>% 
#   filter(anio_local != 2014 & mes_local == month(max(cabotaje$Fecha))) %>%
#   filter(empresa_agrup_def %in% c("JetSMART Airlines",
#                                   "Aerolíneas Argentinas",
#                                   "Flybondi",
#                                   "LADE - Líneas Aéreas Del Estado")) %>% 
#   group_by(anio_local) %>% 
#   mutate(Pax_anuales = sum(pax_ad, na.rm = T)) %>% 
#   ungroup() %>% 
#   group_by(anio_local, destino_provincia_etiqueta, Pax_anuales, .drop = F) %>% 
#   mutate(Pax_totales_prov = sum(pax_ad, na.rm = T)) %>% 
#   group_by(anio_local) %>% 
#   mutate(Pax_standar = scales::rescale(log(Pax_totales_prov), to = c(1.15, 2.15))) %>%  
#   ungroup() %>% 
#   group_by(anio_local, empresa_agrup_def) %>% 
#   mutate(Pax_anuales_aerolineas = sum(pax_ad, na.rm = T)) %>% 
#   ungroup() %>% 
#   mutate(peso_aerolineas = round(Pax_anuales_aerolineas/Pax_anuales, 3)) %>% 
#   group_by(anio_local, empresa_agrup_def, destino_provincia_etiqueta) %>% 
#   summarise(Pax_x_destino_aerolinea = sum(pax_ad, na.rm = T),
#             Pax_x_destino_aerolinea_prop = Pax_x_destino_aerolinea/Pax_totales_prov,
#             Pax_anuales_aerolineas = Pax_anuales_aerolineas,
#             Pax_totales_prov = Pax_totales_prov,
#             Pax_anuales = Pax_anuales,
#             peso_aerolineas = peso_aerolineas,
#             Pax_standar = Pax_standar,
#             peso_destino_aerolinea = Pax_x_destino_aerolinea/Pax_anuales_aerolineas) %>%
#   unique() %>% 
#   group_by(anio_local, empresa_agrup_def) %>% 
#   mutate(herfindal = round((sum(peso_destino_aerolinea^2) - 1/24)/(1 - 1/24), 3),
#          federalizacion = 1 - herfindal)
# 
# herfintal_prov_empre_2021_pasajeros <- cabotaje %>% 
#   filter(empresa_agrup_def %in% c("JetSMART Airlines",
#                                   "Aerolíneas Argentinas",
#                                   "Flybondi",
#                                   "LADE - Líneas Aéreas Del Estado")) %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) - 2 & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(destino_provincia_etiqueta) %>%
#   summarise(Pax_totaltes_prov = sum(pax_ad, na.rm = T)) %>% 
#   arrange(-Pax_totaltes_prov) %>% 
#   mutate(orden = 1 : n()) %>% 
#   select(destino_provincia_etiqueta, orden)
# 
# herfintal_prov_empre_pasajeros %>% 
#   left_join(herfintal_prov_empre_2021_pasajeros) %>% 
#   filter(anio_local %in% c(year(max(cabotaje$Fecha)) - 2, year(max(cabotaje$Fecha)) - 1, year(max(cabotaje$Fecha)))) %>% 
#   ggplot() +
#   geom_segment(aes(x = fct_reorder(as.factor(destino_provincia_etiqueta), -orden),
#                    xend = fct_reorder(as.factor(destino_provincia_etiqueta), -orden),
#                    y = 0,
#                    yend = Pax_standar),
#                color = "black",
#                lineend = "round",
#                linetype = "dashed") +
#   geom_point(aes(x = fct_reorder(as.factor(destino_provincia_etiqueta), -orden), 
#                  y = Pax_standar)) +
#   geom_label(aes(x = fct_reorder(as.factor(destino_provincia_etiqueta), -orden), 
#                  y = Pax_standar, label = str_squish(format(round(Pax_totales_prov, 0), big.mark = "."))), hjust = -.25,
#              size = 3) +
#   geom_bar(aes(fill = empresa_agrup_def,
#                y = Pax_x_destino_aerolinea_prop,
#                x = fct_reorder(as.factor(destino_provincia_etiqueta), -orden)),
#            position = position_fill(), stat="identity") +
#   scale_fill_manual(values = c("Aerolíneas Argentinas" = "steelblue2",
#                                "JetSMART Airlines" = "midnightblue",
#                                "Flybondi" = "gold1",
#                                "LADE - Líneas Aéreas Del Estado" = "grey88"))+
#   scale_x_discrete(labels = function(destino_provincia_etiqueta) str_wrap(destino_provincia_etiqueta, width = 35))+
#   scale_y_continuous(limits = c(0, 3))+
#   labs(title ="Distribución de los pasajeros transportados por provincia de destino",
#        subtitle = "Marzo",
#        x = "",
#        y = "Pasajeros anuales",
#        fill  = "Proporción de pasajeros transportados\npor aerolínea sobre el total")+
#   coord_flip() +
#   facet_wrap(~ anio_local) +
#   theme_light()+
#   theme(legend.position = "bottom",
#         axis.text.x = element_blank()) +
#   guides(fill = guide_legend(nrow = 2))
```

```{r}
# cabotaje %>% 
#   filter(anio_local == c(2022, 2023)) %>% 
#   group_by(anio_local, region_destino) %>% 
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>% 
#   group_by(anio_local) %>% 
#   mutate(frecuencias_totales = sum(frecuencias, na.rm = T)) %>% 
#   ungroup() %>% 
#   mutate(pct = round(frecuencias/frecuencias_totales*100, 1)) %>% 
#   ggplot(aes(x = reorder(region_destino, -frecuencias), y = pct)) +
#   geom_bar(aes(fill = region_destino),
#            stat = "identity",
#            show.legend = F,
#            color = "black") +
#   geom_label(aes(label = paste0(format(pct, decimal.mark = ","), "%"), vjust = -.5),
#             size = 2.5) +
#   facet_grid(~ anio_local) +
#   scale_y_continuous(limits = c(0, 50),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_discrete(labels = function(empresa_agrup_def) str_wrap(empresa_agrup_def, width = 10))+
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Frecuencias aéreas de vuelos de cabotaje por región de destino.",
#        #subtitle = "Años 2019/2021",
#        y = "Distribución porcentual",
#        x = "Regiones",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal()
```

```{r}
# freq_reg_prov_loc <- cabotaje %>% 
#   filter(anio_local == year(max(cabotaje$Fecha))) %>% 
#   mutate(region_origen = case_when(origen_provincia_etiqueta == "Buenos Aires" ~ "Buenos Aires",
#                                    origen_provincia_etiqueta == "Ciudad Autónoma de Buenos Aires" ~ "AMBA",
#                                    origen_provincia_etiqueta == "Córdoba" ~ "Córdoba",
#                                    origen_provincia_etiqueta == "Tierra del Fuego, Antártida e Islas del Atlántico Sur" ~ "Patagonia",
#                                    origen_provincia_etiqueta == "Santa Cruz" ~ "Patagonia",
#                                    origen_provincia_etiqueta == "Chubut" ~ "Patagonia",
#                                    origen_provincia_etiqueta == "Neuquén" ~ "Patagonia",
#                                    origen_provincia_etiqueta == "Río Negro" ~ "Patagonia",
#                                    origen_provincia_etiqueta == "La Pampa" ~ "Patagonia",
#                                    origen_provincia_etiqueta == "Mendoza" ~ "Cuyo",
#                                    origen_provincia_etiqueta == "San Juan" ~ "Cuyo",
#                                    origen_provincia_etiqueta == "San Luis" ~ "Cuyo",
#                                    origen_provincia_etiqueta == "La Rioja" ~ "Norte",
#                                    origen_provincia_etiqueta == "Catamarca" ~ "Norte",
#                                    origen_provincia_etiqueta == "Salta" ~ "Norte",
#                                    origen_provincia_etiqueta == "Jujuy" ~ "Norte",
#                                    origen_provincia_etiqueta == "Santiago del Estero" ~ "Norte",
#                                    origen_provincia_etiqueta == "Tucumán" ~ "Norte",
#                                    origen_provincia_etiqueta == "Santa Fe" ~ "Litoral",
#                                    origen_provincia_etiqueta == "Chaco" ~ "Litoral",
#                                    origen_provincia_etiqueta == "Formosa" ~ "Litoral",
#                                    origen_provincia_etiqueta == "Misiones" ~ "Litoral",
#                                    origen_provincia_etiqueta == "Corrientes" ~ "Litoral",
#                                    origen_provincia_etiqueta == "Entre Ríos" ~ "Litoral",
#                                    T ~ "No hay info"),
#          region_origen = case_when(origen_aeropuerto_etiqueta %in% c("Aeropuerto Int. Ministro Pistarini", "Aeropuerto Int. de San Fernando", "Aeropuerto El Palomar") ~ "AMBA",
#                                    T ~ region_origen)) %>% 
#   mutate(destino = paste(region_destino, destino_provincia_etiqueta, destino_localidad_etiqueta, sep = "-"),
#          origen = paste(region_origen, origen_provincia_etiqueta, origen_localidad_etiqueta, sep = "-")) %>% 
#   pivot_longer(cols = c(destino, origen),
#                names_to = "variables",
#                values_to = "origen_destino") %>%
#   select(mes_local, origen_destino, vuelos) %>% 
#   separate(origen_destino, 
#            into = c("region", "provincia", "localidad"),
#            sep = "-",
#            remove = T) %>% 
#   mutate(region = paste("Región", region)) %>% 
#   group_by(mes_local, region, provincia, localidad, .drop = F) %>% 
#   summarise(frecuencias = round(sum(vuelos, na.rm = T),0)) %>% 
#   mutate(mes_local = month(mes_local, label = T, abbr = F)) %>% 
#   pivot_wider(names_from = mes_local, values_from = frecuencias) %>%
#   ungroup() %>% 
#   mutate(across(.cols = c(4:5), ~ replace_na(., 0))) %>% 
#   filter(enero >= 8 & febrero >= 8) %>% 
#   janitor::adorn_totals()
# 
# freq_reg_prov_loc %>% 
#   group_by(region) %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__VUELOS DE CABOTAJE POR REGIÓN, PROVINCIA Y CIUDAD__"),
#     subtitle = "2023") %>%
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     provincia = md("**Provincia**"),
#     localidad = md("**Localidad**"),
#     enero = md("**Enero**"),
#     febrero = md("**Febrero**"),
#     marzo = md("**Marzo**")
#     # abril = md("**Abril**"),
#     # mayo = md("**Mayo**"),
#     # junio = md("**Junio**"),
#     # julio = md("**Julio**"),
#     # agosto = md("**Agosto**"),
#     # septiembre = md("**Septiembre**"),
#     # octubre = md("**Octubre**"),
#     # noviembre = md("**Noviembre**"),
#     # diciembre = md("**Diciembre**"),
#   ) %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   tab_style(style = cell_fill(color = dnmye_colores("gris claro")),
#             locations = cells_row_groups()) %>% 
#   tab_style(style = cell_text(weight = "bold"),
#             locations = cells_row_groups())
```

```{r}
rank_locs <- cabotaje %>% 
  filter(fecha_month == max(fecha_month)) %>%
  group_by(destino_localidad_etiqueta) %>% 
  summarise(vuelos = sum(vuelos, na.rm = T)) %>%
  arrange(-vuelos) %>% 
  top_n(3) 

primer_rank_loc <- rank_locs[1,1] %>% pull
segun_rank_loc <- rank_locs[2,1] %>% pull
tercer_rank_loc <- rank_locs[3,1] %>% pull
```

Por su parte, a nivel de localidad, **`r primer_rank_loc`, `r segun_rank_loc` y `r tercer_rank_loc`** son aquellas ciudades del país que más vuelos de cabotaje recibieron en el período.

```{r}
freq_ciudad_dest_24 <- cabotaje %>% 
  filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
  group_by(destino_localidad_etiqueta) %>% 
  summarise(frecuencias_24 = sum(vuelos, na.rm = T)) %>% 
  ungroup() %>% 
  arrange(desc(frecuencias_24)) %>% 
  mutate(posicion_24 = 1:n(),
         participacion_24 = frecuencias_24/sum(frecuencias_24, na.rm = T))

freq_ciudad_dest_23 <- cabotaje %>% 
  filter(anio_local == year(max(cabotaje$Fecha)) - 1 & mes_local == month(max(cabotaje$Fecha))) %>% 
  group_by(destino_localidad_etiqueta) %>% 
  summarise(frecuencias_23 = sum(vuelos, na.rm = T)) %>% 
  ungroup() %>% 
  arrange(desc(frecuencias_23)) %>% 
  mutate(posicion_23 = 1:n(),
         participacion_23 = frecuencias_23/sum(frecuencias_23, na.rm = T))

freq_ciudad_dest_24 <- freq_ciudad_dest_24 %>% 
  full_join(freq_ciudad_dest_23, by = "destino_localidad_etiqueta") %>%
  mutate(variacion = (frecuencias_24-frecuencias_23)/frecuencias_23,
         destino_localidad_etiqueta = case_when(posicion_24 >= 20 ~ "Resto",
                                                T ~ destino_localidad_etiqueta)) %>%
  group_by(destino_localidad_etiqueta) %>% 
  summarise(frecuencias_24 = sum(frecuencias_24, na.rm = T),
            frecuencias_23 = sum(frecuencias_23, na.rm = T),
            posicion_24 = first(posicion_24),
            posicion_23 = first(posicion_23)) %>% 
  mutate(variacion = (frecuencias_24-frecuencias_23)/frecuencias_23,
         participacion_24 = frecuencias_24/sum(frecuencias_24, na.rm = T),
         posicion_24 = case_when(destino_localidad_etiqueta == "Resto" ~ "-",
                                 T ~ as.character(posicion_24)),
         posicion_23 = case_when(destino_localidad_etiqueta == "Resto" ~ "-",
                                 T ~ as.character(posicion_23))) %>%
  arrange(-frecuencias_24)

resto <- freq_ciudad_dest_24 %>% 
  filter(destino_localidad_etiqueta == "Resto") %>% 
  mutate(situacion = "-")

freq_ciudad_dest_24 <- freq_ciudad_dest_24 %>% 
  filter(destino_localidad_etiqueta != "Resto") %>% 
  mutate(situacion = case_when(as.numeric(posicion_24) < as.numeric(posicion_23) ~ "▲",
                               as.numeric(posicion_24) > as.numeric(posicion_23) ~ "▼",
                               T ~ "=")) %>% 
  rbind(resto) %>% 
  drop_na(posicion_24) %>% 
  mutate(across(.cols = contains("frecuencias"), ~ round(., 0)),
         posicion_23 = if_else(is.na(posicion_23),
                               "-",
                               posicion_23))


col_order <- c("destino_localidad_etiqueta",
               "posicion_24",
               "situacion",
               "posicion_23",
               "frecuencias_24",
               "frecuencias_23",
               "variacion",
               "participacion_24")

freq_ciudad_dest_24 <- freq_ciudad_dest_24[, col_order]

freq_ciudad_dest_24[sapply(freq_ciudad_dest_24, is.infinite)] <- NA

freq_ciudad_dest_24 %>%
  gt() %>% 
  tab_header(
    title = md("__DESTINOS POR VUELOS DE CABOTAJE__"),
    subtitle = md(glue::glue("{str_to_title(strftime(max(base_total$Fecha), '%B'))}"))) %>%  
  tab_source_note(
    source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
  cols_label(
    destino_localidad_etiqueta = md("**Ciudad**"),
    posicion_23 = md("**2023**"),
    situacion = md(""),
    posicion_24 = md("**2024**"),
    frecuencias_23 = md("**2023**"),
    frecuencias_24 = md("**2024**"),
    variacion = md("**v.a. %**"),
    participacion_24 = md("**Participación 2024 (%)**")) %>% 
  cols_align(
    align = "center",
    columns = everything()) %>% 
  opt_table_font(
    font = list(
      google_font(name = "Encode Sans"))) %>% 
  fmt_percent(columns = c("variacion","participacion_24"), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
  tab_spanner(
    label = "Posición",
    columns = c("posicion_23", "situacion", "posicion_24")) %>% 
  tab_spanner(
    label = "Frecuencias",
    columns = c("frecuencias_23", "frecuencias_24")
  ) %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = cells_column_spanners(spanners = everything())
  ) %>%
  tab_style(
    style = list(
      cell_text(color = "#EE3D8F"),
      cell_text(weight  = "bold")
    ),
    locations = cells_body(
      columns = variacion,
      rows = variacion < 0)
  ) %>% 
  tab_style(
    style = list(
      cell_text(color = "#50B8B1"),
      cell_text(weight =  "bold")
    ),
    locations = cells_body(
      columns = variacion,
      rows = variacion > 0)) %>%
  tab_style(
    style = list(
      cell_text(color = "#EE3D8F"),
      cell_text(weight  = "bold")
    ),
    locations = cells_body(
      columns = situacion,
      rows = as.numeric(posicion_24) > as.numeric(posicion_23))
  ) %>% 
  tab_style(
    style = list(
      cell_text(color = "#50B8B1"),
      cell_text(weight =  "bold")
    ),
    locations = cells_body(
      columns = situacion,
      rows = as.numeric(posicion_24) < as.numeric(posicion_23))) %>% 
    sub_missing(
    columns = everything(),
    rows = everything(),
    missing_text = "-")
```

```{r}
# frq_linea_ciudad <- cabotaje %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   mutate(empresa_agrup_def = if_else(! empresa_agrup_def %in% c("Aerolíneas Argentinas",
#                                                                 "Flybondi",
#                                                                 "JetSMART Airlines"),
#                                      "Otras aerolíneas",
#                                      empresa_agrup_def)) %>% 
#   group_by(empresa_agrup_def, destino_localidad_etiqueta) %>% 
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>% 
#   pivot_wider(names_from = empresa_agrup_def, values_from = frecuencias) %>% 
#   mutate(across(.cols = c(2:5), ~ replace_na(., replace = 0))) %>% 
#   janitor::adorn_totals(where = "col") %>% 
#   arrange(-Total)
# 
# frq_linea_ciudad %>%
#   mutate(across(.cols = -destino_localidad_etiqueta, ~ round(., 0))) %>%
#   filter(Total >= 4) %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__RANKING DE VUELOS DE CABOTAJE POR CIUDAD DE DESTINO__"),
#     subtitle = md("__Marzo 2023__") ) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     destino_localidad_etiqueta = md("**Ciudad**"),
#     `Aerolíneas Argentinas` = md("**Aerolíneas Argentinas**"),
#     Flybondi = md("**Flybondi**"),
#     `JetSMART Airlines` = md("**JetSMART Airlines**"),
#     `Otras aerolíneas` = md("**Otras aerolíneas**"),
#     Total = md("**Total**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:6))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans")))

```

```{r}
# cabotaje %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   group_by(ruta_nombre) %>% 
#   summarise(total = sum(vuelos, na.rm = T)) %>% 
#   mutate(total = round(total, 0)) %>% 
#   arrange(-total) %>% 
#   top_n(20) %>% 
#   ggplot(aes(x = fct_reorder(ruta_nombre, total), y = total)) +
#   geom_bar(stat = "identity", fill = dnmye_colores("cian")) +
#   geom_label(aes(label = total),
#              hjust = 0.5) +
#   scale_y_continuous(limits = c(0, 1000),
#                      breaks = seq(0, 1000, 250))+
#   labs(title = "Top 20: Rutas aéreas más transitadas",
#        subtitle = "Abril 2023",
#        x = "",
#        y = "Vuelos")+
#   theme_minimal()+
#   coord_flip()

```

```{r}
# cabotaje %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   group_by(ruta_nombre) %>% 
#   summarise(total = sum(pax_ad, na.rm = T)) %>% 
#   arrange(-total) %>% 
#   mutate(posicion = row_number(),
#          ruta_nombre = case_when(posicion >= 20 ~ "Resto",
#                                  T ~ ruta_nombre)) %>%
#   group_by(ruta_nombre) %>% 
#   summarise(total = sum(total)) %>% 
#   mutate(total_vuelos = sum(total),
#          pct = total/total_vuelos*100,
#          pct = round(pct, 1)) %>% 
#   ggplot(aes(x = fct_reorder(ruta_nombre, total), y = pct)) +
#   geom_bar(stat = "identity", fill = dnmye_colores("cian")) +
#   geom_label(aes(label = paste0(format(pct, decimal.mark = ","),
#                                 "%")),
#              hjust = 0.5) +
#   # scale_y_continuous(limits = c(0, 40),
#   #                    breaks = seq(0, 40, 5))+
#   labs(title = "Rutas aéreas: Porcentaje de pasajeros sobre el total",
#        subtitle = "Marzo 2023",
#        x = "",
#        y = "Vuelos")+
#   theme_minimal()+
#   coord_flip()
```

```{r}
# cabotaje %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   group_by(ruta_nombre) %>% 
#   summarise(total = round(sum(pax_ad, na.rm = T), 0)) %>% 
#   arrange(-total) %>% 
#   top_n(20) %>% 
#   ggplot(aes(x = fct_reorder(ruta_nombre, total), y = total)) +
#   geom_bar(stat = "identity", fill = dnmye_colores("cian")) +
#   geom_label(aes(label = str_squish(format(total, big.mark = "."))),
#              hjust = 0.5) +
#   scale_y_continuous(limits = c(0, 120000),
#                      breaks = seq(0, 120000, 20000),
#                      labels = function(x) format(x, big.mark = "."))+
#   labs(title = "Top 20: Rutas aéreas más transitadas",
#        subtitle = "Marzo 2023",
#        x = "",
#        y = "Pasajeros")+
#   theme_minimal()+
#   coord_flip()
```

```{r}
rutas_aereas_numero <- cabotaje %>% 
  group_by(anio_local, mes_local, ruta_nombre) %>% 
  summarise(total_vuelos = sum(vuelos, na.rm = T)) %>%
  filter(total_vuelos >= 4) %>% 
  mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
  ungroup() %>% 
  filter(mes_local == month(max(fecha))) %>%
  group_by(anio_local) %>% 
  summarise(rutas = n_distinct(ruta_nombre)) %>%
  mutate(diferecia_anio = rutas - lag(rutas, 1)) %>%
  filter(anio_local == max(anio_local))

rutas_numero_cabotaje <- rutas_aereas_numero[1,2] %>% pull

rutas_numero_cabotaje_diferencia <- if_else((rutas_aereas_numero[1,3] %>% pull)>0,
                                            paste0((rutas_aereas_numero[1,3] %>% pull),
                                                   " más"),
                                            paste0((rutas_aereas_numero[1,3] %>% pull)*(-1),
                                                   " menos"))

rutas_numero_cabotaje_anio_prev <-(rutas_aereas_numero[1,2] %>% pull) - (rutas_aereas_numero[1,3] %>% pull)
```

A **`r datos_mes_anio`**, existían en el país **`r rutas_numero_cabotaje` rutas aéreas de cabotaje** con 4 o más frecuencias mensuales, `r rutas_numero_cabotaje_diferencia` con respecto al mismo mes del año pasado (`r rutas_numero_cabotaje_anio_prev`).

```{r}
graf_4 <- cabotaje %>% 
  group_by(anio_local, mes_local, ruta_nombre) %>% 
  summarise(total_vuelos = sum(vuelos, na.rm = T)) %>%
  filter(total_vuelos >= 4) %>%
  group_by(anio_local, mes_local) %>% 
  summarise(total_rutas = n_distinct(ruta_nombre)) %>% 
  mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
  ggplot(aes(x = fecha,
             y = total_rutas,
             text = paste("Fecha:",
                          format(fecha,"%b-%y"),
                          "<br> Total:",
                          format(total_rutas,
                                                           big.mark=".", decimal.mark = ",", digits=0)))) +
  geom_segment(aes(xend = fecha,
                   y = 0,
                   yend = total_rutas),
               color = dnmye_colores("cian"))+
  geom_point(color = dnmye_colores("cian"),
             size = 1.25,
             fill = alpha(dnmye_colores("cian"), 0.3),
             alpha = 0.7,
             shape = 21,
             stroke = 2) + 
  geom_point(data = cabotaje %>% 
               group_by(anio_local, mes_local, ruta_nombre) %>% 
               summarise(total_vuelos = sum(vuelos, na.rm = T)) %>%
               filter(total_vuelos >= 4) %>%
               group_by(anio_local, mes_local) %>% 
               summarise(total_rutas = n_distinct(ruta_nombre)) %>% 
               mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
               filter(mes_local == month(max(cabotaje$Fecha))),
             color = dnmye_colores("rosa"),
             size = 1,
             fill = alpha(dnmye_colores("rosa"), 0.3),
             alpha = 0.7,
             shape = 21,
             stroke = 1.75) + 
  scale_y_continuous(limits = c(0, 150),
                     breaks = seq(0, 150, 25))+
  scale_x_date(date_breaks = "4 month", 
               date_labels = "%b-%y")+
  scale_fill_dnmye(palette = "cualitativa", reverse = -1)+
  labs(title = "Cantidad de rutas aéreas de cabotaje",
       subtitle = "Con al menos 4 frecuencias mensuales",
       y = "",
       x = "",
       color = "",
       caption = "Fuente: MINTURDEP en base a información de ANAC.\n Nota: En rojo, los meses de abril.") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1))

ggplotly(graf_4, tooltip = "text") %>% 
  layout(title = list(text = paste0("Cantidad de rutas aéreas de cabotaje",
                                    '<br>',
                                    '<sup>',
                                    "Con 4 o más frecuencias mensuales",'</sup>')))
```


```{r}
# aeropuertos <- readxl::read_xlsx("/srv/DataDNMYE/aerocomercial/libros_de_codigos/ANAC/aeropuertos_nuevos.xlsx", col_types = "text") %>% 
#   mutate(across(c(latitud, longitud), as.numeric),
#          etiqueta_input = case_when(
#            pais_etiqueta_indec == "Argentina" ~ paste0(provincia, " - ", localidad_etiqueta_indec),
#            TRUE ~ paste0(pais_etiqueta_indec, " - ", localidad_etiqueta_indec))) %>% 
#   select(codigo_oaci, aeropuerto_etiqueta_anac, localidad_etiqueta_indec, etiqueta_input, latitud, longitud)
# 
# base_actual_rutas <- cabotaje %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   group_by(anio_local, empresa_agrup_def, origen_oaci, destino_oaci) %>% 
#   summarise(total = n()) %>% 
#   drop_na() %>% 
#   filter(total >= 4)
# 
# base_actual_rutas <- base_actual_rutas %>% 
#   left_join(aeropuertos, by = c("origen_oaci"="codigo_oaci")) %>% 
#   rename(latitud_orig = latitud, longitud_orig = longitud) %>% 
#   left_join(aeropuertos, by = c("destino_oaci"="codigo_oaci")) %>% 
#   rename(latitud_dest = latitud, longitud_dest = longitud)
# 
# # Para customizar lineas
# div1 <- base_actual_rutas %>% 
#   st_as_sf(coords = c("longitud_orig", "latitud_orig"), crs = 4326)
# 
# div2 <- base_actual_rutas %>% 
#   st_as_sf(coords = c("longitud_dest", "latitud_dest"), crs = 4326)
# 
# data_conexiones <- cbind(div1, div2)
# 
# coords = cbind(st_coordinates(data_conexiones$geometry), st_coordinates(data_conexiones$geometry.1))
# 
# data_conexiones$linestrings = st_sfc(
#   lapply(1:nrow(coords),
#          function(i){
#            st_linestring(matrix(coords[i,],ncol=2,byrow=TRUE))
#          }))
# 
# data_conexiones_tabla <- data_conexiones %>% 
#   st_set_geometry(NULL) %>% 
#   st_as_sf(crs = 4326)
# 
# aeros_filtro <- aeropuertos %>% 
#   filter(codigo_oaci %in% data_conexiones_tabla$origen_oaci |
#            codigo_oaci %in% data_conexiones_tabla$destino_oaci)
# 
# data_conec <- data_conexiones_tabla %>% 
#   left_join(aeros_filtro, by = c("origen_oaci" = "codigo_oaci")) %>% 
#   left_join(aeros_filtro, by = c("destino_oaci" = "codigo_oaci"))
# 
# data_conexiones_ruta <- data_conexiones %>% 
#   mutate(ruta = paste0(origen_oaci, "-" ,destino_oaci)) %>% 
#   select(anio_local, empresa_agrup_def, ruta, linestrings) %>% 
#   st_set_geometry(NULL) %>% 
#   st_as_sf(crs = 4326)
# 
# aeropuertos <- readxl::read_xlsx("/srv/DataDNMYE/aerocomercial/libros_de_codigos/ANAC/aeropuertos_nuevos.xlsx", col_types = "text") %>% 
#   select(codigo_oaci, localidad_etiqueta_indec)
# 
# data_conexiones_ruta_fil <- data_conexiones_ruta %>% 
#   filter(!str_detect(ruta, "SABE|SAEZ")) %>% 
#   mutate(origen = str_sub(ruta, 1, 4),
#          destino = str_sub(ruta, -4, -1)) %>% 
#   left_join(aeropuertos, by = c("origen" = "codigo_oaci")) %>% 
#   left_join(aeropuertos, by = c("destino" = "codigo_oaci")) %>% 
#   filter(anio_local == year(max(cabotaje$Fecha))) %>% 
#   select(empresa_agrup_def, localidad_etiqueta_indec.x, localidad_etiqueta_indec.y) %>% 
#   mutate(ruta = paste0(localidad_etiqueta_indec.x, " - ", localidad_etiqueta_indec.y)) %>% 
#   select(empresa_agrup_def, ruta) %>%
#   filter(!ruta  %in% c("El Calafate - Ushuaia", "Ushuaia - El Calafate")) %>% 
#   st_set_geometry(NULL) %>% 
#   group_by(empresa_agrup_def) %>% 
#   summarise(cantidad_rutas = n()/2) %>% 
#   arrange(-cantidad_rutas)

# data_conexiones_ruta_fil %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__RUTAS AÉREAS DEL INTERIOR__"),
#     subtitle = "Marzo 2023") %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   tab_source_note(
#     source_note = md("Comprende rutas aéreas que no conenctan con el AMBA")) %>% 
#   cols_label(
#     empresa_agrup_def = md("**Aerolínea**"),
#     cantidad_rutas = md("**TOTAL**")) %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans")))
```

```{r}
# library(geoAr)
# 
# arg_geo <- get_geo(geo = "ARGENTINA",
#                    level = "provincia")
# 
# ggplot()+
#   geom_sf(data = arg_geo, fill = "grey96") +
#   geom_sf(data = data_conexiones_ruta,
#           aes(color = empresa_agrup_def), size = 1.25) +
#   geom_sf(data = div1,
#           aes(color = empresa_agrup_def), size = 2) +
#   scale_color_manual(values = c("Aerolíneas Argentinas" = "steelblue2",
#                                 "JetSMART Airlines" = "midnightblue",
#                                 "Flybondi" = "gold1",
#                                 "LADE - Líneas Aéreas Del Estado" = "purple1"))+
#   labs(title = "Rutas Aéreas",
#        subtitle = "Marzo 2023",
#        color = "") +
#   theme_void() +
#   facet_wrap(~ empresa_agrup_def, nrow = 1) +
#   theme(legend.position = "none",
#         plot.title = element_text(hjust = 0.5),
#         plot.subtitle = element_text(hjust = 0.5))
```

# **INTERNACIONAL**

En lo que respecta al mercado internacional, en **`r datos_mes_anio`**, se realizaron **`r int_vuelos_mes_total` vuelos internacionales** en todo el país, lo que representa un `r int_variacion_interanual`. Con dicho valor, el acumulado anual escala a `r int_vuelos_acumulados_total` vuelos, un `r int_variacion_interanual_acum` frente al mismo período del año previo[^3].

[^3]: Íbidem.

```{r}
# graf_9 <- internacional %>% 
#   group_by(anio_local, mes_local) %>% 
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
#   ggplot(aes(x = fecha,
#              y = frecuencias)) +
#   geom_line(color = dnmye_colores("cian"),
#             stat = "identity",
#             size = 1.25)+
#   geom_point(color = dnmye_colores("cian"),
#              fill = "white",
#              stat = "identity",
#              size = 2,
#              shape = 21)+
#   scale_y_continuous(limits = c(0,15000),
#                      breaks = seq(0, 15000, 1000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_x_date(limits = c(dmy("01-01-2017"),
#                           max(cabotaje$fecha_month)),
#                date_breaks = "4 month", 
#                date_labels = "%b-%y")+
#   labs(title = "Vuelos Internacionales",
#        y = "Frecuencias totales",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1, 
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 1))
# 
# ggplotly(graf_9)
```

En el mes en cuestión, viajaron **`r int_pasajeros_mes_total` pasajeros**, (`r int_pasajeros_acumulados_total` en el acumulado anual), lo que supone un `r int_variacion_interanual_pasajeros` frente al mismo mes del año pasado (y un `r int_variacion_interanual_acum_pasajeros` en lo referente al total acumulado anual).

Para con al número de **asientos** disponibles en vuelos internacionales, **`r int_asientos_mes_total` plazas** fueron contadas, lo que equivale a un `r int_variacion_interanual_asientos` frente al `r datos_mes_anio` del año anterior. En el acumulado anual, `r int_asientos_acumulados_total` asientos fueron sumados, lo que supone una variación de `r int_variacion_interanual_acum_asientos`.

```{r}
# graf_10 <- internacional %>% 
#   group_by(anio_local, mes_local) %>% 
#   summarise(pasajeros = sum(pax_ad, na.rm = T),
#             asientos = sum(asientos_pax, na.rm = T)) %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
#   ggplot() +
#   geom_line(aes(x = fecha,
#                 y = pasajeros,
#                 color = "Pasajeros"),
#             stat = "identity",
#             size = 1.25)+
#   geom_line(aes(x = fecha,
#                 y = asientos,
#                 color = "Asientos"),
#             stat = "identity",
#             size = 1.25)+
#   geom_point(aes(x = fecha,
#                  y = pasajeros,
#                  color = "Pasajeros"),
#              fill = "white",
#              stat = "identity",
#              size = 2,
#              shape = 21)+
#   geom_point(aes(x = fecha,
#                  y = asientos,
#                  color = "Asientos"),
#              fill = "white",
#              stat = "identity",
#              size = 2,
#              shape = 21)+
#   scale_y_continuous(limits = c(0,2000000),
#                      breaks = seq(0, 2000000, 250000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_x_date(date_breaks = "4 month", date_labels = "%b-%y")+
#   scale_color_manual(values = c("Pasajeros" = dnmye_colores("cian"),
#                                 "Asientos" = dnmye_colores("rosa")))+
#   labs(title = "Vuelos internacionales",
#        y = "Total",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1))
# 
# ggplotly(graf_10)  %>%
#   layout(legend = list(orientation = 'h',
#                        x = 0.4, y = -0.2))
```

```{r}
# graf_11 <- internacional %>% 
#   group_by(anio_local, mes_local) %>% 
#   summarise(pasajeros = sum(pax_ad, na.rm = T),
#             asientos = sum(asientos_pax, na.rm = T)) %>% 
#   mutate(factor_de_ocupacion = round(pasajeros/asientos*100, 1),
#          fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
#   ggplot(aes(x = fecha,
#              y = factor_de_ocupacion)) +
#   geom_bar(stat = "identity",
#            size = 1,
#            fill = dnmye_colores("cian"))+
#   scale_y_continuous(limits = c(0, 100),
#                      breaks = seq(0, 100, 10),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_date(limits = c(dmy("01-01-2017"),
#                           max(internacional$fecha_month)),
#                date_breaks = "4 month", 
#                date_labels = "%b-%y")+
#   labs(title = "Vuelos internacionales: Factor de ocupación",
#        y = "Promedio mensual",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 1))
# 
# ggplotly(graf_11)

```

```{r}
comp_aereas_numero <- internacional %>% 
  filter(clase_vuelo == "Regular") %>% 
  group_by(anio_local, mes_local, empresa_agrup_def) %>% 
  summarise(total_vuelos = sum(vuelos, na.rm = T)) %>%
  filter(total_vuelos >= 4) %>% 
  mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
  ungroup() %>% 
  filter(mes_local == month(max(fecha))) %>%
  group_by(anio_local) %>% 
  summarise(empresas = n_distinct(empresa_agrup_def)) %>%
  mutate(diferecia_anio = empresas - lag(empresas, 1)) %>%
  filter(anio_local == max(anio_local)) 

comp_numero_cabotaje <- comp_aereas_numero[1,2] %>% pull

comp_numero_cabotaje_diferencia <- if_else((comp_aereas_numero[1,3] %>% pull)>0,
                                            paste0((comp_aereas_numero[1,3] %>% pull),
                                                   " más"),
                                            paste0((comp_aereas_numero[1,3] %>% pull)*(-1),
                                                   " menos"))

comp_numero_cabotaje_anio_prev <-(comp_aereas_numero[1,2] %>% pull) - (comp_aereas_numero[1,3] %>% pull)
```

En total, **`r comp_numero_cabotaje` aerolíneas comerciales** realizaron vuelos internacionales hacia Argentina en `r datos_mes_anio`, `r comp_numero_cabotaje_diferencia` con respecto a un año atrás (`r comp_numero_cabotaje_anio_prev`).

```{r}
graf_12 <- internacional %>% 
  filter(clase_vuelo == "Regular") %>% 
  group_by(anio_local, mes_local, empresa_agrup_def) %>% 
  summarise(total = n()) %>% 
  filter(total >= 4) %>% 
  group_by(anio_local, mes_local) %>% 
  summarise(total_aerolineas = n_distinct(empresa_agrup_def)) %>% 
  mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
  ggplot(aes(x = fecha,
             y = total_aerolineas,
             text = paste("Fecha:",
                          format(fecha,"%b-%y"),
                          "<br> Total:",
                          format(total_aerolineas,
                                                           big.mark=".", decimal.mark = ",", digits=0)))) +
  geom_segment(aes(xend = fecha,
                   y = 0,
                   yend = total_aerolineas),
               color = dnmye_colores("gris oscuro"))+
  geom_point(color = dnmye_colores("gris oscuro"),
             size = 1.25,
             fill = alpha(dnmye_colores("gris oscuro"), 0.3),
             alpha = 0.7,
             shape = 21,
             stroke = 2) + 
  geom_point(data = internacional %>% 
               filter(clase_vuelo == "Regular") %>% 
               group_by(anio_local, mes_local, empresa_agrup_def) %>% 
               summarise(total = n()) %>% 
               filter(total >= 4) %>% 
               group_by(anio_local, mes_local) %>% 
               summarise(total_aerolineas = n_distinct(empresa_agrup_def)) %>% 
               mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
               filter(mes_local == month(max(internacional$Fecha))),
             color = dnmye_colores("rosa"),
             size = 1,
             fill = alpha(dnmye_colores("rosa"), 0.3),
             alpha = 0.7,
             shape = 21,
             stroke = 1.5) + 
  scale_y_continuous(limits = c(0, 50),
                     breaks = seq(0, 50, 5)) +
  scale_x_date(date_breaks = "4 month", 
               date_labels = "%b-%y")+
  labs(title = "Aerolíneas que realizan vuelos internacionales",
       subtitle = "Cantidad",
       y = "",
       x = "",
       color = "",
       caption = "Fuente: MINTURDEP en base a información de ANAC.\n Nota: En rojo, los meses de abril.") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1)) +
  guides(color = guide_legend(nrow = 1))

ggplotly(graf_12, tooltip = "text")
```

```{r}
int_rutas_aereas_numero <- internacional %>% 
  group_by(anio_local, mes_local, ruta_nombre) %>% 
  summarise(total_vuelos = sum(vuelos, na.rm = T)) %>%
  filter(total_vuelos >= 4) %>% 
  mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
  ungroup() %>% 
  filter(mes_local == month(max(fecha))) %>%
  group_by(anio_local) %>% 
  summarise(rutas = n_distinct(ruta_nombre)) %>%
  mutate(diferecia_anio = rutas - lag(rutas, 1)) %>%
  filter(anio_local == max(anio_local))

int_rutas_numero_cabotaje <- int_rutas_aereas_numero[1,2] %>% pull

int_rutas_numero_cabotaje_diferencia <- if_else((int_rutas_aereas_numero[1,3] %>% pull)>0,
                                            paste0((int_rutas_aereas_numero[1,3] %>% pull),
                                                   " más"),
                                            paste0((int_rutas_aereas_numero[1,3] %>% pull)*(-1),
                                                   " menos"))

int_rutas_numero_cabotaje_anio_prev <-(int_rutas_aereas_numero[1,2] %>% pull) - (int_rutas_aereas_numero[1,3] %>% pull)
```

Actualmente, hay **`r int_rutas_numero_cabotaje` rutas aéreas internacionales que conectan Argentina** con el mundo con al menos 4 frecuencias mensuales, `r int_rutas_numero_cabotaje_diferencia` más con respecto a `r datos_mes_anio` del año pasado (`r int_rutas_numero_cabotaje_anio_prev`).

```{r}
graf_13 <-  internacional %>% 
  group_by(anio_local, mes_local, ruta_nombre) %>% 
  summarise(total = n()) %>% 
  filter(total >=4) %>%
  group_by(anio_local, mes_local) %>% 
  summarise(total_rutas = n_distinct(ruta_nombre)) %>% 
  mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
ggplot(aes(x = fecha,
             y = total_rutas,
             text = paste("Fecha:",
                          format(fecha,"%b-%y"),
                          "<br> Total:",
                          format(total_rutas,
                                                           big.mark=".", decimal.mark = ",", digits=0)))) +
  geom_segment(aes(xend = fecha,
                   y = 0,
                   yend = total_rutas),
               color = dnmye_colores("cian"))+
  geom_point(color = dnmye_colores("cian"),
             size = 1.25,
             fill = alpha(dnmye_colores("cian"), 0.3),
             alpha = 0.7,
             shape = 21,
             stroke = 2) + 
  geom_point(data =  internacional %>% 
               group_by(anio_local, mes_local, ruta_nombre) %>% 
               summarise(total = n()) %>% 
               filter(total >= 4) %>%
               group_by(anio_local, mes_local) %>% 
               summarise(total_rutas = n_distinct(ruta_nombre)) %>% 
               mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
               filter(mes_local == month(max(internacional$Fecha))),
             color = dnmye_colores("rosa"),
             size = 1.25,
             fill = alpha(dnmye_colores("rosa"), 0.3),
             alpha = 0.7,
             shape = 21,
             stroke = 2) + 
  scale_y_continuous(limits = c(0, 150),
                     breaks = seq(0, 150, 25))+
  scale_x_date(date_breaks = "4 month", 
               date_labels = "%b-%y")+
  labs(title = "Cantidad de rutas aéreas internacionales",
    subtitle = "Con al menos 4 frecuencias mensuales",
    y = "",
    x = "",
    color = "",
    caption = "Fuente: MINTURDEP en base a información de ANAC.\n Nota: En rojo, los meses de abril.") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1))


ggplotly(graf_13, tooltip = "text") %>% 
  layout(title = list(text = paste0("Cantidad de rutas aéreas internacionales",
                                    '<br>',
                                    '<sup>',
                                    "Con 4 o más frecuencias mensuales",'</sup>')))
```

```{r}
# internacional <- internacional %>% 
#   mutate(region_destino_int = case_when(destino_provincia_etiqueta == "Buenos Aires" ~ "Buenos Aires",
#                                         destino_provincia_etiqueta == "Ciudad Autónoma de Buenos Aires" ~ "AMBA",
#                                         destino_provincia_etiqueta == "Córdoba" ~ "Córdoba",
#                                         destino_provincia_etiqueta == "Tierra del Fuego, Antártida e Islas del Atlántico Sur" ~ "Patagonia",
#                                         destino_provincia_etiqueta == "Santa Cruz" ~ "Patagonia",
#                                         destino_provincia_etiqueta == "Chubut" ~ "Patagonia",
#                                         destino_provincia_etiqueta == "Neuquén" ~ "Patagonia",
#                                         destino_provincia_etiqueta == "Río Negro" ~ "Patagonia",
#                                         destino_provincia_etiqueta == "La Pampa" ~ "Patagonia",
#                                         destino_provincia_etiqueta == "Mendoza" ~ "Cuyo",
#                                         destino_provincia_etiqueta == "San Juan" ~ "Cuyo",
#                                         destino_provincia_etiqueta == "San Luis" ~ "Cuyo",
#                                         destino_provincia_etiqueta == "La Rioja" ~ "Norte",
#                                         destino_provincia_etiqueta == "Catamarca" ~ "Norte",
#                                         destino_provincia_etiqueta == "Salta" ~ "Norte",
#                                         destino_provincia_etiqueta == "Jujuy" ~ "Norte",
#                                         destino_provincia_etiqueta == "Santiago del Estero" ~ "Norte",
#                                         destino_provincia_etiqueta == "Tucumán" ~ "Norte",
#                                         destino_provincia_etiqueta == "Santa Fe" ~ "Litoral",
#                                         destino_provincia_etiqueta == "Chaco" ~ "Litoral",
#                                         destino_provincia_etiqueta == "Formosa" ~ "Litoral",
#                                         destino_provincia_etiqueta == "Misiones" ~ "Litoral",
#                                         destino_provincia_etiqueta == "Corrientes" ~ "Litoral",
#                                         destino_provincia_etiqueta == "Entre Ríos" ~ "Litoral",
#                                         T ~ "No hay info"),
#          region_destino_int = case_when(destino_aeropuerto_etiqueta %in% c("Aeropuerto Int. Ministro Pistarini", "Aeropuerto Int. de San Fernando", "Aeropuerto El Palomar") ~ "AMBA",
#                                         T ~ region_destino_int))
```

```{r}
# internacional %>% 
#   filter(destino_pais_etiqueta == "Argentina") %>% 
#   group_by(anio_local, mes_local, region_destino_int) %>% 
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>% 
#   filter(frecuencias >= 4) %>%
#   drop_na() %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
#   ggplot(aes(x = fecha,
#              y = frecuencias)) +
#   geom_area(aes(fill = region_destino_int),
#             alpha = 0.6,
#             color = "black",
#             position = "stack")+
#   scale_y_continuous(limits = c(0,6000),
#                      breaks = seq(0, 6000, 500),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_x_date(limits = c(dmy("01-01-2017"),
#                           max(internacional$fecha_month)),
#                date_breaks = "4 month", 
#                date_labels = "%b-%y")+  
#   scale_fill_dnmye(palette = "cualitativa", reverse = -1)+
#   labs(title = "Vuelos internacionales por región de destino",
#        y = "Frecuencias aéreas totales",
#        x = "",
#        color = "",
#        fill = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(fill = guide_legend(nrow = 1))

```

```{r}

# aerolineas_mes <- internacional %>%
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(empresa_agrup_def) %>%
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>%
#   top_n(10, wt = frecuencias) 
# 
# graf_14 <-  internacional %>% 
#   group_by(anio_local, mes_local, empresa_agrup_def) %>% 
#   summarise(total = n(),
#             frecuencias = sum(vuelos, na.rm = T)) %>% 
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>%
#   filter(empresa_agrup_def %in% aerolineas_mes$empresa_agrup_def) %>% 
#   ggplot(aes(x = fecha,
#              y = frecuencias)) +
#   geom_line(aes(color = empresa_agrup_def),
#             stat = "identity",
#             size = 0.75)+
#   scale_y_continuous(limits = c(0,3000),
#                      breaks = seq(0, 3000, 250),
#                      labels = function(x) format(x, big.mark = ".")) +
#   scale_x_date(limits = c(dmy("01-01-2017"),
#                           max(internacional$fecha_month)),
#                date_breaks = "4 month", 
#                date_labels = "%b-%y")+  
#   scale_color_dnmye(palette = "cualitativa",
#                     discrete = T,
#                     reverse = T)+
#   labs(title = "Principales aerolíneas internacionales",
#        y = "Vuelos totales",
#        x = "",
#        color = "",
#        fill = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 1))
# 
# ggplotly(graf_14) %>% 
#   layout(legend = list(orientation = 'h',
#                        x = 0.05, y = -0.2))
```

```{r}
# graf_15 <- internacional %>% 
#   filter(empresa_agrup_def %in% aerolineas_mes$empresa_agrup_def) %>% 
#   group_by(anio_local, mes_local, empresa_agrup_def) %>% 
#   summarise(total = n(),
#             pasajeros = sum(pax_ad, na.rm = T)) %>%
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>%
#   ggplot(aes(x = fecha,
#              y = pasajeros)) +
#   geom_line(aes(color = empresa_agrup_def),
#             stat = "identity",
#             size = 0.75)+
#   scale_x_date(limits = c(dmy("01-01-2017"),
#                           max(internacional$fecha_month)),
#                date_breaks = "4 month", 
#                date_labels = "%b-%y")+  
#   scale_color_dnmye(palette = "cualitativa",
#                     discrete = T,
#                     reverse = T)+
#   scale_y_continuous(limits = c(0,500000),
#                      breaks = seq(0, 500000, 50000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   labs(title = "Principales aerolíneas internacionales",
#        y =  "Pasajeros totales",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 2))
# 
# ggplotly(graf_15) %>% 
#   layout(legend = list(orientation = 'h',
#                        x = 0.05, y = -0.2))
```

```{r}
# graf_17 <- internacional %>% 
#   filter(empresa_agrup_def %in% aerolineas_mes$empresa_agrup_def) %>%
#   group_by(anio_local, mes_local, empresa_agrup_def) %>% 
#   summarise(total = n(),
#             asientos = sum(asientos_pax, na.rm = T)) %>%
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>%
#   ggplot(aes(x = fecha,
#              y = asientos)) +
#   geom_line(aes(color = empresa_agrup_def),
#             stat = "identity",
#             size = 0.75)+
#   scale_x_date(limits = c(dmy("01-01-2017"),
#                           max(internacional$fecha_month)),
#                date_breaks = "4 month", 
#                date_labels = "%b-%y")+  
#   scale_color_dnmye(palette = "cualitativa",
#                     discrete = T,
#                     reverse = T)+
#   scale_y_continuous(limits = c(0,500000),
#                      breaks = seq(0, 500000, 50000),
#                      labels = function(x) format(x, big.mark = ".")) +
#   labs(title = "Principales aerolíneas internacionales",
#        y =  "Asientos totales",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 2))
# 
# ggplotly(graf_17) %>% 
#   layout(legend = list(orientation = 'h',
#                        x = 0.05, y = -0.2))
```

```{r}
# graf_16 <-  internacional %>%
#   filter(empresa_agrup_def %in% aerolineas_mes$empresa_agrup_def) %>%
#   group_by(anio_local, mes_local, empresa_agrup_def) %>% 
#   summarise(total = n(),
#             asientos = sum(asientos_pax, na.rm = T),
#             pasajeros = sum(pax_ad, na.rm = T)) %>%
#   mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local)),
#          factor_ocupacion = round(pasajeros/asientos*100, 1)) %>%
#   ggplot(aes(x = fecha,
#              y = factor_ocupacion)) +
#   geom_line(aes(color = empresa_agrup_def),
#             stat = "identity",
#             size = 0.75)+
#   scale_y_continuous(limits = c(0,100),
#                      breaks = seq(0, 100, 10),
#                      labels = function(x) paste0(format(x,
#                                                         big.mark = "."),
#                                                  "%")) +
#   scale_x_date(limits = c(dmy("01-01-2017"),
#                           max(internacional$fecha_month)),
#                date_breaks = "4 month", 
#                date_labels = "%b-%y")+  
#   scale_color_dnmye(palette = "cualitativa",
#                     discrete = T,
#                     reverse = T)+
#   labs(title = "Principales aerolíneas internacionales",
#        y =  "Factor de ocupación",
#        x = "",
#        color = "",
#        caption = "Fuente: MINTURDEP en base a información de ANAC.") +
#   theme_minimal() +
#   theme(legend.position = "bottom",
#         axis.text.x = element_text(angle = 45,
#                                    hjust = 1,
#                                    vjust = 1)) +
#   guides(color = guide_legend(nrow = 2))
# 
# ggplotly(graf_16) %>% 
#   layout(legend = list(orientation = 'h',
#                        x = 0.05, y = -0.2))
```

```{r}
# # 12 - Frecuencias aéreas de vuelos internacionales a argentina por continente de origen, según mes. Año 2015
# # cuadro de doble entrada
# freq_int_org_22 <- internacional %>% 
#   filter(destino_pais_etiqueta == "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha))-1 & mes_local == month(max(cabotaje$Fecha))) %>% 
#   mutate(mes_local = month(mes_local, label = T, abbr = F)) %>% 
#   group_by(origen_continente_etiqueta_migraciones, mes_local) %>% 
#   summarise(frecuencias_22 = sum(vuelos, na.rm = T)) %>% 
#   mutate(origen_continente_etiqueta_migraciones = paste0(origen_continente_etiqueta_migraciones, "_22")) %>% 
#   pivot_wider(names_from = origen_continente_etiqueta_migraciones, values_from = frecuencias_22)
# 
# freq_int_org_23 <- internacional %>% 
#   filter(destino_pais_etiqueta == "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   filter(!is.na(origen_continente_etiqueta_migraciones)) %>% 
#   mutate(mes_local = month(mes_local, label = T, abbr = F)) %>% 
#   group_by(origen_continente_etiqueta_migraciones, mes_local) %>% 
#   summarise(frecuencias_23 = sum(vuelos, na.rm = T)) %>%
#   mutate(origen_continente_etiqueta_migraciones = paste0(origen_continente_etiqueta_migraciones, "_23")) %>% 
#   pivot_wider(names_from = origen_continente_etiqueta_migraciones, values_from = frecuencias_23)
# 
# freq_int_org <- freq_int_org_23 %>% 
#   mutate(oceania_22 = 0,
#          oceania_23 = 0,
#          africa_22 = 0,
#          africa_23 = 0,
#          asia_22 = 0,
#          asia_23 = 0) %>% 
#   left_join(freq_int_org_22, by = c("mes_local")) %>% 
#   janitor::clean_names() %>%
#   mutate(across(.cols = c(2:13), ~ as.numeric(.)),
#          var_inter_africa = round((africa_23/africa_22)-1, 1),
#          var_inter_asia = round((asia_23/asia_22)-1, 1),
#          var_inter_america_central = round((america_central_y_caribe_23/america_central_y_caribe_22)-1, 1),
#          var_inter_america_norte = round((america_del_norte_23/america_del_norte_22)-1, 1),
#          var_inter_america_sur = round((america_del_sur_23/america_del_sur_22)-1, 1),
#          var_inter_europa = round((europa_23/europa_22)-1, 1),
#          var_inter_oceania = round((oceania_23/oceania_22)-1, 1),
#          var_inter_oceania = if_else(!is.finite(var_inter_oceania),
#                                      oceania_23,
#                                      var_inter_oceania),
#          var_inter_asia = if_else(!is.finite(var_inter_asia),
#                                   asia_23,
#                                   var_inter_asia),
#          var_inter_africa = if_else(!is.finite(var_inter_africa),
#                                     africa_23,
#                                     var_inter_africa)) %>% 
#   select(-contains("_22"),
#          -contains("NA"))
# 
# col_order <- c(1, 7, 9, 2, 11, 3, 12, 4, 13, 8, 10, 5, 14, 6, 15)
# 
# freq_int_org <- freq_int_org[, col_order]
# 
# freq_int_org %>%
#   ungroup() %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__FRECUENCIAS AÉREAS DE VUELOS INTERNACIONALES A ARGENTINA POR CONTINENTE DE ORIGEN__"),
#     subtitle = "Marzo 2023") %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     mes_local = md("**Mes**"),
#     africa_23 = md("**África**"),
#     var_inter_africa = md("**v. a. %**"),
#     america_central_y_caribe_23 = md("**América Central y Caribe**"),
#     var_inter_america_central = md("**v. a. %**"),
#     america_del_norte_23 = md("**América del Norte**"),
#     var_inter_america_norte = md("**v. a. %**"),
#     america_del_sur_23 = md("**América del Sur**"),
#     var_inter_america_sur = md("**v. a. %**"),
#     asia_23 = md("**Asia**"),
#     var_inter_asia = md("**v. a. %**"),
#     europa_23 = md("**Europa**"),
#     var_inter_europa = md("**v. a. %**"),
#     oceania_23 = md("**Oceanía**"),
#     var_inter_oceania = md("**v. a. %**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:11))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(3, 5, 7, 9, 11, 13, 15), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_options(table.font.size = 12,
#               data_row.padding = px(3),
#               column_labels.font.size = 14,
#               column_labels.font.weight = "bold") %>% 
#   data_color(
#     columns = c(starts_with("var_")),
#     apply_to = "text",
#     colors = scales::col_bin(
#       bins = c(-Inf, 0, Inf),
#       palette = c(dnmye_colores("rosa"), dnmye_colores("azul verde")),
#     )
#   ) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight =  "bold")
#     ),
#     locations = cells_body(
#       columns = c(starts_with("var_"))
#     ))

```

```{r}

# freq_int_org_22 <- internacional %>% 
#   filter(inicio_pais == "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha))-1 & mes_local == month(max(cabotaje$Fecha))) %>% 
#   mutate(mes_local = month(mes_local, label = T, abbr = F)) %>% 
#   group_by(destino_continente_etiqueta_migraciones, mes_local) %>% 
#   summarise(frecuencias_22 = sum(vuelos, na.rm = T)) %>% 
#   mutate(destino_continente_etiqueta_migraciones = paste0(destino_continente_etiqueta_migraciones, "_22")) %>% 
#   pivot_wider(names_from = destino_continente_etiqueta_migraciones, values_from = frecuencias_22)
# 
# freq_int_org_23 <- internacional %>% 
#   filter(inicio_pais == "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   filter(!is.na(destino_continente_etiqueta_migraciones)) %>% 
#   mutate(mes_local = month(mes_local, label = T, abbr = F)) %>% 
#   group_by(destino_continente_etiqueta_migraciones, mes_local) %>% 
#   summarise(frecuencias_23 = sum(vuelos, na.rm = T)) %>%
#   mutate(destino_continente_etiqueta_migraciones = paste0(destino_continente_etiqueta_migraciones, "_23")) %>% 
#   pivot_wider(names_from = destino_continente_etiqueta_migraciones, values_from = frecuencias_23)
# 
# freq_int_org <- freq_int_org_23 %>% 
#   mutate(oceania_22 = 0,
#          oceania_23 = 0,
#          africa_23 = 0,
#          africa_22 = 0,
#          asia_22 = 0,
#          asia_23 = 0) %>% 
#   left_join(freq_int_org_22, by = c("mes_local")) %>%
#   janitor::clean_names() %>%
#   mutate(across(.cols = c(2:11), ~ as.numeric(.)),
#          var_inter_africa = round((africa_23/africa_22)-1, 1),
#          var_inter_asia = round((asia_23/asia_22)-1, 1),
#          var_inter_america_central = round((america_central_y_caribe_23/america_central_y_caribe_22)-1, 1),
#          var_inter_america_norte = round((america_del_norte_23/america_del_norte_22)-1, 1),
#          var_inter_america_sur = round((america_del_sur_23/america_del_sur_22)-1, 1),
#          var_inter_europa = round((europa_23/europa_22)-1, 1),
#          var_inter_oceania = round((oceania_23/oceania_22)-1, 1),
#          var_inter_oceania = if_else(!is.finite(var_inter_oceania),
#                                      oceania_23,
#                                      var_inter_oceania),
#          var_inter_africa = if_else(!is.finite(var_inter_africa),
#                                     africa_23,
#                                     var_inter_africa),
#          var_inter_asia = if_else(!is.finite(var_inter_asia),
#                                   asia_23,
#                                   var_inter_asia)) %>% 
#   select(-contains("_22"),
#          -contains("NA"))
# 
# col_order <- c(1, 7, 9, 2, 11, 3, 12, 4, 13, 8, 10, 5, 14, 6,15)
# 
# freq_int_org <- freq_int_org[, col_order]
# 
# freq_int_org %>%
#   ungroup() %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__FRECUENCIAS AÉREAS DE VUELOS INTERNACIONALES DESDE ARGENTINA POR CONTINENTE DE DESTINO__"),
#     subtitle = "Marzo 2023") %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     mes_local = md("**Mes**"),
#     africa_23 = md("**África**"),
#     var_inter_africa = md("**Variación interanual (%)**"),
#     america_central_y_caribe_23 = md("**América Central y Caribe**"),
#     var_inter_america_central = md("**Variación interanual (%)**"),
#     america_del_norte_23 = md("**América del Norte**"),
#     var_inter_america_norte = md("**Variación interanual (%)**"),
#     america_del_sur_23 = md("**América del Sur**"),
#     var_inter_america_sur = md("**Variación interanual (%)**"),
#     asia_23 = md("**Asia**"),
#     var_inter_asia = md("**Variación interanual (%)**"),
#     europa_23 = md("**Europa**"),
#     var_inter_europa = md("**Variación interanual (%)**"),
#     oceania_23 = md("**Oceanía**"),
#     var_inter_oceania = md("**Variación interanual (%)**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:11))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(3, 5, 7, 9, 11, 13, 15), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_options(table.font.size = 12,
#               data_row.padding = px(3),
#               column_labels.font.size = 14,
#               column_labels.font.weight = "bold") %>% 
#   data_color(
#     columns = c(starts_with("var_")),
#     apply_to = "text",
#     colors = scales::col_bin(
#       bins = c(-Inf, 0, Inf),
#       palette = c(dnmye_colores("rosa"), dnmye_colores("azul verde")),
#     )
#   ) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight =  "bold")
#     ),
#     locations = cells_body(
#       columns = c(starts_with("var_"))
#     ))
```

```{r}
# internacional %>% 
#   filter(origen_pais_etiqueta == "Argentina") %>% 
#   filter( mes_local == month(max(cabotaje$Fecha))) %>% 
#   mutate(destino_continente_etiqueta_migraciones = as.factor(destino_continente_etiqueta_migraciones)) %>% 
#   group_by(anio_local, destino_continente_etiqueta_migraciones, .drop = F) %>% 
#   summarise(frecuencias = sum(vuelos, na.rm = T),
#             .groups = "keep") %>%
#   group_by(anio_local, .drop = F) %>% 
#   mutate(frecuencias_totales = sum(frecuencias, na.rm = T)) %>% 
#   ungroup() %>% 
#   mutate(pct = round(frecuencias/frecuencias_totales*100, 1)) %>% 
#   filter(!is.na(destino_continente_etiqueta_migraciones)) %>% 
#   ggplot(aes(x = reorder(destino_continente_etiqueta_migraciones, frecuencias), y = pct)) +
#   geom_bar(aes(fill = destino_continente_etiqueta_migraciones), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(format(pct, decimal.mark = ","), "%")),
#             size = 3,
#             hjust = -0.15) +
#   facet_wrap(~ anio_local) +
#   scale_y_continuous(limits = c(0, 100),
#                      labels = function(x) paste0(x, "%")) +
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Frecuencias aéreas de vuelos internacionales por continente de destino.",
#        subtitle = "Marzo",
#        y = "",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal() +
#   coord_flip()+
#   theme(strip.text.x = element_text(size = 10, face = "bold"))
```

```{r}
# internacional %>% 
#   filter(destino_pais_etiqueta == "Argentina") %>% 
#   filter(mes_local == month(max(cabotaje$Fecha))) %>% 
#   mutate(origen_continente_etiqueta_migraciones = as.factor(origen_continente_etiqueta_migraciones)) %>% 
#   group_by(anio_local, origen_continente_etiqueta_migraciones, .drop = F) %>% 
#   summarise(frecuencias = sum(vuelos, na.rm = T),
#             .groups = "keep") %>%
#   group_by(anio_local, .drop = F) %>% 
#   mutate(frecuencias_totales = sum(frecuencias, na.rm = T)) %>% 
#   ungroup() %>% 
#   mutate(pct = round(frecuencias/frecuencias_totales*100, 1)) %>% 
#   filter(!is.na(origen_continente_etiqueta_migraciones)) %>% 
#   ggplot(aes(x = reorder(origen_continente_etiqueta_migraciones, frecuencias), y = pct)) +
#   geom_bar(aes(fill = origen_continente_etiqueta_migraciones), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(format(pct, decimal.mark = ","), "%")),
#             size = 3,
#             hjust = -0.15) +
#   facet_wrap(~ anio_local) +
#   scale_y_continuous(limits = c(0, 100),
#                      labels = function(x) paste0(x, "%")) +
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Frecuencias aéreas de vuelos internacionales por continente de origen.",
#        subtitle = "Marzo",
#        y = "",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal() +
#   coord_flip() +
#   theme(strip.text.x = element_text(size = 10, face = "bold"))

```


```{r}
# freq_cont_pais_22 <- internacional %>% 
#   filter(anio_local == year(max(cabotaje$Fecha))-1 & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(origen_continente_etiqueta_migraciones, origen_pais_etiqueta, empresa_agrup_def) %>% 
#   summarise(frecuencias_22 = n())
# 
# freq_cont_pais_23 <- internacional %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(origen_continente_etiqueta_migraciones, origen_pais_etiqueta, empresa_agrup_def) %>% 
#   summarise(frecuencias_23 = n())
# 
# freq_cont_pais <- freq_cont_pais_23 %>% 
#   left_join(freq_cont_pais_22, by = c("origen_continente_etiqueta_migraciones", "origen_pais_etiqueta", "empresa_agrup_def")) %>% 
#   drop_na(origen_continente_etiqueta_migraciones, empresa_agrup_def) %>%
#   mutate(across(.cols = c(2,3), ~ as.numeric(.)),
#          var_anual = round((frecuencias_23/frecuencias_22)-1, 1),
#          var_anual = if_else(!is.finite(var_anual),
#                              frecuencias_23,
#                              var_anual),
#          frecuencias_22 = case_when(is.na(frecuencias_22) ~ "-",
#                                     T ~ as.character(frecuencias_22))) %>% 
#   select(1,2,3,5,4,6)
# 
# freq_cont_pais %>% 
#   ungroup() %>% 
#   filter(origen_pais_etiqueta != "Argentina") %>% 
#   filter(frecuencias_23 > 1) %>% 
#   group_by(origen_continente_etiqueta_migraciones) %>% 
#   arrange(origen_continente_etiqueta_migraciones, origen_pais_etiqueta, -frecuencias_23) %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__FRECUENCIAS AÉREAS DE VUELOS INTERNACIONALES POR CONTINENTE Y PAÍS DE ORIGEN__"),
#     subtitle = md("__MARZO__")) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     origen_pais_etiqueta = md("**País**"),
#     empresa_agrup_def = md("**Companía Aérea**"),
#     frecuencias_23 = md("**2023**"),
#     frecuencias_22 = md("**2022**"),
#     var_anual = md("**v.a %**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(4:6))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(6), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   tab_style(style = cell_fill(color = dnmye_colores("gris claro")),
#             locations = cells_row_groups())%>% 
#   data_color(
#     columns = c(starts_with("var_")),
#     apply_to = "text",
#     colors = scales::col_bin(
#       bins = c(-Inf, 0, Inf),
#       palette = c(dnmye_colores("rosa"), dnmye_colores("azul verde")),
#     )
#   ) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight =  "bold")
#     ),
#     locations = cells_body(
#       columns = c(starts_with("var_"))
#     )) %>% 
#   tab_style(style = cell_text(weight = "bold"),
#             locations = cells_row_groups())
```

```{r}
# freq_cont_pais_22 <- internacional %>% 
#   filter(anio_local == year(max(cabotaje$Fecha))-1 & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(destino_continente_etiqueta_migraciones, destino_pais_etiqueta, empresa_agrup_def) %>% 
#   summarise(frecuencias_22 = n())
# 
# freq_cont_pais_23 <- internacional %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(destino_continente_etiqueta_migraciones, destino_pais_etiqueta, empresa_agrup_def) %>% 
#   summarise(frecuencias_23 = n())
# 
# freq_cont_pais <- freq_cont_pais_23 %>% 
#   left_join(freq_cont_pais_22, by = c("destino_continente_etiqueta_migraciones", "destino_pais_etiqueta", "empresa_agrup_def")) %>% 
#   drop_na(destino_continente_etiqueta_migraciones, empresa_agrup_def) %>%
#   mutate(across(.cols = c(2,3), ~ as.numeric(.)),
#          var_anual = round((frecuencias_23/frecuencias_22)-1, 1),
#          var_anual = if_else(!is.finite(var_anual),
#                              frecuencias_23,
#                              var_anual),
#          frecuencias_22 = case_when(is.na(frecuencias_22) ~ "-",
#                                     T ~ as.character(frecuencias_22))) %>% 
#   select(1,2,3,5,4, 6)
# 
# freq_cont_pais %>% 
#   ungroup() %>% 
#   filter(destino_pais_etiqueta != "Argentina") %>% 
#   group_by(destino_continente_etiqueta_migraciones) %>% 
#   arrange(destino_continente_etiqueta_migraciones, destino_pais_etiqueta, -frecuencias_23) %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__FRECUENCIAS AÉREAS DE VUELOS INTERNACIONALES POR CONTINENTE Y PAÍS DE DESTINO__"),
#     subtitle = md("__MARZO__")) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     destino_pais_etiqueta = md("**País**"),
#     empresa_agrup_def = md("**Companía Aérea**"),
#     frecuencias_23 = md("**2023**"),
#     frecuencias_22 = md("**2022**"),
#     var_anual = md("**v.a %**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(4:6))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(6), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   tab_style(style = cell_fill(color = dnmye_colores("gris claro")),
#             locations = cells_row_groups())%>% 
#   data_color(
#     columns = c(starts_with("var_")),
#     apply_to = "text",
#     colors = scales::col_bin(
#       bins = c(-Inf, 0, Inf),
#       palette = c(dnmye_colores("rosa"), dnmye_colores("azul verde")),
#     )
#   ) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight =  "bold")
#     ),
#     locations = cells_body(
#       columns = c(starts_with("var_"))
#     )) %>% 
#   tab_style(style = cell_text(weight = "bold"),
#             locations = cells_row_groups())
```

```{r}
# internacional %>% 
#   filter(origen_pais_etiqueta != "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(origen_localidad_etiqueta) %>% 
#   summarise(frecuencias = n()) %>% 
#   mutate(prop = frecuencias/sum(frecuencias, na.rm = T)) %>% 
#   arrange(-frecuencias) %>% 
#   mutate(origen_localidad_etiqueta = case_when(prop <= 0.04 ~ "Resto",
#                                                T ~ origen_localidad_etiqueta)) %>% 
#   group_by(origen_localidad_etiqueta) %>% 
#   summarise(frecuencias = sum(frecuencias)) %>%
#   mutate(prop = round(frecuencias/sum(frecuencias, na.rm = T)*100, 1)) %>% 
#   ggplot(aes(x = factor(origen_localidad_etiqueta, 
#                         levels = c("Santiago",
#                                    "São Paulo",
#                                    "Río de Janeiro",
#                                    "Lima",
#                                    "Panamá",
#                                    "Florianópolis",
#                                    "Madrid",
#                                    "Resto")),
#              y = prop)) +
#   geom_bar(aes(fill = origen_localidad_etiqueta), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(format(prop, decimal.mark = ","), "%"), vjust = -.5)) +
#   scale_y_continuous(limits = c(0, 50),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_discrete(labels = function(origen_localidad_etiqueta) str_wrap(origen_localidad_etiqueta, width = 10))+
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Frecuencias aéreas de vuelos internacionales por ciudad de origen",
#        subtitle = "Marzo 2023",
#        y = "Distribución porcentual",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal()
```

```{r}
# internacional %>% 
#   filter(origen_pais_etiqueta == "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(destino_localidad_etiqueta) %>% 
#   summarise(frecuencias = n()) %>% 
#   mutate(prop = frecuencias/sum(frecuencias, na.rm = T)) %>% 
#   arrange(-frecuencias) %>% 
#   mutate(destino_localidad_etiqueta = case_when(prop <= 0.04 ~ "Resto",
#                                                T ~ destino_localidad_etiqueta)) %>% 
#   group_by(destino_localidad_etiqueta) %>% 
#   summarise(frecuencias = sum(frecuencias)) %>%
#   mutate(prop = round(frecuencias/sum(frecuencias, na.rm = T)*100, 1)) %>% 
#   ggplot(aes(x = factor(destino_localidad_etiqueta, 
#                         levels = c("Santiago",
#                                    "São Paulo",
#                                    "Lima",
#                                    "Río de Janeiro",
#                                    "Panamá",
#                                    "Madrid",
#                                    "Resto")),
#              y = prop)) +
#   geom_bar(aes(fill = destino_localidad_etiqueta), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(format(prop, decimal.mark = ","), "%"), vjust = -.5)) +
#   scale_y_continuous(limits = c(0, 50),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_discrete(labels = function(destino_localidad_etiqueta) str_wrap(destino_localidad_etiqueta, width = 10))+
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Frecuencias aéreas de vuelos internacionales por ciudad de destino",
#        subtitle = "Marzo 2023",
#        y = "Distribución porcentual",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal()
```

```{r}
# internacional %>% 
#   filter(origen_pais_etiqueta == "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(origen_localidad_etiqueta) %>% 
#   summarise(frecuencias = n()) %>% 
#   mutate(prop = frecuencias/sum(frecuencias, na.rm = T)) %>% 
#   arrange(-frecuencias) %>% 
#   group_by(origen_localidad_etiqueta) %>% 
#   summarise(frecuencias = sum(frecuencias)) %>%
#   mutate(prop = round(frecuencias/sum(frecuencias, na.rm = T)*100, 1)) %>% 
#   ggplot(aes(x = reorder(origen_localidad_etiqueta, -frecuencias),
#              y = prop)) +
#   geom_bar(aes(fill = origen_localidad_etiqueta), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(format(prop, decimal.mark = ","), "%"), vjust = -.5)) +
#   scale_y_continuous(limits = c(0, 100),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_discrete(labels = function(origen_localidad_etiqueta) str_wrap(origen_localidad_etiqueta, width = 10))+
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Vuelos internacionales por ciudad de origen",
#        subtitle = "Marzo 2023",
#        y = "Distribución porcentual",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal()
```

```{r}
# internacional %>% 
#   filter(destino_pais_etiqueta == "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(destino_localidad_etiqueta) %>% 
#   summarise(frecuencias = n()) %>% 
#   mutate(prop = frecuencias/sum(frecuencias, na.rm = T)) %>% 
#   arrange(-frecuencias) %>% 
#   group_by(destino_localidad_etiqueta) %>% 
#   summarise(frecuencias = sum(frecuencias)) %>%
#   mutate(prop = round(frecuencias/sum(frecuencias, na.rm = T)*100, 1)) %>% 
#   ggplot(aes(x = reorder(destino_localidad_etiqueta, -frecuencias),
#              y = prop)) +
#   geom_bar(aes(fill = destino_localidad_etiqueta), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(format(prop, decimal.mark = ","), "%"), vjust = -.5)) +
#   scale_y_continuous(limits = c(0, 100),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_discrete(labels = function(destino_localidad_etiqueta) str_wrap(destino_localidad_etiqueta, width = 10))+
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Vuelos internacionales por ciudad de destino",
#        subtitle = "Marzo 2023",
#        y = "Distribución porcentual",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal()
```

```{r}
# internacional %>% 
#   filter(destino_pais_etiqueta == "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
#   group_by(destino_localidad_etiqueta) %>% 
#   summarise(pasajeros = sum(pax_ad)) %>% 
#   mutate(prop = pasajeros/sum(pasajeros, na.rm = T),
#          prop = round(prop*100, 1)) %>% 
#   ggplot(aes(x = reorder(destino_localidad_etiqueta, -pasajeros),
#              y = prop)) +
#   geom_bar(aes(fill = destino_localidad_etiqueta), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(format(prop, decimal.mark = ","), "%"), vjust = -.5)) +
#   scale_y_continuous(limits = c(0,100),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_discrete(labels = function(destino_localidad_etiqueta) str_wrap(destino_localidad_etiqueta, width = 10))+
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Pasajeros internacionales por ciudad de destino",
#        subtitle = "Marzo 2023",
#        y = "Distribución porcentual",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal()
```

```{r}
# vuelos_int_22 <- internacional %>% 
#   filter(anio_local == year(max(cabotaje$Fecha))-1 & mes_local == month(max(cabotaje$Fecha))) %>%
#   filter(destino_pais_etiqueta == "Argentina") %>% 
#   group_by(origen_localidad_etiqueta) %>% 
#   summarise(frecuencias_22 = n()) %>% 
#   arrange(-frecuencias_22) %>% 
#   mutate(posicion_22 = 1:n(),
#          participacion_22 = round(frecuencias_22/sum(frecuencias_22), 2))
# 
# vuelos_int_23 <- internacional %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
#   filter(destino_pais_etiqueta == "Argentina") %>%  
#   group_by(origen_localidad_etiqueta) %>% 
#   summarise(frecuencias_23 = n()) %>% 
#   arrange(-frecuencias_23) %>% 
#   mutate(posicion_23 = 1:n()) 
# 
# vuelos_int <- vuelos_int_23 %>% 
#   full_join(vuelos_int_22, by = "origen_localidad_etiqueta") %>% 
#   filter(!is.na(posicion_23)) %>% 
#   mutate(variacion = round((frecuencias_23-frecuencias_22)/frecuencias_22, 2),
#          origen_localidad_etiqueta = case_when(posicion_23 >= 20 ~ "Resto",
#                                                T ~ origen_localidad_etiqueta)) %>%
#   group_by(origen_localidad_etiqueta) %>% 
#   summarise(frecuencias_23 = sum(frecuencias_23, na.rm = T),
#             frecuencias_22 = sum(frecuencias_22, na.rm = T),
#             posicion_23 = first(posicion_23),
#             posicion_22 = first(posicion_22)) %>% 
#   mutate(variacion = round((frecuencias_23-frecuencias_22)/frecuencias_22, 2),
#          participacion_23 = round(frecuencias_23/sum(frecuencias_23), 3),
#          posicion_23 = case_when(origen_localidad_etiqueta == "Resto" ~ "-",
#                                  T ~ as.character(posicion_23)),
#          posicion_22 = case_when(origen_localidad_etiqueta == "Resto" ~ "-",
#                                  T ~ as.character(posicion_22))) %>%
#   arrange(-frecuencias_23) %>% 
#   mutate(situacion = case_when(as.numeric(posicion_23) < as.numeric(posicion_22) ~ "▲",
#                                as.numeric(posicion_23) > as.numeric(posicion_22) ~ "▼",
#                                T ~ "=")) %>%
#   mutate(orden = 1:n(),
#          orden = if_else(origen_localidad_etiqueta == "Resto",
#                          Inf,
#                          as.numeric(orden))) %>% 
#   arrange(orden) %>% 
#   select(-orden)
# 
# 
# col_order <- c("origen_localidad_etiqueta",
#                "posicion_23",
#                "situacion",
#                "posicion_22",
#                "frecuencias_23",
#                "frecuencias_22",
#                "variacion",
#                "participacion_23")
# 
# vuelos_int <- vuelos_int[, col_order]
# 
# vuelos_int %>%
#   gt() %>% 
#   tab_header(
#     title = md("__RANKING DE FRECUENCIAS AÉREAS DE VUELOS INTERNACIONALES POR CIUDAD DE ORIGEN__"),
#     subtitle = "ABRIL") %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     origen_localidad_etiqueta = md("**Ciudad**"),
#     posicion_23 = md("**2023**"),
#     situacion = "",
#     posicion_22 = md("**2022**"),
#     frecuencias_23 = md("**2023**"),
#     frecuencias_22 = md("**2022**"),
#     variacion = md("**v.a. %**"),
#     participacion_23 = md("**Participación 2023 (%)**")) %>% 
#   cols_align(
#     align = "center",
#     columns = everything())  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(7, 8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")),
#     locations = cells_column_spanners(spanners = everything())
#   ) %>%
#   data_color(
#     columns = variacion,
#     apply_to = "text",
#     colors = scales::col_bin(
#       bins = c(-Inf, 0, Inf),
#       palette = c(dnmye_colores("rosa"), dnmye_colores("azul verde")),
#     )
#   ) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight =  "bold")
#     ),
#     locations = cells_body(
#       columns = c(starts_with("var_")))) %>% 
#   tab_spanner(
#     label = "Posición",
#     columns = c(posicion_22, situacion, posicion_23)) %>% 
#   tab_spanner(
#     label = "Frecuencias",
#     columns = c(frecuencias_22, frecuencias_23)
#   )%>%
#   tab_style(
#     style = list(
#       cell_text(color = "#EE3D8F"),
#       cell_text(weight  = "bold")
#     ),
#     locations = cells_body(
#       columns = situacion,
#       rows = as.numeric(posicion_23) > as.numeric(posicion_22))
#   ) %>% 
#   tab_style(
#     style = list(
#       cell_text(color = "#50B8B1"),
#       cell_text(weight =  "bold")
#     ),
#     locations = cells_body(
#       columns = situacion,
#       rows = as.numeric(posicion_23) < as.numeric(posicion_22)))%>% 
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")),
#     locations = cells_column_spanners(spanners = everything())
#   ) %>% 
#   sub_missing(
#     columns = everything(),
#     rows = everything(),
#     missing_text = "-")
```

```{r}
int_rank_locs <- internacional %>%
  filter(destino_pais_etiqueta != "Argentina") %>% 
  filter(fecha_month == max(fecha_month)) %>%
  group_by(destino_localidad_etiqueta) %>% 
  summarise(vuelos = sum(vuelos, na.rm = T)) %>% 
  arrange(-vuelos) %>% 
  top_n(3) 
  
int_primer_rank_loc <- int_rank_locs[1,1] %>% pull
int_segun_rank_loc <- int_rank_locs[2,1] %>% pull
int_tercer_rank_loc <- int_rank_locs[3,1] %>% pull
```

Sobre las principales conexiones, **`r int_primer_rank_loc`, `r int_segun_rank_loc` y `r int_tercer_rank_loc` son los principales destinos internacionales desde Argentina**.

```{r}
vuelos_int_23 <- internacional %>% 
  filter(anio_local == year(max(cabotaje$Fecha))-1 & mes_local == month(max(cabotaje$Fecha))) %>%
  filter(destino_pais_etiqueta != "Argentina") %>% 
  group_by(destino_localidad_etiqueta) %>% 
  summarise(frecuencias_23 = sum(vuelos, na.rm = T)) %>% 
  arrange(-frecuencias_23) %>% 
  mutate(posicion_23 = 1:n(),
         participacion_23 = round(frecuencias_23/sum(frecuencias_23), 2))

vuelos_int_24 <- internacional %>% 
  filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
  filter(destino_pais_etiqueta != "Argentina") %>%  
  group_by(destino_localidad_etiqueta) %>% 
  summarise(frecuencias_24 = sum(vuelos, na.rm = T)) %>% 
  arrange(-frecuencias_24) %>% 
  mutate(posicion_24 = 1:n()) 

vuelos_int <- vuelos_int_24 %>% 
  full_join(vuelos_int_23, by = "destino_localidad_etiqueta") %>% 
  filter(!is.na(posicion_24)) %>% 
  mutate(variacion = (frecuencias_24-frecuencias_23)/frecuencias_23,
         destino_localidad_etiqueta = case_when(posicion_24 >= 20 ~ "Resto",
                                                T ~ destino_localidad_etiqueta)) %>%
  group_by(destino_localidad_etiqueta) %>% 
  summarise(frecuencias_24 = sum(frecuencias_24, na.rm = T),
            frecuencias_23 = sum(frecuencias_23, na.rm = T),
            posicion_24 = first(posicion_24),
            posicion_23 = first(posicion_23)) %>% 
  mutate(variacion = (frecuencias_24-frecuencias_23)/frecuencias_23,
         participacion_24 = frecuencias_24/sum(frecuencias_24),
         posicion_24 = case_when(destino_localidad_etiqueta == "Resto" ~ "-",
                                 T ~ as.character(posicion_24)),
         posicion_23 = case_when(destino_localidad_etiqueta == "Resto" ~ "-",
                                 T ~ as.character(posicion_23))) %>%
  arrange(-frecuencias_24) %>% 
  mutate(situacion = case_when(as.numeric(posicion_24) < as.numeric(posicion_23) ~ "▲",
                               as.numeric(posicion_24) > as.numeric(posicion_23) ~ "▼",
                               T ~ "=")) %>%
  mutate(orden = 1:n(),
         orden = if_else(destino_localidad_etiqueta == "Resto",
                         Inf,
                         as.numeric(orden))) %>% 
  arrange(orden) %>% 
  select(-orden)


col_order <- c("destino_localidad_etiqueta",
               "posicion_24",
               "situacion",
               "posicion_23",
               "frecuencias_24",
               "frecuencias_23",
               "variacion",
               "participacion_24")

vuelos_int <- vuelos_int[, col_order]

vuelos_int[sapply(vuelos_int, is.infinite)] <- NA

vuelos_int %>%
  gt() %>% 
  tab_header(
    title = md("__RANKING DE DESTINOS POR VUELOS INTERNACIONALES__"),
    subtitle = glue::glue("{str_to_title(strftime(max(base_total$Fecha), '%B'))}")) %>% 
  tab_source_note(
    source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>%   cols_label(
    destino_localidad_etiqueta = md("**Ciudad**"),
    posicion_24 = md("**2024**"),
    situacion = "",
    posicion_23 = md("**2023**"),
    frecuencias_24 = md("**2024**"),
    frecuencias_23 = md("**2023**"),
    variacion = md("**v.a. %**"),
    participacion_24 = md("**Participación 2024 (%)**")) %>% 
  cols_align(
    align = "center",
    columns = everything())  %>% 
  opt_table_font(
    font = list(
      google_font(name = "Encode Sans"))) %>% 
  fmt_percent(columns = c(7, 8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = cells_column_spanners(spanners = everything())
  ) %>%
  data_color(
    columns = variacion,
    apply_to = "text",
    colors = scales::col_bin(
      bins = c(-Inf, 0, Inf),
      palette = c(dnmye_colores("rosa"), dnmye_colores("azul verde")),
    )) %>% 
  tab_style(
    style = list(
      cell_text(weight =  "bold")
    ),
    locations = cells_body(
      columns = c(starts_with("var_")))) %>% 
  tab_spanner(
    label = "Posición",
    columns = c(posicion_23, situacion, posicion_24)) %>% 
  tab_spanner(
    label = "Frecuencias",
    columns = c(frecuencias_23, frecuencias_24)
  )%>%
  tab_style(
    style = list(
      cell_text(color = "#EE3D8F"),
      cell_text(weight  = "bold")
    ),
    locations = cells_body(
      columns = situacion,
      rows = as.numeric(posicion_24) > as.numeric(posicion_23))
  ) %>% 
  tab_style(
    style = list(
      cell_text(color = "#50B8B1"),
      cell_text(weight =  "bold")
    ),
    locations = cells_body(
      columns = situacion,
      rows = as.numeric(posicion_24) < as.numeric(posicion_23))) %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = cells_column_spanners(spanners = everything())
  ) %>%
  tab_style(
    style = list(
      cell_text(color = "#EE3D8F"),
      cell_text(weight  = "bold")
    ),
    locations = cells_body(
      columns = variacion,
      rows = variacion < 0)
  ) %>% 
  tab_style(
    style = list(
      cell_text(color = "#50B8B1"),
      cell_text(weight =  "bold")
    ),
    locations = cells_body(
      columns = variacion,
      rows = variacion >= 0)) %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = cells_column_spanners(spanners = everything())) %>% 
  sub_missing(
    columns = everything(),
    rows = everything(),
    missing_text = "-")

```

```{r}
# internacional %>% 
#   filter(destino_pais_etiqueta == "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   mutate(empresa_agrup_def = case_when(is.na(empresa_agrup_def) ~ "Otras empresas",
#                                        T ~ as.character(empresa_agrup_def))) %>%
#   group_by(empresa_agrup_def, .drop = F) %>% 
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>% 
#   mutate(pct = round(frecuencias/sum(frecuencias)*100, 1)) %>% 
#   arrange(-pct) %>% 
#   mutate(empresa_agrup_def = case_when(pct < 4 ~ "Otras empresas",
#                                        T ~ empresa_agrup_def)) %>% 
#   group_by(empresa_agrup_def) %>% 
#   summarise(frecuencias = sum(frecuencias)) %>% 
#   mutate(pct = round(frecuencias/sum(frecuencias)*100, 1)) %>% 
#   ggplot(aes(x = factor(empresa_agrup_def, 
#                         levels = c("Aerolíneas Argentinas",
#                                    "LATAM",
#                                    "Gol Transportes Aéreos",
#                                    "Copa Airlines",
#                                    "Flybondi",
#                                    "Sky Airline",
#                                    "Otras empresas")), y = pct)) +
#   geom_bar(aes(fill = empresa_agrup_def), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(pct, "%"), vjust = -.5)) +
#   scale_y_continuous(limits = c(0, 50),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_discrete(labels = function(empresa_agrup_def) str_wrap(empresa_agrup_def, width = 10))+
#   
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Vuelos internacionales a Argentina según compañía aérea",
#        subtitle = "Marzo 2023",
#        y = "Distribución porcentual",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal()
```

```{r}
# internacional %>% 
#   filter(destino_pais_etiqueta != "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   mutate(empresa_agrup_def = case_when(is.na(empresa_agrup_def) ~ "Otras empresas",
#                                        T ~ as.character(empresa_agrup_def))) %>%
#   group_by(empresa_agrup_def, .drop = F) %>% 
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>% 
#   mutate(pct = round(frecuencias/sum(frecuencias)*100, 1)) %>% 
#   arrange(-pct) %>% 
#   mutate(empresa_agrup_def = case_when(pct < 4 ~ "Otras empresas",
#                                        T ~ empresa_agrup_def)) %>% 
#   group_by(empresa_agrup_def) %>% 
#   summarise(frecuencias = sum(frecuencias)) %>% 
#   mutate(pct = round(frecuencias/sum(frecuencias)*100, 1)) %>% 
#   ggplot(aes(x = factor(empresa_agrup_def, 
#                         levels = c("Aerolíneas Argentinas",
#                                    "LATAM",
#                                    "Gol Transportes Aéreos",
#                                    "Flybondi",
#                                    "Copa Airlines",
#                                    "Sky Airline",
#                                    "American Airlines",
#                                    "Otras empresas")), y = pct)) +
#   geom_bar(aes(fill = empresa_agrup_def), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(pct, "%"), vjust = -.5)) +
#   scale_y_continuous(limits = c(0, 50),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_discrete(labels = function(empresa_agrup_def) str_wrap(empresa_agrup_def, width = 10))+
#   
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Vuelos internacionales desde Argentina según compañía aérea",
#        subtitle = "Marzo 2023",
#        y = "Distribución porcentual",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal()

```

```{r}
# internacional %>% 
#   filter(destino_pais_etiqueta != "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   mutate(empresa_agrup_def = case_when(is.na(empresa_agrup_def) ~ "Otras empresas",
#                                        T ~ as.character(empresa_agrup_def))) %>%
#   group_by(empresa_agrup_def, .drop = F) %>% 
#   summarise(pasajeros = sum(pax_ad, na.rm = T)) %>% 
#   mutate(pct = round(pasajeros/sum(pasajeros)*100, 1)) %>% 
#   arrange(-pct) %>% 
#   mutate(empresa_agrup_def = case_when(pct < 4 ~ "Otras empresas",
#                                        T ~ empresa_agrup_def)) %>% 
#   group_by(empresa_agrup_def) %>% 
#   summarise(pasajeros = sum(pasajeros, na.rm = T)) %>% 
#   mutate(pct = round(pasajeros/sum(pasajeros)*100, 1)) %>%  
#   ggplot(aes(x = factor(empresa_agrup_def, 
#                         levels = c("Aerolíneas Argentinas",
#                                    "LATAM",
#                                    "American Airlines",
#                                    "Gol Transportes Aéreos",
#                                    "Flybondi",
#                                    "Copa Airlines",
#                                    "Sky Airline",
#                                    "Iberia Airlines",
#                                    "Otras empresas")),
#              y = pct)) +
#   geom_bar(aes(fill = empresa_agrup_def), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(format(pct, decimal.mark = ","), "%"), vjust = -.5)) +
#   scale_y_continuous(limits = c(0, 50),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_discrete(labels = function(empresa_agrup_def) str_wrap(empresa_agrup_def, width = 10))+
#   
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Pasajeros internacionales transportados desde Argentina según compañía aérea",
#        subtitle = "Marzo 2023",
#        y = "Distribución porcentual",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal()
```

```{r}
# internacional %>% 
#   filter(destino_pais_etiqueta == "Argentina") %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   mutate(empresa_agrup_def = case_when(is.na(empresa_agrup_def) ~ "Otras empresas",
#                                        T ~ as.character(empresa_agrup_def))) %>%
#   group_by(empresa_agrup_def, .drop = F) %>% 
#   summarise(pasajeros = sum(pax_ad, na.rm = T)) %>% 
#   mutate(pct = round(pasajeros/sum(pasajeros)*100, 1)) %>% 
#   arrange(-pct) %>% 
#   mutate(empresa_agrup_def = case_when(pct < 4 ~ "Otras empresas",
#                                        T ~ empresa_agrup_def)) %>% 
#   group_by(empresa_agrup_def) %>% 
#   summarise(pasajeros = sum(pasajeros, na.rm = T)) %>% 
#   mutate(pct = round(pasajeros/sum(pasajeros)*100, 1)) %>%  
#   ggplot(aes(x = factor(empresa_agrup_def, 
#                         levels = c("Aerolíneas Argentinas",
#                                    "LATAM",
#                                    "Gol Transportes Aéreos",
#                                    "Flybondi",
#                                    "American Airlines",
#                                    "Copa Airlines",
#                                    "Sky Airline",
#                                    "Iberia Airlines",
#                                    "Avianca",
#                                    "Otras empresas")),
#              y = pct)) +
#   geom_bar(aes(fill = empresa_agrup_def), stat = "identity", show.legend = F) +
#   geom_text(aes(label = paste0(format(pct, decimal.mark = ","), "%"), vjust = -.5)) +
#   scale_y_continuous(limits = c(0, 50),
#                      labels = function(x) paste0(x, "%")) +
#   scale_x_discrete(labels = function(empresa_agrup_def) str_wrap(empresa_agrup_def, width = 10))+
#   
#   scale_fill_dnmye(palette = "cualitativa")+
#   labs(title = "Pasajeros internacionales transportados hacia Argentina según compañía aérea",
#        subtitle = "Marzo 2023",
#        y = "Distribución porcentual",
#        x = "",
#        fill = "",
#        caption = "Fuente: MINTUR en base a información de ANAC.") +
#   theme_minimal()
```

```{r}
int_aerolineas_freq <- internacional %>% 
  filter(destino_pais_etiqueta == "Argentina") %>% 
  filter(anio_local == max(anio_local)) %>% 
  filter(mes_local == month(max(fecha_month))) %>% 
  group_by(anio_local, mes_local, empresa_agrup_def) %>% 
  summarise(frecuencias = round(sum(vuelos, na.rm = T), 0)) %>% 
  group_by(anio_local) %>% 
  mutate(frecuencias_totales = sum(frecuencias, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(pct = round(frecuencias/frecuencias_totales*100, 1)) %>% 
  arrange(-pct) %>% 
  select(empresa_agrup_def,
         frecuencias,
         pct)

int_primer_aero <- int_aerolineas_freq[1,1] %>% pull
int_segundo_aero <- int_aerolineas_freq[2,1] %>% pull

int_freq_primer_aero <- int_aerolineas_freq[1,3] %>% pull %>% format(., decimal.mark = ",") %>% paste0(., "%")
int_freq_segundo_aero <- int_aerolineas_freq[2,3] %>% pull %>% format(., decimal.mark = ",") %>% paste0(., "%")

int_freq_abs_primer_aero <- int_aerolineas_freq[1,2] %>% pull %>% format(., big.mark = ".") 
int_freq_abs_segundo_aero <- int_aerolineas_freq[2,2] %>% pull %>% format(., big.mark = ".") 

```

Por último, **`r int_primer_aero`** se destacó como la principal aerolínea internacional del mes, realizando **`r int_freq_primer_aero` de los vuelos (`r int_freq_abs_primer_aero` frecuencias)**. A la misma, le siguió **`r int_segundo_aero`** con **`r int_freq_abs_segundo_aero` vuelos (`r int_freq_segundo_aero` del total).** 

```{r}
aerolineas_int_24 <- internacional %>% 
  filter(destino_pais_etiqueta == "Argentina") %>% 
  filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>%
  mutate(empresa_agrup_def = case_when(is.na(empresa_agrup_def) ~ "Otras empresas",
                                       T ~ as.character(empresa_agrup_def))) %>%
  group_by(empresa_agrup_def) %>% 
  summarise(frecuencias_24 = sum(vuelos, na.rm = T)) %>% 
  ungroup() %>% 
  arrange(desc(frecuencias_24)) %>% 
  mutate(posicion_24 = 1:n(),
         participacion_24 = frecuencias_24/sum(frecuencias_24))

aerolineas_int_23 <- internacional %>% 
  filter(destino_pais_etiqueta == "Argentina") %>%
  filter(anio_local == year(max(cabotaje$Fecha))-1 & mes_local == month(max(cabotaje$Fecha))) %>%
  mutate(empresa_agrup_def = case_when(is.na(empresa_agrup_def) ~ "Otras empresas",
                                       T ~ as.character(empresa_agrup_def))) %>%
  group_by(empresa_agrup_def) %>% 
  summarise(frecuencias_23 = sum(vuelos, na.rm = T)) %>% 
  arrange(-frecuencias_23) %>% 
  mutate(posicion_23 = 1:n())

aerolineas_int <- aerolineas_int_24 %>% 
  full_join(aerolineas_int_23, by = "empresa_agrup_def") %>% 
  filter(!is.na(posicion_24)) %>% 
  mutate(variacion = (frecuencias_24 - frecuencias_23)/frecuencias_23,
         empresa_agrup_def = case_when(posicion_24 >= 20 ~ "Otras empresas",
                                       T ~ empresa_agrup_def)) %>%
  group_by(empresa_agrup_def) %>% 
  summarise(frecuencias_24 = sum(frecuencias_24, na.rm = T),
            frecuencias_23 = sum(frecuencias_23, na.rm = T),
            posicion_24 = first(posicion_24),
            posicion_23 = first(posicion_23)) %>% 
  mutate(variacion = (frecuencias_24 - frecuencias_23)/frecuencias_23,
         participacion_24 = frecuencias_24/sum(frecuencias_24),
         posicion_23 = case_when(empresa_agrup_def == "Otras empresas" ~ "-",
                                 T ~ as.character(posicion_23)),
         posicion_24 = case_when(empresa_agrup_def == "Otras empresas" ~ "-",
                                 T ~ as.character(posicion_24))) %>%
  arrange(-frecuencias_24) %>%
  mutate(situacion = case_when(as.numeric(posicion_24) < as.numeric(posicion_23) ~ "▲",
                               as.numeric(posicion_24) > as.numeric(posicion_23) ~ "▼",
                               T ~ "=")) %>%
  mutate(orden = 1:n(),
         orden = if_else(empresa_agrup_def == "Otras empresas",
                         Inf,
                         as.numeric(orden))) %>% 
  arrange(orden) %>% 
  select(-orden)


col_order <- c("empresa_agrup_def",
               "posicion_24",
               "situacion",
               "posicion_23",
               "frecuencias_24",
               "frecuencias_23",
               "variacion",
               "participacion_24")

aerolineas_int <- aerolineas_int[, col_order]

aerolineas_int[sapply(aerolineas_int, is.infinite)] <- NA

# herfindah_aero_int <- (aerolineas_int %>% 
#                          mutate(across(.cols=c(2:4), ~ .*100)))[1,4] %>% pull %>% format(., decimal.mark = ",")
# 
# herfindah_aero_int_cond <- if_else((aerolineas_int %>% mutate(across(.cols=c(2:4), ~ .*100)))[1,4] < (aerolineas_int %>% mutate(across(.cols=c(2:4), ~ .*100)))[1,3],
#                               paste0("una reducción de ", (aerolineas_int %>% mutate(across(.cols=c(2:4), ~ .*100)))[1,4]-(aerolineas_int %>% mutate(across(.cols=c(2:4), ~ .*100)))[1,3]),
#                               paste0("un crecimiento de ", (aerolineas_int %>% mutate(across(.cols=c(2:4), ~ .*100)))[1,4]-(aerolineas_int %>% mutate(across(.cols=c(2:4), ~ .*100)))[1,3]))
# 
# aeros_int_21 <- n_distinct(aerolineas_int$empresa_agrup_def)
# aeros_int_20 <- n_distinct(aerolineas_int$empresa_agrup_def)

```

```{r}
aerolineas_int %>%
  gt() %>% 
  tab_header(
    title = md("__RANKING DE COMPAÑÍAS AÉREAS POR VUELOS\nINTERNACIONALES AL PAÍS__"),
    subtitle = glue::glue("{str_to_title(strftime(max(base_total$Fecha), '%B %Y'))}")) %>% 
  tab_source_note(
    source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
  cols_label(
    empresa_agrup_def = md("**Compañía Aérea**"),
    posicion_24 = md("**2024**"),
    situacion = "",
    posicion_23 = md("**2023**"),
    frecuencias_24 = md("**2024**"),
    frecuencias_23 = md("**2023**"),
    variacion = md("**v. a. %**"),
    participacion_24 = md("**Participación 2024 (%)**")) %>% 
  cols_align(
    align = "center",
    columns = c(2:8))  %>% 
  opt_table_font(
    font = list(
      google_font(name = "Encode Sans"))) %>% 
  fmt_percent(columns = c(7, 8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = cells_column_spanners(spanners = everything())
  ) %>%
  data_color(
    columns = variacion,
    apply_to = "text",
    colors = scales::col_bin(
      bins = c(-Inf, 0, Inf),
      palette = c(dnmye_colores("rosa"), dnmye_colores("azul verde")),
    )
  ) %>% 
  tab_style(
    style = list(
      cell_text(weight =  "bold")
    ),
    locations = cells_body(
      columns = c(starts_with("var_")))) %>% 
  tab_spanner(
    label = "Posición",
    columns = c(posicion_23, situacion, posicion_24)) %>% 
  tab_spanner(
    label = "Frecuencias",
    columns = c(frecuencias_23, frecuencias_24)
  )%>%
  tab_style(
    style = list(
      cell_text(color = "#EE3D8F"),
      cell_text(weight  = "bold")
    ),
    locations = cells_body(
      columns = situacion,
      rows = as.numeric(posicion_24) > as.numeric(posicion_23))
  ) %>% 
  tab_style(
    style = list(
      cell_text(color = "#50B8B1"),
      cell_text(weight =  "bold")
    ),
    locations = cells_body(
      columns = situacion,
      rows = as.numeric(posicion_24) < as.numeric(posicion_23)))%>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = cells_column_spanners(spanners = everything())) %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = cells_column_spanners(spanners = everything())
  ) %>%
  tab_style(
    style = list(
      cell_text(color = "#EE3D8F"),
      cell_text(weight  = "bold")
    ),
    locations = cells_body(
      columns = variacion,
      rows = variacion < 0)
  ) %>% 
  tab_style(
    style = list(
      cell_text(color = "#50B8B1"),
      cell_text(weight =  "bold")
    ),
    locations = cells_body(
      columns = variacion,
      rows = variacion > 0)) %>% 
  sub_missing(
    columns = everything(),
    rows = everything(),
    missing_text = "-")
```


```{r}
# socoso_inter <- internacional %>% 
#   filter(mes_local == month(max(cabotaje$Fecha))) %>% 
#   filter(origen_pais_etiqueta != "Argentina") %>%
#   group_by(anio_local, origen_pais_etiqueta) %>%
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>% 
#   group_by(anio_local) %>%
#   mutate(cuota = frecuencias/sum(frecuencias, na.rm = T)) %>%
#   ungroup() %>% 
#   select(anio_local, origen_pais_etiqueta, cuota)
# 
# socoso_inter_2 <- socoso_inter %>% 
#   group_by(anio_local) %>% 
#   summarise(herfindahl =  (sum(cuota^2, na.rm = T) - 1/n())/(1 - 1/n())) %>%
#   mutate(origen_pais_etiqueta = "Índice de Herfindahl") %>% 
#   pivot_wider(names_from = anio_local, values_from =  herfindahl, names_prefix = "cuota_")
# 
# socoso_total <- socoso_inter %>% 
#   pivot_wider(names_from = anio_local, values_from =  cuota, names_prefix = "cuota_") %>% 
#   arrange(-cuota_2017) %>% 
#   bind_rows(socoso_inter_2)
# 
# 
# socoso_total %>% 
#   drop_na(cuota_2023) %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__ÍNDICE DE HERFINDAHL Y PORCENTAJE DE LOS VUELOS INTERNACIONALES POR PAÍS DE ORIGEN__"),
#     subtitle = md("__MARZO__")) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     origen_pais_etiqueta = md("**País**"),
#     cuota_2017 = md("**2017**"),
#     cuota_2018 = md("**2018**"),
#     cuota_2019 = md("**2019**"),
#     cuota_2020 = md("**2020**"),
#     cuota_2021 = md("**2021**"),
#     cuota_2022 = md("**2022**"),
#     cuota_2023 = md("**2023**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:8))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(2:8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = dnmye_colores("gris claro"))),
#     locations = cells_body(
#       rows = origen_pais_etiqueta == "Índice de Herfindahl")) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")),
#     locations = cells_body(
#       rows = origen_pais_etiqueta == "Índice de Herfindahl")) %>% 
#   sub_missing(
#     columns = everything(),
#     rows = everything(),
#     missing_text = "-")
```

```{r}
# socoso_inter_pax <- internacional %>% 
#   filter(mes_local == month(max(internacional$Fecha))) %>% 
#   filter(origen_pais_etiqueta != "Argentina") %>%
#   group_by(anio_local, origen_pais_etiqueta) %>%
#   summarise(pasajeros = sum(pax_ad, na.rm = T)) %>% 
#   group_by(anio_local) %>%
#   mutate(cuota = pasajeros/sum(pasajeros, na.rm = T)) %>%
#   ungroup() %>% 
#   select(anio_local, origen_pais_etiqueta, cuota)
# 
# socoso_inter_pax2 <- socoso_inter_pax %>% 
#   group_by(anio_local) %>% 
#   summarise(herfindahl =  (sum(cuota^2, na.rm = T) - 1/n())/(1 - 1/n())) %>%
#   mutate(origen_pais_etiqueta = "Índice de Herfindahl") %>% 
#   pivot_wider(names_from = anio_local, values_from =  herfindahl, names_prefix = "cuota_")
# 
# socoso_total <- socoso_inter_pax %>% 
#   pivot_wider(names_from = anio_local, values_from =  cuota, names_prefix = "cuota_") %>% 
#   arrange(-cuota_2017) %>% 
#   bind_rows(socoso_inter_pax2)
# 
# 
# socoso_total %>% 
#   drop_na(cuota_2023) %>%
#   gt() %>% 
#   tab_header(
#     title = md("__ÍNDICE DE HERFINDAHL Y PARTICIPACIÓN PORCENTUAL DE PASAJEROS TRANSPORTADOS SEGÚN PAÍS DE ORIGEN__"),
#     subtitle = md("__MARZO__")) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     origen_pais_etiqueta = md("**País**"),
#     cuota_2017 = md("**2017**"),
#     cuota_2018 = md("**2018**"),
#     cuota_2019 = md("**2019**"),
#     cuota_2020 = md("**2020**"),
#     cuota_2021 = md("**2021**"),
#     cuota_2022 = md("**2022**"),
#     cuota_2023 = md("**2023**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:8))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(2:8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = dnmye_colores("gris claro"))),
#     locations = cells_body(
#       rows = origen_pais_etiqueta == "Índice de Herfindahl")) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")),
#     locations = cells_body(
#       rows = origen_pais_etiqueta == "Índice de Herfindahl")) %>% 
#   sub_missing(
#     columns = everything(),
#     rows = everything(),
#     missing_text = "-")
```


```{r}
# socoso_inter_aero <- internacional %>% 
#   filter(mes_local == month(max(internacional$Fecha)) & anio_local %in% c(year(max(internacional$Fecha)), year(max(internacional$Fecha))-1)) %>% 
#   group_by(anio_local, empresa_agrup_def) %>%
#   summarise(frecuencias = sum(vuelos, na.rm = T)) %>% 
#   group_by(anio_local) %>%
#   mutate(cuota = frecuencias/sum(frecuencias, na.rm = T)) %>%
#   ungroup() %>% 
#   select(anio_local, empresa_agrup_def, cuota) 
# 
# socoso_inter_aero2 <- socoso_inter_aero %>% 
#   group_by(anio_local) %>% 
#   summarise(herfindahl =  (sum(cuota^2, na.rm = T) - 1/n())/(1 - 1/n())) %>%
#   mutate(empresa_agrup_def = "Índice de Herfindahl") %>% 
#   pivot_wider(names_from = anio_local, values_from =  herfindahl, names_prefix = "cuota_")
# 
# socoso_total <- socoso_inter_aero %>% 
#   pivot_wider(names_from = anio_local, values_from =  cuota, names_prefix = "cuota_") %>% 
#   arrange(-cuota_2022) %>% 
#   bind_rows(socoso_inter_aero2)
# 
# socoso_total %>% 
#   drop_na(cuota_2023) %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__ÍNDICE DE HERFINDAHL Y PARTICIPACIÓN PORCENTUAL DE VUELOS SEGÚN AEROLÍNEAS__")) %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   cols_label(
#     empresa_agrup_def = md("**Ciudad**"),
#     cuota_2022 = md("**2022**"),
#     cuota_2023 = md("**2023**")) %>% 
#   cols_align(
#     align = "center",
#     columns = c(2:3))  %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans"))) %>% 
#   fmt_percent(columns = c(2:3), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = dnmye_colores("gris claro"))),
#     locations = cells_body(
#       rows = empresa_agrup_def == "Índice de Herfindahl")) %>% 
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")),
#     locations = cells_body(
#       rows = empresa_agrup_def == "Índice de Herfindahl")) %>% 
#   sub_missing(
#     columns = everything(),
#     rows = everything(),
#     missing_text = "-")
```

## ANEXO - VUELOS DE CABOTAJE

```{r}
socoso_aero1_pasajeros <- cabotaje %>% 
  filter(mes_local == month(max(cabotaje$Fecha)))  %>%
  filter(empresa_agrup_def %in% c("LATAM",
                                  "Norwegian Air Shuttle",
                                  "JetSMART Airlines",
                                  "Aerolíneas Argentinas",
                                  "Flybondi",
                                  "Andes Líneas Aéreas",
                                  "Avianca",
                                  "LADE - Líneas Aéreas Del Estado")) %>% 
  mutate(empresa_agrup_def = as.factor(empresa_agrup_def)) %>% 
  group_by(anio_local, empresa_agrup_def, .drop = F) %>%
  summarise(pasajeros = sum(pax_ad, na.rm = T)) %>%
  group_by(anio_local) %>%
  mutate(cuota = pasajeros/sum(pasajeros, na.rm = T)
  ) %>%
  ungroup() %>% 
  select(anio_local, empresa_agrup_def, cuota)

socoso_aero2_pasajeros <- socoso_aero1_pasajeros %>% 
  group_by(anio_local) %>% 
  summarise(herfindahl =  (sum(cuota^2, na.rm = T) - 1/n())/(1 - 1/n())) %>% 
  mutate(empresa_agrup_def = "Índice de Herfindahl") %>% 
  pivot_wider(names_from = anio_local, values_from =  herfindahl, names_prefix = "cuota_")

socoso_aero_total <- socoso_aero1_pasajeros %>% 
  pivot_wider(names_from = anio_local, values_from = cuota, names_prefix = "cuota_") %>% 
  bind_rows(socoso_aero2_pasajeros)

socoso_aero_total %>% 
  gt() %>% 
  tab_header(
    title = md("__CUOTA DE MERCADO DE CABOTAJE POR AEROLÍNEA__"),
    subtitle = glue::glue("Sobre el total de pasajeros - {str_to_title(strftime(max(base_total$Fecha), '%B'))}")) %>% 
  tab_source_note(
    source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
  tab_source_note(
    source_note = md("**Nota:** El índice de Herfindahl se obtiene sumando las cuotas de mercado de cada actor elevadas al cuadrado.")) %>% 
  cols_label(
    empresa_agrup_def = md("**Aerolínea**"),
    cuota_2017 = md("**2017**"),
    cuota_2018 = md("**2018**"),
    cuota_2019 = md("**2019**"),
    cuota_2020 = md("**2020**"),
    cuota_2021 = md("**2021**"),
    cuota_2022 = md("**2022**"),
    cuota_2023 = md("**2023**"),
    cuota_2024 = md("**2024**"),
    ) %>% 
  cols_align(
    align = "center",
    columns = c(2:9))  %>% 
  opt_table_font(
    font = list(
      google_font(name = "Encode Sans"))) %>% 
  fmt_percent(columns = c(2:9), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
  tab_style(
    style = list(
      cell_fill(color = dnmye_colores("gris claro"))),
    locations = cells_body(
      rows = empresa_agrup_def == "Índice de Herfindahl")) %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = cells_body(
      rows = empresa_agrup_def == "Índice de Herfindahl")) %>% 
  fmt_missing(
    columns = everything(),
    rows = everything(),
    missing_text = "-") 
```

```{r}
rutas_ranking <- cabotaje %>% 
  filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
  mutate(ruta_clasificacion = case_when(str_detect(ruta_nombre, "Ciudad de Buenos Aires|Ezeiza") ~ "Del AMBA",
                                                     T ~ "Federales")) %>%
  group_by(ruta_nombre, ruta_clasificacion) %>% 
  summarise(total = sum(vuelos, na.rm = T)) %>% 
  mutate(total = round(total, 0)) 

rutas_ranking_portenias <- rutas_ranking %>% 
  filter(ruta_clasificacion == "Del AMBA") %>% 
  arrange(-total) %>% 
  ungroup() %>% 
  top_n(10)

rutas_ranking_federales <- rutas_ranking %>% 
  filter(ruta_clasificacion == "Federales") %>% 
  arrange(-total) %>% 
  ungroup() %>% 
  top_n(10) 


portenias <- ggplot(rutas_ranking_portenias,
       aes(x = fct_reorder(ruta_nombre, total), y = total)) +
  geom_bar(stat = "identity", fill = dnmye_colores("cian"), width = 0.65) +
  geom_label(aes(label = total),
             hjust = -0.25) +
  scale_y_continuous(limits = c(0, 1250),
                     breaks = seq(0, 1250, 250))+
  scale_x_discrete(labels = function(ruta_nombre) str_wrap(ruta_nombre, width = 27))+
  labs(title = "Del AMBA",
       #subtitle = glue::glue("{str_to_title(strftime(max(base_total$Fecha), '%B %Y'))}"),
       x = "",
       y = "Vuelos")+
  theme_minimal()+
  theme(strip.text.y = element_text(size = 8))+
  coord_flip()

federales <- ggplot(rutas_ranking_federales,
       aes(x = fct_reorder(ruta_nombre, total), y = total)) +
  geom_bar(stat = "identity", fill = dnmye_colores("cian"), width = 0.65) +
  geom_label(aes(label = total),
             hjust = -0.25) +
  scale_y_continuous(limits = c(0, 1000),
                     breaks = seq(0, 1000, 250))+
  scale_x_discrete(labels = function(ruta_nombre) str_wrap(ruta_nombre, width = 27))+
  labs(title = "Federales",
       #subtitle = glue::glue("{str_to_title(strftime(max(base_total$Fecha), '%B %Y'))}"),
       x = "",
       y = "Vuelos")+
  theme_minimal()+
  theme(strip.text.y = element_text(size = 8))+
  coord_flip()

titulo <- ggplot()+
  labs(title = "Top 10: Rutas aéreas por cantidad de vuelos",
       subtitle = glue::glue("{str_to_title(strftime(max(base_total$Fecha), '%B %Y'))}"))+
  theme(plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 15))

cuadro <- cowplot::plot_grid(portenias, federales, label_size = 12)

cowplot::plot_grid(titulo, cuadro, ncol = 1, rel_heights = c(0.1, 0.75))

```

```{r}
# aeropuertos <- read_file_srv("/srv/DataDNMYE/aerocomercial/libros_de_codigos/ANAC/aeropuertos_nuevos.xlsx", col_types = "text") %>% 
#   mutate(across(c(latitud, longitud), as.numeric),
#          etiqueta_input = case_when(
#            pais_etiqueta_indec == "Argentina" ~ paste0(provincia, " - ", localidad_etiqueta_indec),
#            TRUE ~ paste0(pais_etiqueta_indec, " - ", localidad_etiqueta_indec))) %>% 
#   select(codigo_oaci, aeropuerto_etiqueta_anac, localidad_etiqueta_indec, etiqueta_input, latitud, longitud)
# 
# base_actual_rutas <- cabotaje %>% 
#   filter(anio_local == year(max(cabotaje$Fecha)) & mes_local == month(max(cabotaje$Fecha))) %>% 
#   group_by(anio_local, empresa_agrup_def, origen_oaci, destino_oaci) %>% 
#   summarise(total = n()) %>% 
#   drop_na() %>% 
#   filter(total >= 4)
# 
# base_actual_rutas <- base_actual_rutas %>% 
#   left_join(aeropuertos, by = c("origen_oaci"="codigo_oaci")) %>% 
#   rename(latitud_orig = latitud, longitud_orig = longitud) %>% 
#   left_join(aeropuertos, by = c("destino_oaci"="codigo_oaci")) %>% 
#   rename(latitud_dest = latitud, longitud_dest = longitud)
# 
# # Para customizar lineas
# div1 <- base_actual_rutas %>% 
#   st_as_sf(coords = c("longitud_orig", "latitud_orig"), crs = 4326)
# 
# div2 <- base_actual_rutas %>% 
#   st_as_sf(coords = c("longitud_dest", "latitud_dest"), crs = 4326)
# 
# data_conexiones <- cbind(div1, div2)
# 
# coords = cbind(st_coordinates(data_conexiones$geometry), st_coordinates(data_conexiones$geometry.1))
# 
# data_conexiones$linestrings = st_sfc(
#   lapply(1:nrow(coords),
#          function(i){
#            st_linestring(matrix(coords[i,],ncol=2,byrow=TRUE))
#          }))
# 
# data_conexiones_tabla <- data_conexiones %>% 
#   st_set_geometry(NULL) %>% 
#   st_as_sf(crs = 4326)
# 
# aeros_filtro <- aeropuertos %>% 
#   filter(codigo_oaci %in% data_conexiones_tabla$origen_oaci |
#            codigo_oaci %in% data_conexiones_tabla$destino_oaci)
# 
# data_conec <- data_conexiones_tabla %>% 
#   left_join(aeros_filtro, by = c("origen_oaci" = "codigo_oaci")) %>% 
#   left_join(aeros_filtro, by = c("destino_oaci" = "codigo_oaci"))
# 
# data_conexiones_ruta <- data_conexiones %>% 
#   mutate(ruta = paste0(origen_oaci, "-" ,destino_oaci)) %>% 
#   select(anio_local, empresa_agrup_def, ruta, linestrings) %>% 
#   st_set_geometry(NULL) %>% 
#   st_as_sf(crs = 4326)
# 
# aeropuertos <- read_file_srv("/srv/DataDNMYE/aerocomercial/libros_de_codigos/ANAC/aeropuertos_nuevos.xlsx", col_types = "text") %>% 
#   select(codigo_oaci, localidad_etiqueta_indec)
# 
# data_conexiones_ruta_fil <- data_conexiones_ruta %>% 
#   filter(!str_detect(ruta, "SABE|SAEZ")) %>% 
#   mutate(origen = str_sub(ruta, 1, 4),
#          destino = str_sub(ruta, -4, -1)) %>% 
#   left_join(aeropuertos, by = c("origen" = "codigo_oaci")) %>% 
#   left_join(aeropuertos, by = c("destino" = "codigo_oaci")) %>% 
#   filter(anio_local == year(max(cabotaje$Fecha))) %>% 
#   select(empresa_agrup_def, localidad_etiqueta_indec.x, localidad_etiqueta_indec.y) %>% 
#   mutate(ruta = paste0(localidad_etiqueta_indec.x, " - ", localidad_etiqueta_indec.y)) %>% 
#   select(empresa_agrup_def, ruta) %>%
#   filter(!ruta  %in% c("El Calafate - Ushuaia", "Ushuaia - El Calafate")) %>% 
#   st_set_geometry(NULL) %>% 
#   group_by(empresa_agrup_def) %>% 
#   summarise(cantidad_rutas = n()/2) %>% 
#   arrange(-cantidad_rutas)

# data_conexiones_ruta_fil %>% 
#   gt() %>% 
#   tab_header(
#     title = md("__RUTAS AÉREAS DEL INTERIOR__"),
#     subtitle = "Marzo 2023") %>% 
#   tab_source_note(
#     source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
#   tab_source_note(
#     source_note = md("Comprende rutas aéreas que no conenctan con el AMBA")) %>% 
#   cols_label(
#     empresa_agrup_def = md("**Aerolínea**"),
#     cantidad_rutas = md("**TOTAL**")) %>% 
#   opt_table_font(
#     font = list(
#       google_font(name = "Encode Sans")))
```

```{r}
# library(geoAr)
# 
# arg_geo <- get_geo(geo = "ARGENTINA",
#                    level = "provincia")
# 
# ggplot()+
#   geom_sf(data = arg_geo, fill = "grey96") +
#   geom_sf(data = data_conexiones_ruta,
#           aes(color = empresa_agrup_def), size = 1.25) +
#   geom_sf(data = div1,
#           aes(color = empresa_agrup_def), size = 2) +
#   scale_color_manual(values = c("Aerolíneas Argentinas" = "steelblue2",
#                                 "JetSMART Airlines" = "midnightblue",
#                                 "Flybondi" = "gold1",
#                                 "LADE - Líneas Aéreas Del Estado" = "purple1"))+
#   labs(title = "Rutas Aéreas",
#        subtitle = "Marzo 2023",
#        color = "") +
#   theme_void() +
#   facet_wrap(~ empresa_agrup_def, nrow = 1) +
#   theme(legend.position = "none",
#         plot.title = element_text(hjust = 0.5),
#         plot.subtitle = element_text(hjust = 0.5))
```

```{r}
valores_vacios <- data.table::data.table(anio_local = 2020,
                             mes_local = 4:8,
                             total_rutas = 0)

rutas_federales <- cabotaje %>%
  filter(!str_detect(ruta_nombre, "Ezeiza|El Palomar|Ciudad de Buenos Aires")) %>%
  group_by(anio_local, mes_local, ruta_nombre) %>% 
  summarise(total_vuelos = sum(vuelos, na.rm = T)) %>% 
  filter(total_vuelos >= 4) %>% 
  group_by(anio_local, mes_local, .drop = F) %>%
  summarise(total_rutas = n_distinct(ruta_nombre)) %>% 
  bind_rows(valores_vacios) %>% 
  mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>% 
 ggplot(aes(x = fecha,
             y = total_rutas,
             text = paste("Fecha:",
                          format(fecha,"%b-%y"),
                          "<br> Total:",
                          format(total_rutas,
                                                           big.mark=".", decimal.mark = ",", digits=0)))) +
  geom_segment(aes(xend = fecha,
                   y = 0,
                   yend = total_rutas),
               color = dnmye_colores("cian"))+
  geom_point(color = dnmye_colores("cian"),
             size = 1.25,
             fill = alpha(dnmye_colores("cian"), 0.3),
             alpha = 0.7,
             shape = 21,
             stroke = 2) + 
  geom_point(data = cabotaje %>%
               filter(!str_detect(ruta_nombre, "Ezeiza|El Palomar|Ciudad de Buenos Aires")) %>%
               group_by(anio_local, mes_local, ruta_nombre) %>% 
               summarise(total_vuelos = sum(vuelos, na.rm = T)) %>% 
               filter(total_vuelos >= 4) %>% 
               group_by(anio_local, mes_local, .drop = F) %>%
               summarise(total_rutas = n_distinct(ruta_nombre)) %>% 
               bind_rows(valores_vacios) %>% 
               mutate(fecha = lubridate::my(paste0(mes_local,"-", anio_local))) %>%
               filter(mes_local == month(max(cabotaje$Fecha))),
             color = dnmye_colores("rosa"),
             size = 1,
             fill = alpha(dnmye_colores("rosa"), 0.3),
             alpha = 0.7,
             shape = 21,
             stroke = 1.5) + 
  scale_y_continuous(limits = c(0, 75),
                     breaks = seq(0, 75, 15))+
  scale_x_date(date_breaks = "4 month", 
               date_labels = "%b-%y")+
  scale_fill_dnmye(palette = "cualitativa", reverse = -1)+
  labs(title = "Cantidad de rutas aéreas federales",
       subtitle = "Con al menos 4 frecuencias mensuales",
       y = "",
       x = "",
       color = "",
       caption = "Fuente: MINTURDEP en base a información de ANAC.\n Comprende rutas aéreas que no conenctan con el AMBA.\n Nota: En rojo, los meses de abril,") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1))

ggplotly(rutas_federales, tooltip = "text") %>%
  layout(legend = list(orientation = 'h',
                       x = 0.4, y = -0.2))
```

```{r}
pasajeros_totales_cabotaje <- cabotaje %>% 
  select(anio_local, mes_local, origen_oaci, destino_oaci, pax_ad) %>%
  pivot_longer(cols = c(origen_oaci, destino_oaci),
               names_to = "variable",
               values_to = "oaci") %>%
  filter(oaci != "EGYP") %>% 
  group_by(anio_local, mes_local, oaci) %>% 
  summarise(pasajeros = sum(pax_ad, na.rm = T)) %>% 
  mutate(pasajeros = round(pasajeros))

pasajeros_totales_cabotaje_mes <- pasajeros_totales_cabotaje %>% 
  ungroup() %>% 
  filter(anio_local == max(anio_local)) %>% 
  filter(mes_local == max(mes_local)) %>% 
  rename(pasajeros_mes_actual = pasajeros) %>% 
  ungroup() %>% 
  select(oaci,
         pasajeros_mes_actual)

pasajeros_totales_cabotaje_mes_previo <- pasajeros_totales_cabotaje %>% 
  ungroup() %>% 
  filter(anio_local == max(anio_local)) %>% 
  filter(mes_local == max(mes_local) - 1) %>% 
  rename(pasajeros_mes_previo = pasajeros) %>% 
  ungroup() %>% 
  select(oaci,
         pasajeros_mes_previo)

pasajeros_totales_cabotaje_mes_anio_previo <- pasajeros_totales_cabotaje %>% 
  ungroup() %>% 
  filter(anio_local == max(anio_local) - 1) %>% 
  filter(mes_local == month(max(base_total$Fecha))) %>%
  rename(pasajeros_mes_anio_previo = pasajeros) %>% 
  ungroup() %>% 
  select(oaci,
         pasajeros_mes_anio_previo)

pasajeros_totales_cabotaje_mes_2019 <- pasajeros_totales_cabotaje %>% 
  ungroup() %>% 
  filter(anio_local == 2019) %>% 
  filter(mes_local == month(max(base_total$Fecha))) %>%
  rename(pasajeros_mes_2019 = pasajeros) %>% 
  ungroup() %>% 
  select(oaci,
         pasajeros_mes_2019)
  
pasajeros_totales_cabotaje_mes <- pasajeros_totales_cabotaje_mes %>% 
  full_join(pasajeros_totales_cabotaje_mes_2019, by = "oaci") %>% 
  full_join(pasajeros_totales_cabotaje_mes_previo, by = "oaci") %>% 
  full_join(pasajeros_totales_cabotaje_mes_anio_previo, by = "oaci") %>% 
  mutate(across(.cols = everything(.),
                ~ replace_na(., 0)),
         variacion_mes = (pasajeros_mes_actual/pasajeros_mes_previo) - 1,
         variacion_mes = if_else(!is.finite(variacion_mes),
                                 0,
                                 variacion_mes),
         variacion_anual = (pasajeros_mes_actual/pasajeros_mes_anio_previo) - 1,
         variacion_anual = if_else(!is.finite(variacion_anual),
                                   0,
                                   variacion_anual))

pasajeros_totales_cabotaje_acumulado <- pasajeros_totales_cabotaje %>% 
  ungroup() %>% 
  filter(mes_local <= month(max(base_total$Fecha))) %>% 
  group_by(anio_local, oaci) %>% 
  summarise(pasajeros_acumulados = sum(pasajeros, na.rm = T)) %>% 
  mutate(anio_local = paste0("anio_", anio_local)) %>% 
  pivot_wider(names_from = anio_local,
              values_from = pasajeros_acumulados)
  
aeropuertos <- read_file_srv("aerocomercial/libros_de_codigos/ANAC/aeropuertos_nuevos.xlsx", col_types = "text") %>% 
  mutate(aeropuerto_etiqueta_anac = case_when(is.na(aeropuerto_etiqueta_anac) ~ nombre_ingles,
                                              T ~ aeropuerto_etiqueta_anac),
         localidad_etiqueta_indec = case_when(is.na(localidad_etiqueta_indec) ~ localidad_ingles,
                                              T ~ localidad_etiqueta_indec)) %>% 
  select(codigo_oaci,
         aeropuerto = aeropuerto_etiqueta_anac,
         localidad = localidad_etiqueta_indec,
         provincia)

tabla <- pasajeros_totales_cabotaje_acumulado %>% 
  left_join(pasajeros_totales_cabotaje_mes, by = "oaci") %>% 
  left_join(aeropuertos, by = c("oaci" = "codigo_oaci")) %>% 
  arrange(-anio_2024) %>% 
  mutate(ranking = row_number(),
         localidad = case_when(ranking >= 40 ~ "Resto",
                               T ~ localidad)) %>% 
  group_by(localidad) %>% 
  summarise(anio_2017 = sum(anio_2017, na.rm = T),
            anio_2018 = sum(anio_2018, na.rm = T),
            anio_2019 = sum(anio_2019, na.rm = T),
            anio_2020 = sum(anio_2020, na.rm = T),
            anio_2021 = sum(anio_2021, na.rm = T),
            anio_2022 = sum(anio_2022, na.rm = T),
            anio_2023 = sum(anio_2023, na.rm = T),
            anio_2024 = sum(anio_2024, na.rm = T),
            pasajeros_mes_actual = sum(pasajeros_mes_actual, na.rm = T),
            pasajeros_mes_2019 = sum(pasajeros_mes_2019, na.rm = T),
            pasajeros_mes_previo = sum(pasajeros_mes_previo, na.rm = T),
            pasajeros_mes_anio_previo = sum(pasajeros_mes_anio_previo, na.rm = T)) %>%
    janitor::adorn_totals(where = "row",
                        na.rm = T) %>% 
    mutate(across(.cols = 2:13,
                ~ replace_na(., 0)),
         variacion_mes = (pasajeros_mes_actual/pasajeros_mes_previo) - 1,
         variacion_mes = if_else(!is.finite(variacion_mes),
                                 0,
                                 variacion_mes),
         variacion_anual = (pasajeros_mes_actual/pasajeros_mes_anio_previo) - 1,
         variacion_anual = if_else(!is.finite(variacion_anual),
                                   0,
                                   variacion_anual)) %>%
    arrange(-anio_2024)  

tabla_grande <- tabla %>% 
  select(-ends_with("_previo")) %>% 
  gt() %>% 
  tab_header(
    title = md("__PASAJEROS TOTALES EN VUELOS DE CABOTAJE POR AEROPUERTO__")) %>%  
  tab_source_note(
    source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
  cols_label(
    localidad = md("**Aeropuerto**"),
    anio_2017 = md("2017"),
    anio_2018 = md("2018"),
    anio_2019 = md("2019"),
    anio_2020 = md("2020"),
    anio_2021 = md("2021"),
    anio_2022 = md("2022"),
    anio_2023 = md("2023"),
    anio_2024 = md("2024"),
    pasajeros_mes_2019 = md("2019"),
    pasajeros_mes_actual = md("2024"),
    variacion_mes = md("Mensual"),
    variacion_anual = md("Anual")) %>% 
  cols_align(
    align = "center",
    columns = c(2:13))  %>% 
  opt_table_font(
    font = list(
      google_font(name = "Encode Sans"))) %>% 
  fmt_percent(columns = c(9:13), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
  fmt_missing(
    columns = everything(),
    rows = everything(),
    missing_text = "-") %>%
  data_color(
    columns = contains("variacion"),
    apply_to = "text",
    colors = scales::col_bin(
      bins = c(-Inf, 0, Inf),
      palette = c(dnmye_colores("rosa"), dnmye_colores("azul verde")),
    )
  ) %>% 
  tab_spanner(
    label = "Variación",
    columns = c(variacion_mes, variacion_anual)) %>% 
  tab_spanner(
    label = glue::glue("Pasajeros {str_to_title(strftime(max(base_total$Fecha), '%B'))}"),
    columns = c(pasajeros_mes_actual,
                pasajeros_mes_2019)) %>% 
  tab_spanner(
    label = glue::glue("Acumulado Período {str_to_title(month(1, , label = T, abbr = T))}","-","{str_to_title(month(max(base_total$Fecha), label = T, abbr = T))}"),
    columns = starts_with("anio")) %>% 
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_column_spanners()) %>%
  comunicacion::gt_theme_dnmye(var_total = localidad) %>% 
  fmt_number(columns = c(starts_with("anio"),
                         starts_with("pasajeros")), 
             sep_mark = ".", 
             decimals = 0)

# gtsave(tabla,
#        "tabla_aeropuertos.png", vwidth = 2000)

tabla %>% 
  select(-ends_with("_previo")) %>% 
  select(-c(anio_2017, anio_2018, anio_2020, anio_2021, anio_2022)) %>% 
  gt() %>% 
  tab_header(
    title = md("__PASAJEROS TOTALES EN VUELOS DE CABOTAJE POR AEROPUERTO__")) %>%  
  tab_source_note(
    source_note = md("**Fuente:** MINTURDEP en base a información de ANAC.")) %>% 
  cols_label(
    localidad = md("**Aeropuerto**"),
    anio_2024 = md("2024"),
    anio_2023 = md("2023"),
    anio_2019 = md("2019"),
    pasajeros_mes_2019 = md("2019"),
    pasajeros_mes_actual = md("2024"),
    variacion_mes = md("Mensual"),
    variacion_anual = md("Anual")) %>% 
  cols_align(
    align = "center",
    columns = c(2:8))  %>% 
  opt_table_font(
    font = list(
      google_font(name = "Encode Sans"))) %>% 
  fmt_percent(columns = c(7:8), decimals = 1, dec_mark = ",", sep_mark = ".") %>% 
  fmt_missing(
    columns = everything(),
    rows = everything(),
    missing_text = "-") %>%
  data_color(
    columns = contains("variacion"),
    apply_to = "text",
    colors = scales::col_bin(
      bins = c(-Inf, 0, Inf),
      palette = c(dnmye_colores("rosa"), dnmye_colores("azul verde")),
    )
  ) %>% 
  tab_spanner(
    label = "Variación",
    columns = c(variacion_mes, variacion_anual)) %>% 
  tab_spanner(
    label = glue::glue("Pasajeros {str_to_title(strftime(max(base_total$Fecha), '%B'))}"),
    columns = c(pasajeros_mes_actual,
                pasajeros_mes_2019)) %>% 
  tab_spanner(
    label = glue::glue("Acumulado Período {str_to_title(month(1, , label = T, abbr = T))}","-","{str_to_title(month(max(base_total$Fecha), label = T, abbr = T))}"),
    columns = starts_with("anio")) %>% 
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_column_spanners()) %>%
  comunicacion::gt_theme_dnmye(var_total = localidad) %>% 
  fmt_number(columns = c(starts_with("anio"),
                         starts_with("pasajeros")), 
             sep_mark = ".", 
             decimals = 0)

```

